<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamMaster Pro | Online Test Platformasƒ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --secondary: #ec4899;
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.6);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.15), transparent 25%);
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .w-full { width: 100%; }
        .mb-2 { margin-bottom: 10px; }
        .mt-4 { margin-top: 20px; }

        /* --- GLASSMORPHISM CARD --- */
        .glass-panel {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: var(--glass-border);
            border-radius: var(--radius);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        /* --- LAYOUT --- */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 30px;
            border: var(--glass-border);
        }

        .avatar {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px;
        }

        /* --- FORMS & INPUTS --- */
        .input-group { margin-bottom: 15px; position: relative; }
        
        label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-muted); }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px var(--primary-glow); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--primary-glow); }
        
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); }

        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.5); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }

        /* --- SCREENS --- */
        .screen {
            animation: fadeIn 0.4s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- AUTH SCREEN --- */
        .auth-container { max-width: 400px; margin: 5vh auto; text-align: center; padding: 40px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 12px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; }
        .tab-btn.active { background: var(--bg-card); color: white; shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- DASHBOARD --- */
        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stat-card { padding: 20px; text-align: center; }
        .stat-val { font-size: 2.5rem; font-weight: 800; margin: 10px 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- TEST LIST --- */
        .test-card {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }
        .test-card::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--primary); }
        .badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); }

        /* --- EXAM UI --- */
        .timer-float {
            position: fixed; top: 20px; right: 20px;
            background: var(--bg-dark); border: 1px solid var(--primary);
            padding: 10px 20px; border-radius: 50px;
            font-family: monospace; font-size: 1.2rem;
            z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .question-box { padding: 30px; margin-bottom: 20px; }
        .option-item {
            display: flex; align-items: center;
            padding: 15px; margin-bottom: 10px;
            border-radius: 10px; background: rgba(255,255,255,0.03);
            cursor: pointer; transition: var(--transition);
            border: 1px solid transparent;
        }
        .option-item:hover { background: rgba(255,255,255,0.08); }
        .option-item.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        
        /* Result colors */
        .option-item.correct { border-color: var(--success); background: rgba(16, 185, 129, 0.15); }
        .option-item.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.15); }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: var(--bg-card); color: white; padding: 15px 25px;
            margin-top: 10px; border-radius: 8px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
            display: flex; align-items: center; gap: 10px;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- JSON EDITOR --- */
        #json-editor {
            font-family: 'Courier New', monospace;
            min-height: 200px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* --- CONFETTI --- */
        canvas#confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        /* --- ADMIN TABLES --- */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { text-align: left; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-table th { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; }

    </style>
</head>
<body>

    <div id="toast-container"></div>
    <canvas id="confetti"></canvas>

    <div class="app-container">
        
        <nav id="navbar" class="navbar glass-panel hidden">
            <div class="logo" onclick="Router.go('dashboard')">ExamMaster Pro</div>
            <div class="user-pill">
                <div class="avatar" id="nav-avatar">U</div>
                <span id="nav-username">User</span>
                <button class="btn btn-sm btn-danger" onclick="Auth.logout()" style="margin-left: 10px; padding: 5px 10px;">√áƒ±xƒ±≈ü</button>
            </div>
        </nav>

        <div id="screen-auth" class="screen">
            <div class="auth-container glass-panel">
                <h1 style="margin-bottom: 20px;">Xo≈ü g…ôlmisiniz</h1>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="Auth.switchTab('login')">Giri≈ü</button>
                    <button class="tab-btn" onclick="Auth.switchTab('register')">Qeydiyyat</button>
                </div>

                <div id="form-login">
                    <div class="input-group">
                        <input type="text" id="login-user" placeholder="ƒ∞stifad…ô√ßi adƒ±">
                    </div>
                    <div class="input-group">
                        <input type="password" id="login-pass" placeholder="≈ûifr…ô">
                    </div>
                    <button class="btn btn-primary w-full" onclick="Auth.login()">Daxil Ol</button>
                    <p style="margin-top: 15px; font-size: 0.8rem; opacity: 0.6;">Admin: cesi / cesi123</p>
                </div>

                <div id="form-register" class="hidden">
                    <div class="input-group">
                        <input type="text" id="reg-name" placeholder="Ad v…ô Soyad">
                    </div>
                    <div class="input-group">
                        <input type="text" id="reg-user" placeholder="ƒ∞stifad…ô√ßi adƒ±">
                    </div>
                    <div class="input-group">
                        <input type="password" id="reg-pass" placeholder="≈ûifr…ô">
                    </div>
                    <button class="btn btn-primary w-full" onclick="Auth.register()">Qeydiyyatdan Ke√ß</button>
                </div>
            </div>
        </div>

        <div id="screen-dashboard" class="screen hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Panelim</h2>
                <button class="btn btn-primary" onclick="Router.go('create-test')">+ Yeni Test Yarat</button>
            </div>

            <div class="grid-dashboard">
                <div class="stat-card glass-panel">
                    <div class="stat-val" id="dash-total-tests">0</div>
                    <div>Yaratdƒ±ƒüƒ±m Testl…ôr</div>
                </div>
                <div class="stat-card glass-panel">
                    <div class="stat-val" id="dash-taken-tests">0</div>
                    <div>Ke√ßdiyim ƒ∞mtahanlar</div>
                </div>
                <div class="stat-card glass-panel">
                    <div class="stat-val" id="dash-avg-score">0%</div>
                    <div>Ortalama N…ôtic…ô</div>
                </div>
            </div>

            <h3 class="mt-4 mb-2">Aktiv Testl…ôrim</h3>
            <div id="my-tests-list" style="display: grid; gap: 15px;"></div>
        </div>

        <div id="screen-admin" class="screen hidden">
            <h2>üõ°Ô∏è Admin ƒ∞dar…ôetm…ô Paneli</h2>
            
            <div class="grid-dashboard mt-4">
                <div class="stat-card glass-panel">
                    <div class="stat-val" id="admin-user-count">0</div>
                    <div>ƒ∞stifad…ô√ßil…ôr</div>
                </div>
                <div class="stat-card glass-panel">
                    <div class="stat-val" id="admin-test-count">0</div>
                    <div>Testl…ôr</div>
                </div>
            </div>

            <div class="glass-panel mt-4" style="padding: 20px;">
                <h3>ƒ∞stifad…ô√ßil…ôr</h3>
                <table class="admin-table">
                    <thead><tr><th>Ad</th><th>Login</th><th>Rol</th><th>∆èm…ôliyyat</th></tr></thead>
                    <tbody id="admin-users-table"></tbody>
                </table>
            </div>

            <div class="glass-panel mt-4" style="padding: 20px;">
                <h3>B√ºt√ºn Testl…ôr</h3>
                <table class="admin-table">
                    <thead><tr><th>Ba≈ülƒ±q</th><th>M√º…ôllif</th><th>Kod</th><th>∆èm…ôliyyat</th></tr></thead>
                    <tbody id="admin-tests-table"></tbody>
                </table>
            </div>
        </div>

        <div id="screen-create-test" class="screen hidden">
            <div class="glass-panel" style="padding: 30px; max-width: 800px; margin: 0 auto;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <h2>Yeni Test Yarat</h2>
                    <button class="btn btn-secondary btn-sm" onclick="Router.go('dashboard')">L…ôƒüv et</button>
                </div>

                <div class="grid-dashboard" style="grid-template-columns: 1fr 1fr; margin-bottom: 20px;">
                    <div class="input-group">
                        <label>Testin Adƒ±</label>
                        <input type="text" id="create-title" placeholder="M…ôs: Riyaziyyat Sƒ±naq 1">
                    </div>
                    <div class="input-group">
                        <label>M√ºdd…ôt (d…ôqiq…ô)</label>
                        <input type="number" id="create-timer" value="10">
                    </div>
                </div>

                <div class="input-group">
                    <label>Suallar (JSON Formatƒ±)</label>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">
                        Format: <code>[{"q": "Sual?", "o": ["A", "B", "C"], "a": 0}]</code> (a: d√ºzg√ºn cavab indexi 0-dan ba≈ülayƒ±r)
                    </p>
                    <textarea id="json-editor">
[
    {
        "q": "Az…ôrbaycanƒ±n paytaxtƒ± haradƒ±r?",
        "o": ["G…ônc…ô", "Bakƒ±", "Sumqayƒ±t", "L…ônk…ôran"],
        "a": 1
    },
    {
        "q": "2 + 2 ne√ß…ô edir?",
        "o": ["3", "4", "5"],
        "a": 1
    }
]</textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="TestManager.formatJSON()">üßπ Formatla</button>
                    <button class="btn btn-primary" onclick="TestManager.saveTest()">üíæ Yadda Saxla v…ô Yayƒ±mla</button>
                </div>
            </div>
        </div>

        <div id="screen-exam" class="screen hidden">
            <div id="exam-timer" class="timer-float">10:00</div>
            
            <div style="max-width: 800px; margin: 0 auto;">
                <div class="glass-panel question-box">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; color: var(--text-muted);">
                        <span id="exam-progress-text">Sual 1 / 10</span>
                        <span id="exam-title">Riyaziyyat</span>
                    </div>
                    
                    <h3 id="exam-question-text" style="font-size: 1.3rem; margin-bottom: 25px;">Sual m…ôtni...</h3>
                    
                    <div id="exam-options"></div>
                </div>

                <div style="display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="ExamEngine.prevQuestion()">‚¨Ö Geri</button>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-warning" onclick="ExamEngine.flagQuestion()">üö© ƒ∞≈üar…ôl…ô</button>
                        <button class="btn btn-primary" onclick="ExamEngine.nextQuestion()" id="btn-next">N√∂vb…ôti ‚û°</button>
                    </div>
                </div>
                
                <div id="exam-palette" style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 20px; justify-content: center;"></div>
            </div>
        </div>

        <div id="screen-result" class="screen hidden">
            <div class="glass-panel" style="text-align: center; padding: 40px; max-width: 600px; margin: 0 auto;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üèÜ</div>
                <h2>ƒ∞mtahan Bitdi!</h2>
                <h1 id="res-score" style="font-size: 4rem; color: var(--success); margin: 10px 0;">90%</h1>
                <p id="res-msg">∆èla n…ôtic…ôdir!</p>

                <div class="grid-dashboard" style="margin-top: 30px;">
                    <div>
                        <div style="color: var(--success); font-weight: bold; font-size: 1.5rem;" id="res-correct">0</div>
                        <div style="font-size: 0.9rem;">D√ºzg√ºn</div>
                    </div>
                    <div>
                        <div style="color: var(--danger); font-weight: bold; font-size: 1.5rem;" id="res-wrong">0</div>
                        <div style="font-size: 0.9rem;">S…ôhv</div>
                    </div>
                    <div>
                        <div style="color: var(--warning); font-weight: bold; font-size: 1.5rem;" id="res-empty">0</div>
                        <div style="font-size: 0.9rem;">Bo≈ü</div>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-secondary" onclick="Router.go('dashboard')">üè† Ana S…ôhif…ô</button>
                    <button class="btn btn-primary" onclick="ExamEngine.reviewAnswers()">üëÅÔ∏è Cavablara Bax</button>
                </div>
            </div>
        </div>

    </div>

<script>
    /**
     * EXAM MASTER PRO - CORE LOGIC
     * B√ºt√ºn m…ôntiq burada: DB, Auth, Routing, Exam Engine.
     */

    // --- UTILS & STORAGE ---
    const DB = {
        get: (key) => JSON.parse(localStorage.getItem(`emp_${key}`) || '[]'),
        set: (key, val) => localStorage.setItem(`emp_${key}`, JSON.stringify(val)),
        generateID: () => Math.random().toString(36).substr(2, 9),
        
        // Initial Seed
        init: () => {
            if (!localStorage.getItem('emp_users')) {
                DB.set('users', []); // Admin hardcoded in code
                DB.set('tests', []);
                DB.set('results', []);
            }
        }
    };

    const Toast = (msg, type = 'success') => {
        const div = document.createElement('div');
        div.className = 'toast';
        div.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--success)';
        div.innerHTML = `<span>${type === 'error' ? '‚ùå' : '‚úÖ'}</span> ${msg}`;
        document.getElementById('toast-container').appendChild(div);
        setTimeout(() => div.remove(), 3000);
    };

    // --- AUTHENTICATION ---
    const Auth = {
        user: null, // {id, username, role}

        init: () => {
            const savedUser = JSON.parse(localStorage.getItem('emp_session'));
            if (savedUser) {
                Auth.user = savedUser;
                Auth.updateUI();
            }
        },

        switchTab: (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'login') {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-register').classList.add('hidden');
            } else {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-register').classList.remove('hidden');
            }
        },

        login: () => {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();

            // Admin Check
            if (u === 'cesi' && p === 'cesi123') {
                Auth.setSession({ id: 'admin', username: 'Admin', role: 'admin' });
                return;
            }

            // User Check
            const users = DB.get('users');
            const found = users.find(user => user.username === u && user.password === p);

            if (found) {
                Auth.setSession({ id: found.id, username: found.username, role: 'user' });
            } else {
                Toast('ƒ∞stifad…ô√ßi adƒ± v…ô ya ≈üifr…ô s…ôhvdir', 'error');
            }
        },

        register: () => {
            const name = document.getElementById('reg-name').value.trim();
            const user = document.getElementById('reg-user').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();

            if (!name || !user || !pass) return Toast('B√ºt√ºn sah…ôl…ôri doldurun', 'error');

            const users = DB.get('users');
            if (users.find(u => u.username === user)) return Toast('Bu istifad…ô√ßi adƒ± artƒ±q tutulub', 'error');

            const newUser = { id: DB.generateID(), name, username: user, password: pass, role: 'user', joined: new Date() };
            users.push(newUser);
            DB.set('users', users);
            
            Toast('Qeydiyyat uƒüurludur! ƒ∞ndi giri≈ü edin.');
            Auth.switchTab('login');
        },

        setSession: (userObj) => {
            Auth.user = userObj;
            localStorage.setItem('emp_session', JSON.stringify(userObj));
            Toast(`Xo≈ü g…ôldin, ${userObj.username}`);
            Auth.updateUI();
            Router.go(userObj.role === 'admin' ? 'admin' : 'dashboard');
        },

        logout: () => {
            localStorage.removeItem('emp_session');
            Auth.user = null;
            location.hash = '';
            location.reload();
        },

        updateUI: () => {
            if (Auth.user) {
                document.getElementById('navbar').classList.remove('hidden');
                document.getElementById('nav-username').innerText = Auth.user.username;
                document.getElementById('nav-avatar').innerText = Auth.user.username[0].toUpperCase();
            }
        }
    };

    // --- ROUTER ---
    const Router = {
        go: (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(`screen-${screenId}`).classList.remove('hidden');
            
            // Logic triggers based on screen
            if (screenId === 'dashboard') Dashboard.load();
            if (screenId === 'admin') Admin.load();
        },

        checkHash: () => {
            const hash = window.location.hash;
            if (hash.startsWith('#test/')) {
                const testId = hash.split('/')[1];
                ExamEngine.startGuest(testId);
            } else if (Auth.user) {
                Router.go(Auth.user.role === 'admin' ? 'admin' : 'dashboard');
            } else {
                Router.go('auth');
            }
        }
    };

    // --- DASHBOARD ---
    const Dashboard = {
        load: () => {
            const tests = DB.get('tests').filter(t => t.authorId === Auth.user.id);
            const results = DB.get('results').filter(r => r.userId === Auth.user.id);
            
            // Stats
            document.getElementById('dash-total-tests').innerText = tests.length;
            document.getElementById('dash-taken-tests').innerText = results.length;
            
            let avg = 0;
            if(results.length > 0) {
                const totalScore = results.reduce((acc, r) => acc + r.score, 0);
                avg = Math.round(totalScore / results.length);
            }
            document.getElementById('dash-avg-score').innerText = avg + '%';

            // List
            const list = document.getElementById('my-tests-list');
            list.innerHTML = '';
            
            if(tests.length === 0) {
                list.innerHTML = '<p class="text-muted">H…ôl…ô test yaratmamƒ±san.</p>';
            }

            tests.forEach(t => {
                const link = `${window.location.origin}${window.location.pathname}#test/${t.id}`;
                list.innerHTML += `
                    <div class="glass-panel test-card">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <h3>${t.title}</h3>
                                <p style="font-size:0.9rem; opacity:0.7;">${t.questions.length} sual ‚Ä¢ ${t.timer} d…ôqiq…ô</p>
                            </div>
                            <div class="badge">${t.id}</div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn btn-secondary btn-sm" onclick="Dashboard.copyLink('${link}')">üîó Linki Kopyala</button>
                            <button class="btn btn-primary btn-sm" onclick="ExamEngine.start('${t.id}')">‚ñ∂ Sƒ±na</button>
                            <button class="btn btn-danger btn-sm" onclick="TestManager.delete('${t.id}')">üóë Sil</button>
                        </div>
                    </div>
                `;
            });
        },

        copyLink: (url) => {
            navigator.clipboard.writeText(url);
            Toast('Link kopyalandƒ±! Dostlarƒ±nla payla≈ü.');
        }
    };

    // --- TEST MANAGER (Create/Delete) ---
    const TestManager = {
        formatJSON: () => {
            try {
                const el = document.getElementById('json-editor');
                const parsed = JSON.parse(el.value);
                el.value = JSON.stringify(parsed, null, 4);
                Toast('JSON formatlandƒ±');
            } catch (e) { Toast('JSON x…ôtasƒ±: ' + e.message, 'error'); }
        },

        saveTest: () => {
            const title = document.getElementById('create-title').value.trim();
            const timer = parseInt(document.getElementById('create-timer').value);
            const jsonStr = document.getElementById('json-editor').value;

            if (!title) return Toast('Test adƒ±nƒ± yazƒ±n', 'error');
            
            try {
                const questions = JSON.parse(jsonStr);
                if (!Array.isArray(questions) || questions.length === 0) throw new Error("Sual siyahƒ±sƒ± bo≈üdur");
                if (!questions[0].q || !questions[0].o) throw new Error("JSON formatƒ± s…ôhvdir");

                const newTest = {
                    id: DB.generateID(),
                    authorId: Auth.user.id,
                    authorName: Auth.user.username,
                    title,
                    timer,
                    questions,
                    created: new Date()
                };

                const tests = DB.get('tests');
                tests.push(newTest);
                DB.set('tests', tests);

                Toast('Test uƒüurla yaradƒ±ldƒ±!');
                Router.go('dashboard');
            } catch (e) {
                Toast('X…ôta: ' + e.message, 'error');
            }
        },

        delete: (id) => {
            if(!confirm('Bu testi silm…ôk ist…ôdiyin…ô …ômins…ôn?')) return;
            let tests = DB.get('tests');
            tests = tests.filter(t => t.id !== id);
            DB.set('tests', tests);
            Dashboard.load();
            Toast('Test silindi');
        }
    };

    // --- EXAM ENGINE ---
    const ExamEngine = {
        activeTest: null,
        currentIdx: 0,
        answers: {}, // {0: 1, 1: 3}
        flags: [],
        timerInterval: null,
        timeLeft: 0,
        isGuest: false,
        isReviewMode: false,

        startGuest: (testId) => {
            const tests = DB.get('tests');
            const test = tests.find(t => t.id === testId);
            if (!test) return alert('Test tapƒ±lmadƒ± v…ô ya silinib.');
            
            Auth.user = { id: 'guest_' + DB.generateID(), username: 'Qonaq', role: 'guest' };
            ExamEngine.isGuest = true;
            ExamEngine.setup(test);
        },

        start: (testId) => {
            const tests = DB.get('tests');
            const test = tests.find(t => t.id === testId);
            ExamEngine.isGuest = false;
            ExamEngine.setup(test);
        },

        setup: (test) => {
            ExamEngine.activeTest = test;
            ExamEngine.currentIdx = 0;
            ExamEngine.answers = {};
            ExamEngine.flags = [];
            ExamEngine.timeLeft = test.timer * 60;
            ExamEngine.isReviewMode = false;

            // UI Setup
            document.getElementById('navbar').classList.add('hidden'); // Focus mode
            Router.go('exam');
            
            ExamEngine.renderQuestion();
            ExamEngine.updatePalette();
            ExamEngine.startTimer();

            // Fullscreen request
            if(document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }
        },

        startTimer: () => {
            if (ExamEngine.timerInterval) clearInterval(ExamEngine.timerInterval);
            const timerEl = document.getElementById('exam-timer');
            
            ExamEngine.timerInterval = setInterval(() => {
                ExamEngine.timeLeft--;
                const m = Math.floor(ExamEngine.timeLeft / 60);
                const s = ExamEngine.timeLeft % 60;
                timerEl.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                if (ExamEngine.timeLeft <= 0) {
                    ExamEngine.finish();
                }
                
                // Color change
                if (ExamEngine.timeLeft < 60) timerEl.style.borderColor = 'var(--danger)';
            }, 1000);
        },

        renderQuestion: () => {
            const q = ExamEngine.activeTest.questions[ExamEngine.currentIdx];
            document.getElementById('exam-title').innerText = ExamEngine.activeTest.title;
            document.getElementById('exam-progress-text').innerText = `Sual ${ExamEngine.currentIdx + 1} / ${ExamEngine.activeTest.questions.length}`;
            document.getElementById('exam-question-text').innerText = q.q;

            const optsDiv = document.getElementById('exam-options');
            optsDiv.innerHTML = '';

            q.o.forEach((opt, idx) => {
                const isSelected = ExamEngine.answers[ExamEngine.currentIdx] === idx;
                
                // Review Mode Logic
                let extraClass = '';
                if (ExamEngine.isReviewMode) {
                    if (idx === q.a) extraClass = ' correct'; // H…ômi≈ü…ô ya≈üƒ±l
                    else if (isSelected && idx !== q.a) extraClass = ' wrong'; // S…ôhv se√ßilibs…ô qƒ±rmƒ±zƒ±
                } else {
                    if (isSelected) extraClass = ' selected';
                }

                const div = document.createElement('div');
                div.className = `option-item${extraClass}`;
                div.innerHTML = `
                    <span style="width:24px; height:24px; border-radius:50%; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:12px;">${String.fromCharCode(65+idx)}</span>
                    ${opt}
                `;
                if (!ExamEngine.isReviewMode) {
                    div.onclick = () => ExamEngine.selectAnswer(idx);
                }
                optsDiv.appendChild(div);
            });

            // Button update
            const nextBtn = document.getElementById('btn-next');
            nextBtn.innerText = (ExamEngine.currentIdx === ExamEngine.activeTest.questions.length - 1) 
                ? (ExamEngine.isReviewMode ? '√áƒ±xƒ±≈ü' : 'Bitir') 
                : 'N√∂vb…ôti ‚û°';
                
            ExamEngine.updatePalette();
        },

        selectAnswer: (optIdx) => {
            ExamEngine.answers[ExamEngine.currentIdx] = optIdx;
            ExamEngine.renderQuestion();
        },

        flagQuestion: () => {
            if (ExamEngine.flags.includes(ExamEngine.currentIdx)) {
                ExamEngine.flags = ExamEngine.flags.filter(i => i !== ExamEngine.currentIdx);
            } else {
                ExamEngine.flags.push(ExamEngine.currentIdx);
            }
            ExamEngine.updatePalette();
            Toast(ExamEngine.flags.includes(ExamEngine.currentIdx) ? 'Sual i≈üar…ôl…ôndi' : 'ƒ∞≈üar…ô g√∂t√ºr√ºld√º');
        },

        nextQuestion: () => {
            if (ExamEngine.currentIdx < ExamEngine.activeTest.questions.length - 1) {
                ExamEngine.currentIdx++;
                ExamEngine.renderQuestion();
            } else {
                if (ExamEngine.isReviewMode) Router.go('result');
                else ExamEngine.finish();
            }
        },

        prevQuestion: () => {
            if (ExamEngine.currentIdx > 0) {
                ExamEngine.currentIdx--;
                ExamEngine.renderQuestion();
            }
        },

        updatePalette: () => {
            const p = document.getElementById('exam-palette');
            p.innerHTML = '';
            ExamEngine.activeTest.questions.forEach((_, i) => {
                let color = 'rgba(255,255,255,0.1)';
                if (i === ExamEngine.currentIdx) color = 'var(--primary)';
                else if (ExamEngine.flags.includes(i)) color = 'var(--warning)';
                else if (ExamEngine.answers[i] !== undefined) color = 'var(--success)';
                
                const dot = document.createElement('div');
                dot.style.cssText = `width:10px; height:10px; border-radius:50%; background:${color}; cursor:pointer;`;
                dot.onclick = () => { ExamEngine.currentIdx = i; ExamEngine.renderQuestion(); };
                p.appendChild(dot);
            });
        },

        finish: () => {
            clearInterval(ExamEngine.timerInterval);
            if(document.exitFullscreen) document.exitFullscreen().catch(e => {});
            
            // Calculate
            let correct = 0, wrong = 0, empty = 0;
            const qList = ExamEngine.activeTest.questions;
            
            qList.forEach((q, i) => {
                const ans = ExamEngine.answers[i];
                if (ans === undefined) empty++;
                else if (ans === q.a) correct++;
                else wrong++;
            });

            const score = Math.round((correct / qList.length) * 100);

            // Save result (if not guest)
            if (!ExamEngine.isGuest) {
                const results = DB.get('results');
                results.push({
                    id: DB.generateID(),
                    userId: Auth.user.id,
                    testId: ExamEngine.activeTest.id,
                    score,
                    date: new Date()
                });
                DB.set('results', results);
            }

            // Show UI
            document.getElementById('res-score').innerText = score + '%';
            document.getElementById('res-correct').innerText = correct;
            document.getElementById('res-wrong').innerText = wrong;
            document.getElementById('res-empty').innerText = empty;
            
            let msg = "Daha √ßox √ßalƒ±≈ü!";
            if(score > 50) msg = "Pis deyil!";
            if(score > 80) msg = "M√∂ht…ô≈ü…ôm n…ôtic…ô!";
            document.getElementById('res-msg').innerText = msg;

            Router.go('result');
            if (score > 70) startConfetti();
        },

        reviewAnswers: () => {
            ExamEngine.isReviewMode = true;
            ExamEngine.currentIdx = 0;
            Router.go('exam');
            document.getElementById('exam-timer').style.display = 'none';
            ExamEngine.renderQuestion();
        }
    };

    // --- ADMIN ---
    const Admin = {
        load: () => {
            const users = DB.get('users');
            const tests = DB.get('tests');

            document.getElementById('admin-user-count').innerText = users.length;
            document.getElementById('admin-test-count').innerText = tests.length;

            // Users Table
            const uTbody = document.getElementById('admin-users-table');
            uTbody.innerHTML = '';
            users.forEach(u => {
                uTbody.innerHTML += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.username}</td>
                        <td>${u.role}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="Admin.deleteUser('${u.id}')">Sil</button>
                        </td>
                    </tr>
                `;
            });

            // Tests Table
            const tTbody = document.getElementById('admin-tests-table');
            tTbody.innerHTML = '';
            tests.forEach(t => {
                tTbody.innerHTML += `
                    <tr>
                        <td>${t.title}</td>
                        <td>${t.authorName}</td>
                        <td><small>${t.id}</small></td>
                        <td>
                             <button class="btn btn-danger btn-sm" onclick="Admin.deleteTest('${t.id}')">Sil</button>
                        </td>
                    </tr>
                `;
            });
        },

        deleteUser: (id) => {
            if(!confirm('ƒ∞stifad…ô√ßini silm…ôk?')) return;
            let users = DB.get('users');
            users = users.filter(u => u.id !== id);
            DB.set('users', users);
            Admin.load();
        },

        deleteTest: (id) => {
            if(!confirm('Testi silm…ôk?')) return;
            let tests = DB.get('tests');
            tests = tests.filter(t => t.id !== id);
            DB.set('tests', tests);
            Admin.load();
        }
    };

    // --- SIMPLE CONFETTI ENGINE (No external deps) ---
    function startConfetti() {
        const canvas = document.getElementById('confetti');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const particles = [];
        const colors = ['#6366f1', '#ec4899', '#10b981', '#f59e0b'];

        for(let i=0; i<100; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height - canvas.height,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: Math.random() * 10 + 5,
                speed: Math.random() * 5 + 2,
                angle: Math.random() * 6.2
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.y += p.speed;
                p.angle += 0.02;
                ctx.fillStyle = p.color;
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                ctx.restore();

                if(p.y > canvas.height) particles[i].y = -10;
            });
            requestAnimationFrame(draw);
        }
        
        draw();
        setTimeout(() => { canvas.width = 0; }, 5000); // Stop after 5s
    }

    // --- INITIALIZATION ---
    window.onload = () => {
        DB.init();
        Auth.init();
        Router.checkHash();
    };

</script>
</body>
</html>
