.<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ExamMaster Â· pro test Â· zero backend</title>
  <!-- Tailwind + glass ui -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- lucide icons (alternative) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- chart.js, qrcode, confetti -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
  <style>
    /* custom smooth scroll + glass morphism */
    * { scroll-behavior: smooth; }
    .glass { backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); background: rgba(17, 25, 40, 0.6); border: 1px solid rgba(255,255,255,0.125); }
    .glass-light { backdrop-filter: blur(20px); background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.6); }
    body.dark .glass { background: rgba(15, 23, 42, 0.7); border-color: #334155; }
    .slide-enter { animation: slideIn 0.2s ease; }
    @keyframes slideIn { from { opacity:0; transform:translateX(10px); } to { opacity:1; transform:translateX(0); } }
    .toast { transition: all 0.3s; }
    .focus-outline{outline:2px solid #4f46e5;}
    .cheat-flash{animation: warn 0.5s infinite;}
    @keyframes warn{0%{background:rgba(239,68,68,0.2)}50%{background:rgba(239,68,68,0.5)}}
  </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased dark transition-colors duration-300">

  <!-- APP ROOT -->
  <main id="app" class="max-w-7xl mx-auto p-3 md:p-5 relative z-10">

    <!-- TOAST PORTAL -->
    <div id="toast" class="fixed bottom-5 right-5 z-50 glass text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 translate-x-[200%] toast"></div>

    <!-- SCREENS (dynamic) -->
    <!-- ENTRY -->
    <div id="screen-entry" class="screen active">
      <div class="glass max-w-md mx-auto mt-10 p-8 rounded-3xl shadow-2xl">
        <h1 class="text-5xl font-black bg-gradient-to-r from-indigo-400 via-cyan-400 to-pink-400 bg-clip-text text-transparent mb-2">ğŸ“‹ ExamMaster</h1>
        <p class="text-slate-300 mb-8">test yarat Â· paylaÅŸ Â· analiz et</p>
        <div class="flex flex-col gap-3">
          <button class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-3 rounded-2xl transition-all" onclick="ui.show('user-login')"><i data-lucide="log-in" class="w-5 h-5"></i> Ä°stifadÉ™Ã§i giriÅŸi</button>
          <button class="flex items-center justify-center gap-2 border border-slate-600 hover:bg-slate-800/60 px-6 py-3 rounded-2xl transition-all" onclick="ui.show('user-register')"><i data-lucide="user-plus"></i> Qeydiyyat</button>
          <button class="flex items-center justify-center gap-2 border border-slate-600 hover:bg-slate-800/60 px-6 py-3 rounded-2xl transition-all" onclick="guestTakeTest()"><i data-lucide="link"></i> Link ilÉ™ test (qonaq)</button>
          <button class="flex items-center justify-center gap-2 border border-amber-600/50 text-amber-300 hover:bg-amber-950/30 px-6 py-3 rounded-2xl transition-all" onclick="ui.show('admin-login')"><i data-lucide="crown"></i> Admin panel</button>
        </div>
        <div class="flex justify-between mt-8 text-sm">
          <button onclick="toggleTheme()" class="flex items-center gap-1 text-slate-400"><i data-lucide="moon" class="w-4"></i> Tema</button>
          <span class="text-slate-500">v3.0 Â· local-first</span>
        </div>
      </div>
    </div>

    <!-- USER LOGIN -->
    <div id="screen-user-login" class="screen hidden">
      <div class="glass max-w-md mx-auto mt-10 p-8 rounded-3xl">
        <h2 class="text-3xl font-bold mb-6 flex gap-2"><i data-lucide="log-in"></i> GiriÅŸ</h2>
        <input type="email" id="login-email" placeholder="E-poÃ§t" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-3">
        <input type="password" id="login-pass" placeholder="ÅifrÉ™" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-5">
        <button class="w-full bg-indigo-600 hover:bg-indigo-700 py-4 rounded-2xl font-semibold" onclick="auth.login()">Daxil ol</button>
        <button class="w-full mt-3 text-slate-400 py-2" onclick="ui.show('entry')">â† Geri</button>
      </div>
    </div>

    <!-- USER REGISTER -->
    <div id="screen-user-register" class="screen hidden">
      <div class="glass max-w-md mx-auto mt-10 p-8 rounded-3xl">
        <h2 class="text-3xl font-bold mb-6"><i data-lucide="user-plus"></i> Qeydiyyat</h2>
        <input type="text" id="reg-name" placeholder="Ad Soyad" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-3">
        <input type="email" id="reg-email" placeholder="E-poÃ§t" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-3">
        <input type="password" id="reg-pass" placeholder="ÅifrÉ™" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-5">
        <button class="w-full bg-indigo-600 hover:bg-indigo-700 py-4 rounded-2xl" onclick="auth.register()">Qeydiyyatdan keÃ§</button>
        <button class="w-full mt-3 text-slate-400 py-2" onclick="ui.show('entry')">â† Geri</button>
      </div>
    </div>

    <!-- ADMIN LOGIN -->
    <div id="screen-admin-login" class="screen hidden">
      <div class="glass max-w-md mx-auto mt-10 p-8 rounded-3xl border-amber-700/50">
        <h2 class="text-3xl font-bold mb-6 text-amber-400"><i data-lucide="crown"></i> Admin giriÅŸ</h2>
        <input type="text" id="admin-username" value="cesi" placeholder="Ä°stifadÉ™Ã§i adÄ±" class="w-full p-4 bg-slate-800/60 border border-amber-700/50 rounded-2xl mb-3">
        <input type="password" id="admin-password" placeholder="ÅifrÉ™" class="w-full p-4 bg-slate-800/60 border border-amber-700/50 rounded-2xl mb-5">
        <button class="w-full bg-amber-700 hover:bg-amber-800 py-4 rounded-2xl font-semibold" onclick="auth.adminLogin()">GiriÅŸ</button>
        <button class="w-full mt-3 text-slate-400 py-2" onclick="ui.show('entry')">â† Geri</button>
      </div>
    </div>

    <!-- USER DASHBOARD -->
    <div id="screen-user-dashboard" class="screen hidden">
      <div class="glass p-6 rounded-3xl">
        <div class="flex flex-wrap justify-between items-center mb-6">
          <h2 class="text-3xl font-bold flex gap-2"><i data-lucide="user"></i> <span id="dashboard-user-name">Ä°stifadÉ™Ã§i</span></h2>
          <div class="flex gap-2">
            <button class="border border-slate-600 hover:bg-slate-700 px-4 py-2 rounded-xl" onclick="ui.show('edit-profile')"><i data-lucide="edit"></i> RedaktÉ™</button>
            <button class="border border-slate-600 hover:bg-slate-700 px-4 py-2 rounded-xl" onclick="auth.logout()"><i data-lucide="log-out"></i> Ã‡Ä±xÄ±ÅŸ</button>
          </div>
        </div>
        <div class="flex flex-wrap gap-3 mb-6">
          <button class="bg-indigo-600 hover:bg-indigo-700 px-5 py-3 rounded-xl flex items-center gap-2" onclick="ui.show('test-create')"><i data-lucide="plus-circle"></i> Yeni test</button>
          <button class="border border-slate-600 hover:bg-slate-800 px-5 py-3 rounded-xl flex items-center gap-2" onclick="mytest.load()"><i data-lucide="list"></i> MÉ™nim testlÉ™rim</button>
          <button class="border border-slate-600 hover:bg-slate-800 px-5 py-3 rounded-xl flex items-center gap-2" onclick="history.load()"><i data-lucide="history"></i> TarixÃ§É™</button>
        </div>
        <div id="user-tests-list" class="text-slate-400 p-4 rounded-2xl bg-slate-900/40">TestlÉ™riniz burada gÃ¶rÃ¼nÉ™cÉ™k...</div>
      </div>
    </div>

    <!-- EDIT PROFILE -->
    <div id="screen-edit-profile" class="screen hidden">
      <div class="glass max-w-lg mx-auto mt-10 p-8 rounded-3xl">
        <h2 class="text-3xl font-bold mb-6">Profili redaktÉ™ et</h2>
        <input type="text" id="edit-name" placeholder="Ad Soyad" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-3">
        <input type="email" id="edit-email" placeholder="E-poÃ§t" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-3">
        <input type="password" id="edit-pass" placeholder="Yeni ÅŸifrÉ™ (boÅŸ)" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-3">
        <input type="text" id="edit-avatar" placeholder="Avatar emoji" class="w-full p-4 bg-slate-800/60 border border-slate-600 rounded-2xl mb-5">
        <button class="w-full bg-indigo-600 hover:bg-indigo-700 py-4 rounded-2xl" onclick="profile.save()">Yadda saxla</button>
        <button class="w-full mt-3 text-slate-400 py-2" onclick="ui.show('user-dashboard')">Geri</button>
      </div>
    </div>

    <!-- TEST CREATE -->
    <div id="screen-test-create" class="screen hidden">
      <div class="glass p-6 rounded-3xl max-w-3xl mx-auto">
        <h2 class="text-3xl font-bold mb-4"><i data-lucide="pen-tool"></i> Yeni test</h2>
        <div class="grid md:grid-cols-2 gap-3 mb-3">
          <input type="text" id="test-title" placeholder="Test adÄ±" class="p-3 bg-slate-800/60 border rounded-xl">
          <input type="text" id="test-category" placeholder="Kateqoriya" class="p-3 bg-slate-800/60 border rounded-xl">
          <select id="test-difficulty" class="p-3 bg-slate-800/60 border rounded-xl"><option value="easy">Asan</option><option value="medium">Orta</option><option value="hard">Ã‡É™tin</option></select>
          <input type="number" id="test-timer" value="10" placeholder="DÉ™qiqÉ™" class="p-3 bg-slate-800/60 border rounded-xl">
        </div>
        <div class="flex flex-wrap gap-4 mb-3">
          <label class="flex items-center gap-2"><input type="checkbox" id="test-shuffle"> <span>QarÄ±ÅŸdÄ±r</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" id="test-public" checked> Public</label>
          <input type="text" id="test-password" placeholder="Parol (private)" class="p-3 bg-slate-800/60 border rounded-xl flex-1">
          <input type="number" id="test-max-attempts" value="0" placeholder="Maks cÉ™hd" class="p-3 bg-slate-800/60 border rounded-xl w-32">
        </div>
        <label class="block mb-1 text-sm">Suallar (JSON)</label>
        <textarea id="test-json" rows="6" class="w-full p-3 bg-slate-800/60 border rounded-xl font-mono" placeholder='[{"q":"2+2?","o":["3","4","5"],"a":1}]'></textarea>
        <div class="flex gap-3 my-4">
          <button class="bg-cyan-700 hover:bg-cyan-800 px-5 py-2 rounded-xl flex items-center gap-2" onclick="test.previewJson()"><i data-lucide="eye"></i> Preview</button>
          <button class="bg-green-700 hover:bg-green-800 px-5 py-2 rounded-xl flex items-center gap-2" onclick="test.create()"><i data-lucide="save"></i> Yarat</button>
          <button class="border border-slate-600 px-5 py-2 rounded-xl" onclick="ui.show('user-dashboard')">LÉ™ÄŸv et</button>
        </div>
        <div id="json-preview" class="bg-slate-900/60 p-3 rounded-xl text-sm"></div>
      </div>
    </div>

    <!-- TEST SHARE (QR) -->
    <div id="screen-test-share" class="screen hidden">
      <div class="glass max-w-md mx-auto mt-10 p-8 rounded-3xl text-center">
        <h2 class="text-3xl font-bold mb-4">ğŸ‰ Test hazÄ±rdÄ±r</h2>
        <div class="flex bg-slate-800/80 rounded-full p-1 mb-4">
          <input type="text" id="share-link" readonly class="w-full bg-transparent px-4 py-2 outline-none">
          <button class="bg-indigo-600 hover:bg-indigo-700 px-4 rounded-full" onclick="copyShareLink()"><i data-lucide="copy"></i></button>
        </div>
        <div id="qr-code-container" class="flex justify-center my-4"></div>
        <div class="flex justify-center gap-3 mb-6">
          <a id="whatsapp-share" target="_blank" class="bg-green-700 p-3 rounded-full"><i data-lucide="message-circle"></i></a>
          <a id="telegram-share" target="_blank" class="bg-sky-700 p-3 rounded-full"><i data-lucide="send"></i></a>
        </div>
        <button class="border border-slate-600 px-6 py-2 rounded-full" onclick="ui.show('user-dashboard')">Dashboard</button>
      </div>
    </div>

    <!-- TEST TAKING -->
    <div id="screen-test-take" class="screen hidden">
      <div class="glass p-6 rounded-3xl max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 id="take-test-title" class="text-2xl font-bold"></h3>
          <span id="take-timer" class="bg-indigo-600/50 px-4 py-1 rounded-full text-xl font-mono">00:00</span>
        </div>
        <div class="h-2 bg-slate-700 rounded-full mb-4"><div id="take-progress" class="h-2 bg-indigo-500 rounded-full" style="width:0%"></div></div>
        <div id="take-question-text" class="text-xl mb-6 min-h-[80px]"></div>
        <div id="take-options" class="space-y-3 mb-6"></div>
        <div class="flex justify-between">
          <button class="border border-slate-600 px-5 py-2 rounded-xl" id="prevBtn" onclick="take.prev()">â† Geri</button>
          <button class="bg-indigo-600 px-5 py-2 rounded-xl" id="nextBtn" onclick="take.next()">NÃ¶vbÉ™ti â†’</button>
        </div>
        <button class="w-full mt-4 bg-rose-700 hover:bg-rose-800 py-3 rounded-xl" onclick="take.submit()">Testi bitir</button>
      </div>
    </div>

    <!-- REVIEW / RESULT -->
    <div id="screen-test-review" class="screen hidden">
      <div class="glass p-6 rounded-3xl max-w-2xl mx-auto">
        <h2 class="text-3xl font-bold flex gap-2"><i data-lucide="pie-chart"></i> NÉ™ticÉ™lÉ™r</h2>
        <div class="text-6xl font-black my-4" id="review-score">0%</div>
        <div class="flex gap-5 text-lg">
          <span>DÃ¼zgÃ¼n: <span id="review-correct">0</span></span>
          <span>SÉ™hv: <span id="review-wrong">0</span></span>
        </div>
        <div id="review-detail" class="max-h-96 overflow-auto my-4 space-y-2"></div>
        <canvas id="resultChart" class="w-full h-40 my-3"></canvas>
        <button class="bg-indigo-600 px-6 py-2 rounded-full" onclick="ui.show('entry')">Ana sÉ™hifÉ™</button>
      </div>
    </div>

    <!-- ADMIN DASHBOARD (COMMAND CENTER) -->
    <div id="screen-admin-dashboard" class="screen hidden">
      <div class="glass p-6 rounded-3xl border-amber-700/50">
        <div class="flex flex-wrap items-center gap-3 mb-6">
          <h2 class="text-3xl font-bold text-amber-400"><i data-lucide="crown"></i> Komanda mÉ™rkÉ™zi</h2>
          <div class="flex gap-2 ml-auto">
            <button class="border border-amber-700/50 hover:bg-amber-950/40 px-4 py-2 rounded-xl" onclick="admin.listUsers()">Ä°stifadÉ™Ã§ilÉ™r</button>
            <button class="border border-amber-700/50 hover:bg-amber-950/40 px-4 py-2 rounded-xl" onclick="admin.listTests()">TestlÉ™r</button>
            <button class="border border-amber-700/50 hover:bg-amber-950/40 px-4 py-2 rounded-xl" onclick="admin.exportData()">Export</button>
            <button class="border border-amber-700/50 hover:bg-amber-950/40 px-4 py-2 rounded-xl" onclick="admin.importData()">Import</button>
            <button class="border border-amber-700/50 hover:bg-amber-950/40 px-4 py-2 rounded-xl" onclick="auth.logout()">Ã‡Ä±xÄ±ÅŸ</button>
          </div>
        </div>
        <!-- live log & health -->
        <div class="grid md:grid-cols-3 gap-4 mb-4">
          <div class="bg-black/40 p-3 rounded-xl border border-amber-900/30">
            <p class="text-xs text-amber-400">LIVE LOG</p>
            <div id="live-log" class="h-32 overflow-auto text-xs font-mono text-green-300"></div>
          </div>
          <div class="bg-black/40 p-3 rounded-xl border border-amber-900/30 col-span-2">
            <p class="text-amber-400 mb-2">Sistem saÄŸlamlÄ±ÄŸÄ±</p>
            <div class="flex gap-4 flex-wrap"><span>ğŸ’¾ Local: <span id="storage-size">0</span> KB</span><span>ğŸ“Š Test sayÄ±: <span id="test-count">0</span></span><span>ğŸ‘¥ User: <span id="user-count">0</span></span></div>
            <div class="w-full bg-slate-700 h-2 mt-2 rounded-full"><div id="storage-bar" class="h-2 bg-amber-500 rounded-full" style="width:0%"></div></div>
          </div>
        </div>
        <div id="admin-content" class="bg-slate-900/60 p-4 rounded-2xl max-h-[400px] overflow-auto"></div>
      </div>
    </div>

    <!-- announcement bar (admin broadcast) -->
    <div id="announcement-bar" class="fixed top-0 left-0 w-full bg-amber-700 text-white text-center py-2 hidden z-50">ğŸ“¢ </div>
  </main>

  <script>
    (function() {
      "use strict";
      // ---------- GLOBAL STATE (store) ----------
      window.store = {
        users: JSON.parse(localStorage.getItem('exam_users')) || [],
        tests: JSON.parse(localStorage.getItem('exam_tests')) || [],
        results: JSON.parse(localStorage.getItem('exam_results')) || [],
        settings: JSON.parse(localStorage.getItem('exam_settings')) || { theme: 'dark', announcement: '' },
        currentUser: null,
        currentTest: null,         // taking test object
        currentAnswers: {},
        currentQuestionIndex: 0,
        timerInterval: null,
        timerSeconds: 0,
        tabWarnings: 0,
        cheatLog: []
      };

      // default admin
      if (!store.users.find(u => u.role === 'admin')) {
        store.users.push({ id: 'admin1', name: 'Admin', email: 'cesi', password: 'cesi123', role: 'admin', avatar: 'ğŸ›¡ï¸', createdAt: Date.now() });
      }
      // sample test
      if (store.tests.length === 0) {
        store.tests.push({ id: 'sample1', title: 'NÃ¼munÉ™: paytaxt', category: 'Ã¼mumi', difficulty: 'easy', timer: 2, isPublic: true, password: '', shuffle: false, maxAttempts: 0, createdBy: 'admin1', approved: true, questions: [{ q: 'AzÉ™rbaycanÄ±n paytaxtÄ±?', o: ['BakÄ±','GÉ™ncÉ™','SumqayÄ±t'], a: 0 }] });
      }
      store.settings.theme = store.settings.theme || 'dark';
      if (store.settings.theme === 'light') document.body.classList.remove('dark'); else document.body.classList.add('dark');

      // IndexedDB mock (localStorage istifadÉ™ olunur, real IndexedDB É™vÉ™zinÉ™ sadÉ™ saxlanÄ±lÄ±r)
      // Lakin bÃ¶yÃ¼k datalar Ã¼Ã§Ã¼n localStorage kifayÉ™tdir.

      // Helper: save all
      function saveAll() {
        localStorage.setItem('exam_users', JSON.stringify(store.users));
        localStorage.setItem('exam_tests', JSON.stringify(store.tests));
        localStorage.setItem('exam_results', JSON.stringify(store.results));
        localStorage.setItem('exam_settings', JSON.stringify(store.settings));
      }

      // Toast
      function toast(msg, type = 'success') {
        let t = document.getElementById('toast');
        t.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check-circle'}" class="w-5"></i> <span>${msg}</span>`;
        t.classList.remove('translate-x-[200%]'); t.classList.add('translate-x-0');
        if (type === 'error') t.classList.add('bg-rose-900'); else t.classList.remove('bg-rose-900');
        setTimeout(() => t.classList.add('translate-x-[200%]'), 3000);
        lucide.createIcons();
      }
      window.toast = toast;

      // UI router
      window.ui = {
        show: (id) => {
          document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
          document.getElementById(`screen-${id}`).classList.remove('hidden');
          if (id === 'user-dashboard' && store.currentUser) {
            document.getElementById('dashboard-user-name').innerText = store.currentUser.name || store.currentUser.email;
            mytest.load();
          }
          if (id === 'admin-dashboard') { admin.listUsers(); updateHealth(); }
          lucide.createIcons();
        }
      };

      // Theme
      window.toggleTheme = () => {
        document.body.classList.toggle('dark');
        store.settings.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
        saveAll();
      };

      // ---------- AUTH ----------
      window.auth = {
        register: () => {
          let name = document.getElementById('reg-name').value.trim();
          let email = document.getElementById('reg-email').value.trim();
          let pass = document.getElementById('reg-pass').value.trim();
          if (!email || !pass) return toast('Email vÉ™ ÅŸifrÉ™ tÉ™lÉ™b olunur', 'error');
          if (store.users.find(u => u.email === email)) return toast('Email mÃ¶vcuddur', 'error');
          let user = { id: 'u'+Date.now(), name: name || email.split('@')[0], email, password: pass, role: 'user', avatar: 'ğŸ‘¤', createdAt: Date.now() };
          store.users.push(user); saveAll(); toast('Qeydiyyat uÄŸurlu'); ui.show('user-login');
        },
        login: () => {
          let email = document.getElementById('login-email').value.trim();
          let pass = document.getElementById('login-pass').value.trim();
          let user = store.users.find(u => u.email === email && u.password === pass && u.role !== 'admin');
          if (user) { store.currentUser = user; toast('XoÅŸ gÉ™ldiniz'); ui.show('user-dashboard'); } 
          else toast('Email vÉ™ ya ÅŸifrÉ™ yanlÄ±ÅŸ', 'error');
        },
        adminLogin: () => {
          let u = document.getElementById('admin-username').value;
          let p = document.getElementById('admin-password').value;
          let admin = store.users.find(us => us.role === 'admin' && us.password === p && us.email === u);
          if (admin || (u === 'cesi' && p === 'cesi123')) {
            if (!admin) admin = store.users.find(us => us.role === 'admin');
            store.currentUser = admin; toast('Admin giriÅŸi'); ui.show('admin-dashboard'); logEvent('Admin giriÅŸ');
          } else toast('Admin kredensiallarÄ± sÉ™hv', 'error');
        },
        logout: () => { store.currentUser = null; clearInterval(store.timerInterval); ui.show('entry'); }
      };

      // log for admin
      function logEvent(msg) {
        let logDiv = document.getElementById('live-log');
        if (logDiv) {
          let time = new Date().toLocaleTimeString();
          logDiv.innerHTML += `<div>ğŸ•’ ${time} â†’ ${msg}</div>`;
          logDiv.scrollTop = logDiv.scrollHeight;
        }
        store.cheatLog.push({ time: Date.now(), msg });
      }

      // ANTI-CHEAT: tab switch
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && store.currentTest) {
          store.tabWarnings++;
          logEvent(`ğŸš¨ TÉ™lÉ™bÉ™ tab dÉ™yiÅŸdi (${store.tabWarnings})`);
          toast('XÉ™bÉ™rdarlÄ±q: TÉ™rk etmÉ™yin!', 'error');
          document.body.classList.add('cheat-flash');
          setTimeout(()=>document.body.classList.remove('cheat-flash'),1000);
        }
      });

      // right click disable
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('copy', e => e.preventDefault());

      // fullscreen lock for test
      function lockFullscreen() {
        if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); }
      }

      // ---------- TEST CREATION ----------
      window.test = {
        previewJson: () => {
          try {
            let js = JSON.parse(document.getElementById('test-json').value);
            document.getElementById('json-preview').innerHTML = `<span class="text-green-400">âœ“ ${js.length} sual</span><pre class="text-xs">${JSON.stringify(js[0], null, 2)}</pre>`;
          } catch (e) { document.getElementById('json-preview').innerHTML = `<span class="text-rose-400">JSON xÉ™tasÄ±: ${e.message}</span>`; }
        },
        create: () => {
          if (!store.currentUser) return toast('Daxil olun', 'error');
          let title = document.getElementById('test-title').value.trim() || 'AdsÄ±z';
          let cat = document.getElementById('test-category').value.trim() || 'Ã¼mumi';
          let diff = document.getElementById('test-difficulty').value;
          let timer = parseInt(document.getElementById('test-timer').value) || 10;
          let shuffle = document.getElementById('test-shuffle').checked;
          let isPublic = document.getElementById('test-public').checked;
          let pwd = document.getElementById('test-password').value;
          let maxAttempts = parseInt(document.getElementById('test-max-attempts').value) || 0;
          let jsonStr = document.getElementById('test-json').value.trim();
          let questions;
          try { questions = JSON.parse(jsonStr); } catch (e) { return toast('JSON formatÄ± sÉ™hv', 'error'); }
          if (!Array.isArray(questions) || questions.length === 0) return toast('Suallar boÅŸ', 'error');
          for (let q of questions) { if (!q.q || !Array.isArray(q.o) || q.a === undefined) return toast('HÉ™r sualda q, o (array) vÉ™ a olmalÄ±dÄ±r', 'error'); }
          let testId = 't_'+Date.now()+'_'+Math.random().toString(36).substr(2,6);
          let newTest = { id: testId, title, category: cat, difficulty: diff, timer, shuffle, isPublic, password: pwd, maxAttempts, createdBy: store.currentUser.id, createdAt: Date.now(), approved: false, questions };
          store.tests.push(newTest); saveAll();
          logEvent(`Yeni test yaradÄ±ldÄ±: ${title}`);
          // share screen
          let link = window.location.origin + window.location.pathname + '?test=' + testId;
          document.getElementById('share-link').value = link;
          let qr = qrcode(0, 'M'); qr.addData(link); qr.make();
          document.getElementById('qr-code-container').innerHTML = qr.createImgTag(4);
          document.getElementById('whatsapp-share').href = `https://wa.me/?text=${encodeURIComponent(link)}`;
          document.getElementById('telegram-share').href = `https://t.me/share/url?url=${encodeURIComponent(link)}`;
          ui.show('test-share');
        }
      };

      // ---------- MY TESTS ----------
      window.mytest = {
        load: () => {
          if (!store.currentUser) return;
          let my = store.tests.filter(t => t.createdBy === store.currentUser.id);
          let html = '<h3 class="font-bold mb-2">MÉ™nim testlÉ™rim</h3><ul class="space-y-2">';
          my.forEach(t => html += `<li class="flex justify-between bg-slate-800/40 p-3 rounded-xl"><span>${t.title} (${t.questions.length} sual) ${t.approved?'âœ…':'â³'}</span> <div><button class="text-cyan-400 mr-2" onclick="shareTest('${t.id}')"><i data-lucide="share"></i></button><button class="text-rose-400" onclick="deleteTest('${t.id}')"><i data-lucide="trash"></i></button></div></li>`);
          html += '</ul>';
          document.getElementById('user-tests-list').innerHTML = html; lucide.createIcons();
        }
      };
      window.deleteTest = (id) => { store.tests = store.tests.filter(t => !(t.id === id && t.createdBy === store.currentUser.id)); saveAll(); mytest.load(); toast('Test silindi'); };
      window.shareTest = (id) => {
        let test = store.tests.find(t => t.id === id); if (!test) return;
        let link = window.location.origin + window.location.pathname + '?test=' + id;
        document.getElementById('share-link').value = link;
        let qr = qrcode(0, 'M'); qr.addData(link); qr.make();
        document.getElementById('qr-code-container').innerHTML = qr.createImgTag(4);
        ui.show('test-share');
      };

      // ---------- TAKE TEST (guest / user) ----------
      window.take = {
        start: (test, guestMode = true) => {
          clearInterval(store.timerInterval);
          store.currentTest = JSON.parse(JSON.stringify(test)); // clone
          store.currentAnswers = {};
          store.currentQuestionIndex = 0;
          store.timerSeconds = (store.currentTest.timer || 10) * 60;
          store.tabWarnings = 0;
          document.getElementById('take-test-title').innerText = store.currentTest.title;
          take.renderQuestion();
          take.startTimer();
          ui.show('test-take');
          lockFullscreen();
          logEvent(`Test baÅŸladÄ±: ${test.title}`);
        },
        renderQuestion: () => {
          let q = store.currentTest.questions[store.currentQuestionIndex];
          document.getElementById('take-question-text').innerText = q.q;
          let html = '';
          q.o.forEach((opt, idx) => {
            let sel = store.currentAnswers[store.currentQuestionIndex] === idx ? 'bg-indigo-900/60 border-indigo-400' : 'bg-slate-800/40 border-transparent';
            html += `<div class="option p-4 rounded-xl border-2 cursor-pointer hover:bg-slate-700/60 ${sel}" onclick="take.select(${idx})">${opt}</div>`;
          });
          document.getElementById('take-options').innerHTML = html;
          document.getElementById('take-progress').style.width = ((store.currentQuestionIndex+1)/store.currentTest.questions.length*100)+'%';
          document.getElementById('nextBtn').innerText = (store.currentQuestionIndex === store.currentTest.questions.length-1) ? 'Bitir' : 'NÃ¶vbÉ™ti';
        },
        select: (idx) => { store.currentAnswers[store.currentQuestionIndex] = idx; take.renderQuestion(); },
        next: () => {
          if (store.currentQuestionIndex < store.currentTest.questions.length-1) { store.currentQuestionIndex++; take.renderQuestion(); } 
          else take.submit();
        },
        prev: () => { if (store.currentQuestionIndex > 0) { store.currentQuestionIndex--; take.renderQuestion(); } },
        startTimer: () => {
          store.timerInterval = setInterval(() => {
            if (store.timerSeconds <= 0) { clearInterval(store.timerInterval); take.submit(); return; }
            store.timerSeconds--;
            let m = Math.floor(store.timerSeconds/60).toString().padStart(2,'0');
            let s = (store.timerSeconds%60).toString().padStart(2,'0');
            document.getElementById('take-timer').innerText = `${m}:${s}`;
          },1000);
        },
        submit: () => {
          clearInterval(store.timerInterval);
          let correct = 0;
          store.currentTest.questions.forEach((q, i) => { if (store.currentAnswers[i] === q.a) correct++; });
          let total = store.currentTest.questions.length;
          let wrong = total - correct;
          let score = Math.round((correct/total)*100);
          let result = { id: 'r'+Date.now(), testId: store.currentTest.id, userId: store.currentUser ? store.currentUser.id : 'guest_'+Date.now(), answers: store.currentAnswers, score, correct, wrong, completedAt: Date.now(), tabWarns: store.tabWarnings };
          store.results.push(result); saveAll();
          if (score === 100) confetti({particleCount:150, spread:80});
          document.getElementById('review-score').innerText = score+'%';
          document.getElementById('review-correct').innerText = correct;
          document.getElementById('review-wrong').innerText = wrong;
          let detail = '';
          store.currentTest.questions.forEach((q, i) => {
            let u = store.currentAnswers[i] ?? -1;
            let st = u === q.a ? 'âœ…' : (u===-1?'âš ï¸ boÅŸ':'âŒ');
            detail += `<div class="border-b border-slate-700 pb-2"><b>${i+1}. ${q.q}</b> ${st}<br> <span class="text-sm">Siz: ${u!==-1?q.o[u]:'â€”'} | DÃ¼zgÃ¼n: ${q.o[q.a]}</span></div>`;
          });
          document.getElementById('review-detail').innerHTML = detail;
          // chart
          new Chart(document.getElementById('resultChart'), { type: 'doughnut', data: { labels: ['DÃ¼zgÃ¼n','SÉ™hv'], datasets: [{ data: [correct, wrong], backgroundColor: ['#10b981','#ef4444'] }] } });
          ui.show('test-review');
          logEvent(`Test bitdi. Bal: ${score}%`);
        }
      };
      window.take = take;

      // guest start from link
      window.guestTakeTest = () => {
        let link = prompt('Test linkini daxil edin:');
        if (!link) return;
        try {
          let url = new URL(link);
          let testId = url.searchParams.get('test');
          let test = store.tests.find(t => t.id === testId);
          if (test) take.start(test, true);
          else toast('Test tapÄ±lmadÄ±', 'error');
        } catch { toast('DÃ¼zgÃ¼n link daxil edin', 'error'); }
      };

      // check url on load
      (function initFromUrl() {
        let params = new URLSearchParams(window.location.search);
        let testId = params.get('test');
        if (testId) {
          let test = store.tests.find(t => t.id === testId);
          if (test) take.start(test, true);
        }
      })();

      // ---------- ADMIN ----------
      window.admin = {
        listUsers: () => {
          let html = '<h3 class="text-lg mb-2">ğŸ‘¥ Ä°stifadÉ™Ã§ilÉ™r</h3>';
          store.users.forEach(u => html += `<div class="flex justify-between p-2 border-b border-slate-700"><span>${u.avatar||'ğŸ‘¤'} ${u.name||u.email} (${u.role})</span><button class="text-rose-400" onclick="admin.deleteUser('${u.id}')"><i data-lucide="ban"></i></button></div>`);
          document.getElementById('admin-content').innerHTML = html; lucide.createIcons();
        },
        deleteUser: (id) => { if (store.currentUser && store.currentUser.id === id) return toast('Ã–zÃ¼nÃ¼zÃ¼ silÉ™ bilmÉ™zsiniz','error'); store.users = store.users.filter(u=>u.id!==id); saveAll(); admin.listUsers(); },
        listTests: () => {
          let html = '<h3>ğŸ“‹ BÃ¼tÃ¼n testlÉ™r</h3>';
          store.tests.forEach(t => html += `<div class="p-2 border-b flex justify-between"><span>${t.title} (${t.questions.length}) - ${t.approved?'âœ… tÉ™sdiqlÉ™ndi':'â³ gÃ¶zlÉ™yir'}</span><div><button class="text-green-400 mr-2" onclick="admin.approveTest('${t.id}')">âœ”</button><button class="text-rose-400" onclick="admin.deleteTest('${t.id}')">ğŸ—‘</button></div></div>`);
          document.getElementById('admin-content').innerHTML = html;
        },
        approveTest: (id) => { let t = store.tests.find(t=>t.id===id); if(t) t.approved = true; saveAll(); admin.listTests(); },
        deleteTest: (id) => { store.tests = store.tests.filter(t=>t.id!==id); saveAll(); admin.listTests(); },
        exportData: () => { let data = { users: store.users, tests: store.tests, results: store.results }; let blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'exam_backup.json'; a.click(); },
        importData: () => { let input = document.createElement('input'); input.type='file'; input.accept='.json'; input.onchange = e => { let file = e.target.files[0]; let reader = new FileReader(); reader.onload = ee => { try { let j = JSON.parse(ee.target.result); if(j.users) store.users = j.users; if(j.tests) store.tests = j.tests; if(j.results) store.results = j.results; saveAll(); toast('Ä°dxal edildi'); admin.listUsers(); } catch(ex){ toast('XÉ™ta','error'); } }; reader.readAsText(file); }; input.click(); }
      };

      function updateHealth() {
        let size = new Blob([localStorage.getItem('exam_tests')||'']).size / 1024;
        document.getElementById('storage-size').innerText = size.toFixed(1);
        document.getElementById('test-count').innerText = store.tests.length;
        document.getElementById('user-count').innerText = store.users.length;
        let percent = Math.min(100, (size / 5000)*100);
        document.getElementById('storage-bar').style.width = percent+'%';
      }

      // profile
      window.profile = {
        save: () => {
          let name = document.getElementById('edit-name').value.trim();
          let email = document.getElementById('edit-email').value.trim();
          let pass = document.getElementById('edit-pass').value.trim();
          let avatar = document.getElementById('edit-avatar').value.trim();
          if (email && email !== store.currentUser.email) {
            if (store.users.find(u=>u.email===email && u.id!==store.currentUser.id)) return toast('Email istifadÉ™ olunur','error');
            store.currentUser.email = email;
          }
          if (name) store.currentUser.name = name;
          if (pass) store.currentUser.password = pass;
          if (avatar) store.currentUser.avatar = avatar;
          saveAll(); toast('YenilÉ™ndi'); ui.show('user-dashboard');
        }
      };

      // copy link
      window.copyShareLink = () => { let link = document.getElementById('share-link'); link.select(); document.execCommand('copy'); toast('Link kopyalandÄ±'); };

      // init icons
      lucide.createIcons();
    })();
  </script>
</body>
</html>