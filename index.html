<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ExamMaster ¬∑ online test platformu</title>
    <!-- external libraries (single file still, only CDN calls) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            --bg: #0b1120;
            --surface: #1e293bcc;
            --surface-solid: #1e293b;
            --border: #334155;
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --secondary: #06b6d4;
            --accent: #f43f5e;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --glass: rgba(30, 41, 59, 0.6);
            --shadow: 0 25px 50px -12px #00000080;
        }

        body.light {
            --bg: #f8fafc;
            --surface: #ffffffcc;
            --surface-solid: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #475569;
            --glass: #ffffffb3;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
            backdrop-filter: blur(2px);
            background-image: radial-gradient(circle at 30% 10%, #4f46e515 0%, transparent 30%),
                              radial-gradient(circle at 80% 70%, #06b6d415 0%, transparent 30%);
        }

        .app { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        /* glass card */
        .card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        /* screens */
        .screen { display: none; }
        .screen.active { display: block; }

        /* buttons */
        .btn {
            background: var(--primary);
            border: none;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 3rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }
        .btn-outline {
            background: transparent;
            border-color: var(--border);
            color: var(--text);
        }
        .btn-outline:hover { background: var(--surface-solid); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }

        /* forms */
        .input-group { margin-bottom: 1.2rem; }
        input, textarea, select {
            width: 100%;
            padding: 1rem;
            background: var(--surface-solid);
            border: 2px solid var(--border);
            border-radius: 1.5rem;
            color: var(--text);
            font-size: 1rem;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        /* grid */
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }

        /* quiz options */
        .option {
            background: var(--surface-solid);
            padding: 1rem 1.5rem;
            margin: 0.5rem 0;
            border-radius: 1rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .option:hover { background: #334155; }
        .option.selected { border-color: var(--primary); background: #4f46e520; }
        .option.correct { border-color: var(--success); background: #10b98120; }
        .option.wrong { border-color: var(--danger); background: #ef444420; }

        .badge {
            background: var(--primary);
            padding: 0.3rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
        }

        /* progress */
        .progress { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; }

        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--surface-solid); border-left: 5px solid var(--primary);
            padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: var(--shadow);
            transform: translateX(200%); transition: 0.3s; z-index: 9999;
        }
        .toast.show { transform: translateX(0); }

        /* mobile */
        @media (max-width: 600px) {
            .card { padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="app" id="app">

        <!-- TOAST -->
        <div id="toast" class="toast"><i class="fas fa-info-circle"></i> <span>Mesaj</span></div>

        <!-- ENTRY SCREEN (login/register/guest) + admin shortcut -->
        <div id="screen-entry" class="screen active">
            <div class="card" style="max-width: 500px; margin: 2rem auto;">
                <h1 style="font-size: 2.5rem; background: linear-gradient(135deg, #4f46e5, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üìã ExamMaster</h1>
                <p style="margin-bottom: 2rem;">Test yarat, payla≈ü, n…ôtic…ôl…ôri analiz et.</p>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn" onclick="showScreen('user-login')"><i class="fas fa-sign-in-alt"></i> ƒ∞stifad…ô√ßi giri≈üi</button>
                    <button class="btn btn-outline" onclick="showScreen('user-register')"><i class="fas fa-user-plus"></i> Qeydiyyat</button>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn btn-outline" onclick="guestTakeTest()"><i class="fas fa-link"></i> Link il…ô test (qonaq)</button>
                    <button class="btn btn-outline" onclick="showScreen('admin-login')"><i class="fas fa-crown"></i> Admin</button>
                </div>
                <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem; display: flex; gap: 1rem;">
                    <button class="btn-outline" style="border:none;" onclick="toggleTheme()"><i class="fas fa-moon"></i> Tema</button>
                </div>
            </div>
        </div>

        <!-- USER LOGIN -->
        <div id="screen-user-login" class="screen">
            <div class="card" style="max-width: 400px; margin:2rem auto;">
                <h2><i class="fas fa-sign-in-alt"></i> ƒ∞stifad…ô√ßi giri≈üi</h2>
                <div class="input-group"><input type="email" id="login-email" placeholder="E-po√ßt"></div>
                <div class="input-group"><input type="password" id="login-pass" placeholder="≈ûifr…ô"></div>
                <button class="btn" onclick="userLogin()"><i class="fas fa-arrow-right"></i> Daxil ol</button>
                <button class="btn-outline" style="margin-top:1rem;" onclick="showScreen('entry')">Geri</button>
            </div>
        </div>

        <!-- USER REGISTER -->
        <div id="screen-user-register" class="screen">
            <div class="card" style="max-width:400px; margin:2rem auto;">
                <h2><i class="fas fa-user-plus"></i> Qeydiyyat</h2>
                <div class="input-group"><input type="text" id="reg-name" placeholder="Ad Soyad"></div>
                <div class="input-group"><input type="email" id="reg-email" placeholder="E-po√ßt"></div>
                <div class="input-group"><input type="password" id="reg-pass" placeholder="≈ûifr…ô"></div>
                <button class="btn" onclick="userRegister()">Qeydiyyatdan ke√ß</button>
                <button class="btn-outline" style="margin-top:1rem;" onclick="showScreen('entry')">Geri</button>
            </div>
        </div>

        <!-- ADMIN LOGIN (separate) -->
        <div id="screen-admin-login" class="screen">
            <div class="card" style="max-width:400px; margin:2rem auto;">
                <h2><i class="fas fa-lock"></i> Admin panel</h2>
                <div class="input-group"><input type="text" id="admin-username" value="cesi" placeholder="ƒ∞stifad…ô√ßi adƒ±"></div>
                <div class="input-group"><input type="password" id="admin-password" placeholder="≈ûifr…ô"></div>
                <button class="btn" onclick="adminLogin()">Giri≈ü</button>
                <button class="btn-outline" onclick="showScreen('entry')">Geri</button>
            </div>
        </div>

        <!-- USER DASHBOARD (profile, tests, history) -->
        <div id="screen-user-dashboard" class="screen">
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <h2><i class="fas fa-user-circle"></i> <span id="dashboard-user-name">ƒ∞stifad…ô√ßi</span></h2>
                    <div>
                        <button class="btn-outline" onclick="showEditProfile()"><i class="fas fa-edit"></i> Redakt…ô</button>
                        <button class="btn-outline" onclick="logout()"><i class="fas fa-sign-out-alt"></i> √áƒ±xƒ±≈ü</button>
                    </div>
                </div>
                <div style="display:flex; gap:2rem; flex-wrap: wrap; margin:2rem 0;">
                    <button class="btn" onclick="showScreen('test-create')"><i class="fas fa-plus-circle"></i> Test yarat</button>
                    <button class="btn-outline" onclick="loadMyTests()"><i class="fas fa-list"></i> M…ônim testl…ôrim</button>
                    <button class="btn-outline" onclick="loadHistory()"><i class="fas fa-history"></i> Tarix√ß…ô</button>
                </div>
                <div id="user-tests-list" style="margin-top:2rem;">Testl…ôriniz burada g√∂r√ºn…ôc…ôk...</div>
            </div>
        </div>

        <!-- EDIT PROFILE MODAL (inline) -->
        <div id="screen-edit-profile" class="screen">
            <div class="card" style="max-width:500px; margin:2rem auto;">
                <h2>Profili redakt…ô et</h2>
                <div class="input-group"><input type="text" id="edit-name" placeholder="Ad Soyad"></div>
                <div class="input-group"><input type="email" id="edit-email" placeholder="E-po√ßt"></div>
                <div class="input-group"><input type="password" id="edit-pass" placeholder="Yeni ≈üifr…ô (bo≈ü buraxƒ±la bil…ôr)"></div>
                <div class="input-group"><input type="text" id="edit-avatar" placeholder="Avatar emoji v…ô ya URL"></div>
                <button class="btn" onclick="saveProfile()">Yadda saxla</button>
                <button class="btn-outline" onclick="showScreen('user-dashboard')">Geri</button>
            </div>
        </div>

        <!-- TEST CREATE FORM -->
        <div id="screen-test-create" class="screen">
            <div class="card" style="max-width:800px; margin:0 auto;">
                <h2><i class="fas fa-pen"></i> Yeni test</h2>
                <div class="grid-2">
                    <div><input type="text" id="test-title" placeholder="Test adƒ±"></div>
                    <div><input type="text" id="test-category" placeholder="Kateqoriya (riyaziyyat, tarix...)"></div>
                    <div><select id="test-difficulty"><option value="easy">Asan</option><option value="medium">Orta</option><option value="hard">√á…ôtin</option></select></div>
                    <div><input type="number" id="test-timer" placeholder="Timer (d…ôqiq…ô)" value="10"></div>
                    <div><label><input type="checkbox" id="test-shuffle" > Variantlarƒ± qarƒ±≈üdƒ±r</label></div>
                    <div><label><input type="checkbox" id="test-public" checked> Public (linkl…ô h…ôr k…ôs)</label></div>
                    <div><input type="text" id="test-password" placeholder="Parol (private se√ßilibs…ô)"></div>
                    <div><input type="number" id="test-max-attempts" placeholder="Maks c…ôhd" value="0"></div>
                </div>
                <div class="input-group">
                    <label>Suallar (JSON format)</label>
                    <textarea id="test-json" rows="8" placeholder='[{"q":"2+2?","o":["3","4","5"],"a":1}]'></textarea>
                </div>
                <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                    <button class="btn" onclick="previewTestJson()"><i class="fas fa-eye"></i> Preview</button>
                    <button class="btn-success" onclick="createTest()"><i class="fas fa-save"></i> Testi yarat</button>
                    <button class="btn-outline" onclick="showScreen('user-dashboard')">L…ôƒüv et</button>
                </div>
                <div id="json-preview" style="margin-top:1rem; background: var(--surface-solid); padding:1rem; border-radius:1rem;"></div>
            </div>
        </div>

        <!-- TEST SHARE (after creation) -->
        <div id="screen-test-share" class="screen">
            <div class="card" style="max-width:500px; margin:2rem auto;">
                <h2><i class="fas fa-share-alt"></i> Test hazƒ±rdƒ±r!</h2>
                <p>Linki kopyalayƒ±b payla≈üƒ±n:</p>
                <div style="display:flex; background: var(--surface-solid); border-radius:2rem; padding:0.2rem;">
                    <input type="text" id="share-link" readonly style="border:none; background:transparent;">
                    <button class="btn" onclick="copyShareLink()"><i class="fas fa-copy"></i></button>
                </div>
                <div style="margin:1rem 0;" id="qr-code-container"></div>
                <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                    <a id="whatsapp-share" target="_blank" class="btn-success btn"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                    <a id="telegram-share" target="_blank" class="btn"><i class="fab fa-telegram"></i> Telegram</a>
                </div>
                <button class="btn-outline" onclick="showScreen('user-dashboard')">Dashboard</button>
            </div>
        </div>

        <!-- TEST TAKING (guest or user) -->
        <div id="screen-test-take" class="screen">
            <div class="card">
                <div style="display:flex; justify-content:space-between; flex-wrap:wrap;">
                    <h3 id="take-test-title">Test</h3>
                    <span class="badge" id="take-timer">00:00</span>
                </div>
                <div class="progress" style="margin:1rem 0;"><div class="progress-bar" id="take-progress" style="width:0%"></div></div>
                <div id="take-question-text" style="font-size:1.3rem; margin:1rem 0;">Sual</div>
                <div id="take-options"></div>
                <div style="display:flex; justify-content:space-between; margin-top:2rem;">
                    <button class="btn-outline" id="prevBtn" onclick="takePrev()"><i class="fas fa-chevron-left"></i> Geri</button>
                    <button class="btn" id="nextBtn" onclick="takeNext()">N√∂vb…ôti <i class="fas fa-chevron-right"></i></button>
                </div>
                <button class="btn-danger" style="margin-top:1rem;" id="submitTestBtn" onclick="submitTest()">Testi bitir</button>
            </div>
        </div>

        <!-- TEST REVIEW / RESULT -->
        <div id="screen-test-review" class="screen">
            <div class="card">
                <h2><i class="fas fa-chart-pie"></i> N…ôtic…ôl…ôr</h2>
                <div style="font-size:3rem; font-weight:800;" id="review-score">0%</div>
                <div class="grid-2" style="margin:1rem 0;">
                    <div>D√ºzg√ºn: <span id="review-correct">0</span></div>
                    <div>S…ôhv: <span id="review-wrong">0</span></div>
                </div>
                <div id="review-detail"></div>
                <button class="btn" onclick="showScreen('entry')">Ana s…ôhif…ô</button>
            </div>
        </div>

        <!-- ADMIN DASHBOARD (very simplified but covers essentials) -->
        <div id="screen-admin-dashboard" class="screen">
            <div class="card">
                <h2><i class="fas fa-crown"></i> Admin panel</h2>
                <div style="display:flex; gap:1rem; flex-wrap:wrap;">
                    <button class="btn-outline" onclick="adminListUsers()">ƒ∞stifad…ô√ßil…ôr</button>
                    <button class="btn-outline" onclick="adminListTests()">Testl…ôr</button>
                    <button class="btn-outline" onclick="exportData()">JSON export</button>
                    <button class="btn-outline" onclick="importData()">JSON import</button>
                    <button class="btn-outline" onclick="logout()">√áƒ±xƒ±≈ü</button>
                </div>
                <div id="admin-content" style="margin-top:2rem; max-height:500px; overflow:auto;"></div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // ---------- DATA LAYER (localStorage) ----------
            const STORE = {
                users: [],
                tests: [],
                results: [],
                settings: { theme: 'dark' }
            };

            // Load from localStorage
            function loadDB() {
                try {
                    STORE.users = JSON.parse(localStorage.getItem('exam_users')) || [];
                    STORE.tests = JSON.parse(localStorage.getItem('exam_tests')) || [];
                    STORE.results = JSON.parse(localStorage.getItem('exam_results')) || [];
                    let sets = localStorage.getItem('exam_settings');
                    if(sets) STORE.settings = JSON.parse(sets);
                } catch (e) { console.warn('DB error', e); }
                // default admin if no users
                if(!STORE.users.find(u => u.role === 'admin')) {
                    STORE.users.push({ id: 'admin1', name:'Admin', email:'admin@local', password:'cesi123', role:'admin', avatar:'üõ°Ô∏è', createdAt: Date.now() });
                }
                // default sample tests?
                if(STORE.tests.length === 0) {
                    STORE.tests.push({
                        id: 'sample1', title: 'N√ºmun…ô test', description: '', category: '√ºmumi', difficulty:'easy', timer:5, isPublic:true, password:'', shuffle:false, maxAttempts:0, createdBy: 'admin1', createdAt: Date.now(),
                        questions: [ { q:'Az…ôrbaycanƒ±n paytaxtƒ±?', o:['Bakƒ±','G…ônc…ô','Sumqayƒ±t','Nax√ßƒ±van'], a:0 } ]
                    });
                }
                saveDB();
            }
            function saveDB() {
                localStorage.setItem('exam_users', JSON.stringify(STORE.users));
                localStorage.setItem('exam_tests', JSON.stringify(STORE.tests));
                localStorage.setItem('exam_results', JSON.stringify(STORE.results));
                localStorage.setItem('exam_settings', JSON.stringify(STORE.settings));
            }

            loadDB();

            // ---------- GLOBAL STATE ----------
            let currentUser = null;               // { id, email, role... }
            let currentTestTaking = null;          // test object in progress
            let currentAnswers = {};                // { questionIndex: selectedOptionIndex }
            let currentQuestionIndex = 0;
            let timerInterval = null;
            let timerSeconds = 0;
            let testStartTime = null;

            // helper
            function showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(`screen-${id}`).classList.add('active');
                if(id === 'user-dashboard' && currentUser) {
                    document.getElementById('dashboard-user-name').innerText = currentUser.name || currentUser.email;
                    loadMyTests();
                }
                if(id === 'admin-dashboard') adminListUsers();
            }

            window.showScreen = showScreen;

            // toast
            function toast(msg, type='success') {
                let t = document.getElementById('toast');
                t.querySelector('span').innerText = msg;
                t.style.borderLeftColor = type==='error'?'var(--danger)':'var(--success)';
                t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'),3000);
            }
            window.toast = toast;

            // toggle theme
            window.toggleTheme = function() {
                document.body.classList.toggle('light');
                STORE.settings.theme = document.body.classList.contains('light') ? 'light' : 'dark';
                saveDB();
            }
            if(STORE.settings.theme==='light') document.body.classList.add('light');

            // ---------- AUTH ----------
            window.userRegister = function() {
                let name = document.getElementById('reg-name').value.trim();
                let email = document.getElementById('reg-email').value.trim();
                let pass = document.getElementById('reg-pass').value.trim();
                if(!email || !pass) return toast('Email v…ô ≈üifr…ô daxil edin','error');
                if(STORE.users.find(u=>u.email===email)) return toast('Bu email artƒ±q var','error');
                let newUser = {
                    id: 'u'+Date.now()+Math.random(),
                    name: name || email.split('@')[0],
                    email, password: pass, role: 'user',
                    avatar: 'üë§', createdAt: Date.now()
                };
                STORE.users.push(newUser);
                saveDB();
                toast('Qeydiyyat uƒüurlu!');
                showScreen('user-login');
            };

            window.userLogin = function() {
                let email = document.getElementById('login-email').value.trim();
                let pass = document.getElementById('login-pass').value.trim();
                let user = STORE.users.find(u=>u.email===email && u.password===pass && u.role!=='admin');
                if(user) {
                    currentUser = user;
                    toast('Xo≈ü g…ôldiniz');
                    showScreen('user-dashboard');
                } else toast('Email v…ô ya ≈üifr…ô yanlƒ±≈ü','error');
            };

            window.adminLogin = function() {
                let u = document.getElementById('admin-username').value;
                let p = document.getElementById('admin-password').value;
                let admin = STORE.users.find(us=>us.role==='admin' && us.password===p && us.email===u);
                if(!admin && u==='cesi' && p==='cesi123') { // fallback
                    admin = STORE.users.find(us=>us.role==='admin');
                }
                if(admin) { currentUser = admin; showScreen('admin-dashboard'); toast('Admin giri≈üi'); }
                else toast('Admin kredensiallarƒ± s…ôhv','error');
            };

            window.logout = function() {
                currentUser = null; showScreen('entry');
                if(timerInterval) clearInterval(timerInterval);
            };

            // profile edit
            window.showEditProfile = function() {
                document.getElementById('edit-name').value = currentUser.name || '';
                document.getElementById('edit-email').value = currentUser.email || '';
                document.getElementById('edit-avatar').value = currentUser.avatar || '';
                showScreen('edit-profile');
            };
            window.saveProfile = function() {
                let name = document.getElementById('edit-name').value.trim();
                let email = document.getElementById('edit-email').value.trim();
                let pass = document.getElementById('edit-pass').value.trim();
                let avatar = document.getElementById('edit-avatar').value.trim();
                if(email && email !== currentUser.email) {
                    if(STORE.users.find(u=>u.email===email && u.id!==currentUser.id)) 
                        return toast('Email istifad…ô olunur','error');
                    currentUser.email = email;
                }
                if(name) currentUser.name = name;
                if(pass) currentUser.password = pass;
                if(avatar) currentUser.avatar = avatar;
                saveDB();
                toast('Profil yenil…ôndi');
                showScreen('user-dashboard');
            };

            // ---------- TEST CREATION ----------
            window.createTest = function() {
                if(!currentUser) return toast('Daxil olun','error');
                let title = document.getElementById('test-title').value.trim() || 'Adsƒ±z test';
                let cat = document.getElementById('test-category').value.trim() || '√ºmumi';
                let diff = document.getElementById('test-difficulty').value;
                let timer = parseInt(document.getElementById('test-timer').value) || 10;
                let shuffle = document.getElementById('test-shuffle').checked;
                let isPublic = document.getElementById('test-public').checked;
                let pwd = document.getElementById('test-password').value;
                let maxAttempts = parseInt(document.getElementById('test-max-attempts').value) || 0;
                let jsonStr = document.getElementById('test-json').value.trim();
                let questions;
                try { questions = JSON.parse(jsonStr); }
                catch(e) { return toast('JSON formatƒ± s…ôhvdir: '+e.message,'error'); }
                if(!Array.isArray(questions) || questions.length===0) return toast('Suallar bo≈ü ola bilm…ôz','error');
                // basic validation
                for(let q of questions) {
                    if(!q.q || !Array.isArray(q.o) || q.a===undefined) 
                        return toast('H…ôr sualda q, o (array) v…ô a (index) olmalƒ±dƒ±r','error');
                }
                let testId = 'test_'+Date.now()+'_'+Math.random().toString(36).substr(2,6);
                let newTest = {
                    id: testId,
                    title, category: cat, difficulty: diff, timer, shuffle, isPublic, password: pwd, maxAttempts,
                    createdBy: currentUser.id,
                    createdAt: Date.now(),
                    questions: questions
                };
                STORE.tests.push(newTest);
                saveDB();
                // show share screen
                let link = `${window.location.origin}${window.location.pathname}?test=${testId}`;
                document.getElementById('share-link').value = link;
                let qrDiv = document.getElementById('qr-code-container');
                qrDiv.innerHTML = '';
                let qr = qrcode(0, 'M');
                qr.addData(link);
                qr.make();
                let img = qr.createImgTag(4);
                qrDiv.innerHTML = img;
                document.getElementById('whatsapp-share').href = `https://wa.me/?text=${encodeURIComponent(link)}`;
                document.getElementById('telegram-share').href = `https://t.me/share/url?url=${encodeURIComponent(link)}`;
                showScreen('test-share');
            };

            window.copyShareLink = function() {
                let link = document.getElementById('share-link');
                link.select();
                document.execCommand('copy');
                toast('Link kopyalandƒ±');
            };

            window.previewTestJson = function() {
                try {
                    let js = JSON.parse(document.getElementById('test-json').value);
                    document.getElementById('json-preview').innerHTML = '<strong>' + js.length + ' sual tapƒ±ldƒ±</strong><pre>' + JSON.stringify(js[0],null,2) + '</pre>';
                } catch (e) { document.getElementById('json-preview').innerHTML = '<span style="color:var(--danger)">JSON x…ôtasƒ±</span>'; }
            };

            // load my tests
            window.loadMyTests = function() {
                if(!currentUser) return;
                let my = STORE.tests.filter(t=>t.createdBy === currentUser.id);
                let html = '<h3>M…ônim testl…ôrim</h3><ul>';
                my.forEach(t=> html += `<li><b>${t.title}</b> (${t.questions.length} sual) <button class="btn-outline" onclick="deleteTest('${t.id}')"><i class="fas fa-trash"></i></button> <button class="btn-outline" onclick="shareTest('${t.id}')"><i class="fas fa-share"></i></button></li>`);
                html += '</ul>';
                document.getElementById('user-tests-list').innerHTML = html;
            };

            window.deleteTest = function(testId) {
                if(!currentUser) return;
                STORE.tests = STORE.tests.filter(t=>!(t.id===testId && t.createdBy===currentUser.id));
                saveDB();
                loadMyTests();
                toast('Test silindi');
            };

            window.shareTest = function(testId) {
                let test = STORE.tests.find(t=>t.id===testId);
                if(!test) return;
                let link = `${window.location.origin}${window.location.pathname}?test=${testId}`;
                document.getElementById('share-link').value = link;
                let qrDiv = document.getElementById('qr-code-container');
                qrDiv.innerHTML = '';
                let qr = qrcode(0, 'M');
                qr.addData(link);
                qr.make();
                qrDiv.innerHTML = qr.createImgTag(4);
                document.getElementById('whatsapp-share').href = `https://wa.me/?text=${encodeURIComponent(link)}`;
                document.getElementById('telegram-share').href = `https://t.me/share/url?url=${encodeURIComponent(link)}`;
                showScreen('test-share');
            };

            // ---------- GUEST / TEST TAKING via URL ----------
            function getTestFromUrl() {
                let params = new URLSearchParams(window.location.search);
                let testId = params.get('test');
                if(testId) {
                    let test = STORE.tests.find(t=>t.id===testId);
                    if(test) {
                        startTest(test, true); // guest mode
                    } else toast('Test tapƒ±lmadƒ±','error');
                }
            }
            window.guestTakeTest = function() {
                let link = prompt('Test linkini daxil edin:');
                if(!link) return;
                try {
                    let url = new URL(link);
                    let testId = url.searchParams.get('test');
                    if(testId) {
                        let test = STORE.tests.find(t=>t.id===testId);
                        if(test) startTest(test, true);
                        else toast('Test yoxdur','error');
                    } else toast('Linkd…ô test kodu yoxdur','error');
                } catch { toast('D√ºzg√ºn link daxil edin','error'); }
            };

            function startTest(test, guestMode = true) {
                if(timerInterval) clearInterval(timerInterval);
                currentTestTaking = JSON.parse(JSON.stringify(test)); // clone
                if(currentTestTaking.shuffle) {
                    // shuffle options for each question? placeholder
                }
                currentAnswers = {};
                currentQuestionIndex = 0;
                timerSeconds = (currentTestTaking.timer || 10) * 60;
                testStartTime = Date.now();
                document.getElementById('take-test-title').innerText = currentTestTaking.title;
                renderTakeQuestion();
                startTimer();
                showScreen('test-take');
            }

            function renderTakeQuestion() {
                let q = currentTestTaking.questions[currentQuestionIndex];
                document.getElementById('take-question-text').innerText = q.q;
                let optsHtml = '';
                q.o.forEach((opt, idx) => {
                    let sel = currentAnswers[currentQuestionIndex] === idx ? 'selected' : '';
                    optsHtml += `<div class="option ${sel}" onclick="selectTakeOption(${idx})">${opt}</div>`;
                });
                document.getElementById('take-options').innerHTML = optsHtml;
                document.getElementById('take-progress').style.width = ((currentQuestionIndex+1)/currentTestTaking.questions.length*100)+'%';
                // next/prev button text
                document.getElementById('nextBtn').innerText = (currentQuestionIndex === currentTestTaking.questions.length-1) ? 'Bitir' : 'N√∂vb…ôti';
            }

            window.selectTakeOption = function(idx) {
                currentAnswers[currentQuestionIndex] = idx;
                renderTakeQuestion();
            };

            window.takeNext = function() {
                if(currentQuestionIndex < currentTestTaking.questions.length-1) {
                    currentQuestionIndex++;
                    renderTakeQuestion();
                } else {
                    submitTest();
                }
            };
            window.takePrev = function() {
                if(currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    renderTakeQuestion();
                }
            };

            function startTimer() {
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if(timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        submitTest();
                        return;
                    }
                    timerSeconds--;
                    let m = Math.floor(timerSeconds/60).toString().padStart(2,'0');
                    let s = (timerSeconds%60).toString().padStart(2,'0');
                    document.getElementById('take-timer').innerText = `${m}:${s}`;
                },1000);
            }

            window.submitTest = function() {
                clearInterval(timerInterval);
                // calculate result
                let correct = 0;
                currentTestTaking.questions.forEach((q, idx) => {
                    if(currentAnswers[idx] === q.a) correct++;
                });
                let total = currentTestTaking.questions.length;
                let wrong = total - correct;
                let score = Math.round((correct/total)*100);
                // save result
                let result = {
                    id: 'res_'+Date.now(),
                    testId: currentTestTaking.id,
                    userId: currentUser ? currentUser.id : 'guest_'+Date.now(),
                    answers: currentAnswers,
                    score, correct, wrong,
                    completedAt: Date.now(),
                    timeSpent: (currentTestTaking.timer*60) - timerSeconds
                };
                STORE.results.push(result);
                saveDB();

                // show review
                document.getElementById('review-score').innerText = score+'%';
                document.getElementById('review-correct').innerText = correct;
                document.getElementById('review-wrong').innerText = wrong;
                let detail = '';
                currentTestTaking.questions.forEach((q, i) => {
                    let userAns = currentAnswers[i] ?? -1;
                    let status = userAns === q.a ? '‚úÖ' : (userAns === -1 ? '‚ö†Ô∏è bo≈ü' : '‚ùå');
                    detail += `<div style="border-bottom:1px solid var(--border); padding:0.5rem;"><b>${i+1}. ${q.q}</b> ${status} <br> Cavabƒ±nƒ±z: ${userAns!==-1?q.o[userAns]:'bo≈ü'} | D√ºzg√ºn: ${q.o[q.a]}</div>`;
                });
                document.getElementById('review-detail').innerHTML = detail;
                if(score === 100) confetti({particleCount:100, spread:70, origin:{y:0.6}});
                showScreen('test-review');
            };

            // ---------- ADMIN functions ----------
            window.adminListUsers = function() {
                let html = '<h3>ƒ∞stifad…ô√ßil…ôr</h3><ul>';
                STORE.users.forEach(u => {
                    html += `<li>${u.avatar || 'üë§'} ${u.name || u.email} (${u.role}) <button class="btn-outline" onclick="adminDeleteUser('${u.id}')"><i class="fas fa-ban"></i> sil/ban</button></li>`;
                });
                html += '</ul>';
                document.getElementById('admin-content').innerHTML = html;
            };
            window.adminDeleteUser = function(id) {
                if(currentUser && currentUser.id === id) return toast('√ñz√ºn√ºz√º sil…ô bilm…ôzsiniz','error');
                STORE.users = STORE.users.filter(u=>u.id!==id);
                saveDB();
                adminListUsers();
                toast('ƒ∞stifad…ô√ßi silindi');
            };
            window.adminListTests = function() {
                let html = '<h3>B√ºt√ºn testl…ôr</h3><ul>';
                STORE.tests.forEach(t => {
                    html += `<li>${t.title} (${t.questions.length} sual) - yaradan: ${STORE.users.find(u=>u.id===t.createdBy)?.email||'?'} <button class="btn-outline" onclick="adminDeleteTest('${t.id}')">sil</button></li>`;
                });
                html += '</ul>';
                document.getElementById('admin-content').innerHTML = html;
            };
            window.adminDeleteTest = function(id) {
                STORE.tests = STORE.tests.filter(t=>t.id!==id);
                saveDB();
                adminListTests();
            };
            window.exportData = function() {
                let data = { users: STORE.users, tests: STORE.tests, results: STORE.results };
                let blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
                let a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'exam_backup.json';
                a.click();
            };
            window.importData = function() {
                let input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    let file = e.target.files[0];
                    let reader = new FileReader();
                    reader.onload = ee => {
                        try {
                            let j = JSON.parse(ee.target.result);
                            if(j.users) STORE.users = j.users;
                            if(j.tests) STORE.tests = j.tests;
                            if(j.results) STORE.results = j.results;
                            saveDB();
                            toast('M…ôlumatlar import edildi');
                        } catch(ex) { toast('X…ôta','error'); }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            // on load, check url test param
            getTestFromUrl();
        })();
    </script>
</body>
</html>