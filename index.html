<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-CYBER cesi | Next-Gen Anonim Chat</title>
    
    <meta name="description" content="cesi ilə pulsuz online chat edin. Futuristik və anonim söhbət platforması.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --neon-cyan: #00f3ff;
            --neon-magenta: #bc13fe;
            --dark-core: #050505;
            --glass: rgba(255, 255, 255, 0.03);
        }

        body {
            background-color: var(--dark-core);
            color: #e0e0e0;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        /* Cyber UI Elements */
        .cyber-panel {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .neon-text {
            text-shadow: 0 0 10px var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .neon-border {
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }

        /* Message Bubbles */
        .msg-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 15px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.4;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 95% 100%, 0 100%);
        }

        .msg-sent {
            background: linear-gradient(135deg, #005f73, #0a9396);
            align-self: flex-end;
            border-right: 3px solid var(--neon-cyan);
        }

        .msg-received {
            background: rgba(255, 255, 255, 0.07);
            align-self: flex-start;
            border-left: 3px solid var(--neon-magenta);
        }

        /* Animations */
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }

        .scanner::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: var(--neon-cyan);
            box-shadow: 0 0 15px var(--neon-cyan);
            animation: scan 2s linear infinite;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--neon-cyan); border-radius: 10px; }

        .loading-spin {
            border-top-color: var(--neon-cyan);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col">

    <div id="boot-screen" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center font-mono p-4">
        <div id="boot-log" class="text-cyan-500 text-sm mb-6 w-full max-w-md"></div>
        <div class="w-64 h-1 bg-gray-900 rounded-full overflow-hidden">
            <div id="boot-bar" class="h-full bg-cyan-400 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <header class="h-20 cyber-panel flex items-center justify-between px-6 z-10 border-b border-cyan-500/20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 neon-border rounded rotate-45 flex items-center justify-center bg-cyan-500/10">
                <i class="fas fa-atom text-cyan-400 -rotate-45"></i>
            </div>
            <h1 class="text-2xl font-bold orbitron tracking-tighter">CESI <span class="text-cyan-400">X-CYBER</span></h1>
        </div>

        <div class="flex items-center gap-4">
            <div id="lang-selector" class="flex bg-white/5 rounded-lg p-1 border border-white/10">
                <button onclick="changeLang('az')" id="btn-az" class="px-3 py-1 text-xs rounded transition-all">AZ</button>
                <button onclick="changeLang('tr')" id="btn-tr" class="px-3 py-1 text-xs rounded transition-all">TR</button>
            </div>
        </div>
    </header>

    <main class="flex-1 relative flex flex-col overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        
        <div id="start-screen" class="absolute inset-0 z-20 flex items-center justify-center p-6 bg-black/60 backdrop-blur-md">
            <div class="w-full max-w-md cyber-panel p-8 rounded-2xl border-t-2 border-cyan-500">
                <h2 class="text-3xl font-bold mb-2 orbitron neon-text text-center" id="ui-welcome">XƏTTƏ XOŞ GƏLDİNİZ</h2>
                <p class="text-gray-400 text-center text-sm mb-8" id="ui-desc">Sənin anonimliyini biz qoruyuruq.</p>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-xs uppercase tracking-widest text-cyan-500 mb-2 font-bold" id="ui-label-name">Kod Adın</label>
                        <input type="text" id="user-name-input" maxlength="15" placeholder="Məs: Ghost_99" 
                               class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-cyan-500 transition-all text-white">
                    </div>
                    
                    <button onclick="handleStart()" class="w-full py-4 bg-cyan-600 hover:bg-cyan-400 text-black font-bold rounded-xl transition-all flex items-center justify-center gap-3 orbitron shadow-[0_0_20px_rgba(0,243,255,0.4)]">
                        <i class="fas fa-bolt"></i> <span id="ui-btn-start">SİSTEMƏ DAXİL OL</span>
                    </button>

                    <div class="bg-yellow-500/10 border border-yellow-500/30 p-3 rounded-lg flex gap-3 items-start">
                        <i class="fas fa-shield-halved text-yellow-500 mt-1"></i>
                        <p class="text-[11px] text-yellow-200/70" id="ui-warning">XƏBƏRDARLIQ: Mesajlar heç bir serverdə saxlanılmır. Pəncərəni bağladığınız an məlumatlar məhv edilir.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="matching-screen" class="hidden absolute inset-0 z-30 flex items-center justify-center bg-black/80 backdrop-blur-xl">
            <div class="text-center relative p-20">
                <div class="w-48 h-48 border-2 border-cyan-500/30 rounded-full flex items-center justify-center scanner">
                    <div class="w-40 h-40 border border-cyan-500/50 rounded-full flex items-center justify-center animate-pulse">
                        <i class="fas fa-satellite-dish text-5xl text-cyan-400"></i>
                    </div>
                </div>
                <h3 class="mt-8 text-2xl font-bold orbitron animate-pulse" id="ui-matching">SİQNAL AXTARILIR...</h3>
                <p id="countdown-text" class="text-cyan-500 mt-2 font-mono">NODE: 0.0.0.0</p>
                <button onclick="handleCancelMatching()" class="mt-10 text-xs text-red-500 hover:underline tracking-widest uppercase font-bold" id="ui-btn-cancel">Ləğv et</button>
            </div>
        </div>

        <div id="chat-screen" class="hidden h-full flex flex-col">
            <div class="p-4 cyber-panel border-b border-white/10 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-lg neon-border bg-cyan-500/20 flex items-center justify-center">
                        <i class="fas fa-user-secret text-2xl text-cyan-400"></i>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <h2 id="partner-name" class="font-bold text-lg orbitron">Nəfər...</h2>
                            <span id="partner-lang-tag" class="text-[10px] bg-cyan-500/20 text-cyan-400 px-2 rounded">AZ</span>
                        </div>
                        <div id="partner-status" class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_5px_#22c55e]"></span>
                            <span class="text-xs text-green-500 uppercase font-bold tracking-widest" id="ui-active">AKTİV SİQNAL</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="handleChangeChat()" class="p-3 bg-white/5 hover:bg-white/10 rounded-lg text-cyan-400" title="Dəyiş">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button onclick="handleCloseChat()" class="p-3 bg-red-500/10 hover:bg-red-500/20 rounded-lg text-red-500" title="Bağla">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 custom-scrollbar">
                </div>

            <div id="typing-indicator" class="px-6 py-2 opacity-0 transition-opacity">
                <p class="text-[10px] text-cyan-500 italic"><span id="partner-name-typing">...</span> yazır...</p>
            </div>

            <div class="p-6 bg-black/40 border-t border-white/5">
                <div class="flex gap-4 items-center max-w-5xl mx-auto">
                    <input type="text" id="message-input" placeholder="Şifrəli mesaj yaz..." 
                           class="flex-1 bg-white/5 border border-white/10 rounded-2xl p-4 outline-none focus:ring-2 focus:ring-cyan-500 transition-all">
                    <button onclick="sendMessage()" class="w-14 h-14 bg-cyan-600 hover:bg-cyan-400 text-black rounded-2xl shadow-[0_0_15px_rgba(0,243,255,0.3)] transition-all flex items-center justify-center">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, runTransaction, deleteDoc, serverTimestamp, arrayUnion, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG (Sənin verdiyin)
        const firebaseConfig = {
            apiKey: "AIzaSyAAbLWwzSE9WgqFKK_n9hqsl5mokZlNacM",
            authDomain: "cesibot.firebaseapp.com",
            projectId: "cesibot",
            storageBucket: "cesibot.firebasestorage.app",
            messagingSenderId: "509543495829",
            appId: "1:509543495829:web:833feb9c271328f8e4039c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId, userName, chatId, partnerId, currentLang = 'az';
        let unsubscribeChat = null;

        const TRANSLATIONS = {
            az: {
                welcome: "XƏTTƏ XOŞ GƏLDİNİZ", desc: "Sənin anonimliyini biz qoruyuruq.",
                l_name: "Kod Adın", btn_start: "SİSTEMƏ DAXİL OL", matching: "SİQNAL AXTARILIR...",
                cancel: "Ləğv et", active: "AKTİV SİQNAL", placeholder: "Şifrəli mesaj yaz...",
                left: "❌ Tərəfdaş xətdən qırıldı."
            },
            tr: {
                welcome: "HATTA HOŞ GELDİNİZ", desc: "Anonimliğiniz bizimle güvende.",
                l_name: "Kod Adın", btn_start: "SİSTEME GİRİŞ YAP", matching: "SİNYAL ARANIYOR...",
                cancel: "İptal et", active: "AKTİF SİNYAL", placeholder: "Şifreli mesaj yaz...",
                left: "❌ Partner bağlantısı kesildi."
            }
        };

        // UI Language Switcher
        window.changeLang = (lang) => {
            currentLang = lang;
            document.getElementById('btn-az').className = lang === 'az' ? 'px-3 py-1 text-xs rounded bg-cyan-500 text-black' : 'px-3 py-1 text-xs rounded text-white';
            document.getElementById('btn-tr').className = lang === 'tr' ? 'px-3 py-1 text-xs rounded bg-cyan-500 text-black' : 'px-3 py-1 text-xs rounded text-white';
            
            const t = TRANSLATIONS[lang];
            document.getElementById('ui-welcome').innerText = t.welcome;
            document.getElementById('ui-desc').innerText = t.desc;
            document.getElementById('ui-label-name').innerText = t.l_name;
            document.getElementById('ui-btn-start').innerText = t.btn_start;
            document.getElementById('ui-matching').innerText = t.matching;
            document.getElementById('ui-btn-cancel').innerText = t.cancel;
            document.getElementById('ui-active').innerText = t.active;
            document.getElementById('message-input').placeholder = t.placeholder;
        };

        // Boot Animation
        window.onload = () => {
            changeLang('az');
            const log = document.getElementById('boot-log');
            const bar = document.getElementById('boot-bar');
            const lines = ["> INITIALIZING CORE...", "> ENCRYPTING PROTOCOLS...", "> CONNECTING TO CESI NODES...", "> SYSTEM SECURED."];
            let i = 0;
            const interval = setInterval(() => {
                log.innerHTML += lines[i] + "<br>";
                i++;
                bar.style.width = (i/lines.length)*100 + "%";
                if(i >= lines.length) {
                    clearInterval(interval);
                    setTimeout(() => document.getElementById('boot-screen').fadeOut(), 500);
                }
            }, 500);
        };

        Element.prototype.fadeOut = function() {
            this.style.opacity = '0';
            this.style.transition = 'opacity 0.5s';
            setTimeout(() => this.remove(), 500);
        };

        // Authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) userId = user.uid;
            else await signInAnonymously(auth);
        });

        // Start Process
        window.handleStart = async () => {
            if(!userId) return;
            const inputName = document.getElementById('user-name-input').value.trim();
            userName = inputName || "User_" + userId.substring(0,4);
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('matching-screen').classList.remove('hidden');
            startMatching();
        };

        async function startMatching() {
            const queueRef = doc(db, "match_queue", "global");
            
            try {
                await runTransaction(db, async (transaction) => {
                    const snap = await transaction.get(queueRef);
                    const data = snap.exists() ? snap.data() : {};

                    if (data.waitingId && data.waitingId !== userId) {
                        // MATCH FOUND
                        partnerId = data.waitingId;
                        chatId = "chat_" + Date.now();
                        
                        const chatData = {
                            users: [userId, partnerId],
                            names: { [userId]: userName, [partnerId]: data.waitingName },
                            langs: { [userId]: currentLang, [partnerId]: data.waitingLang },
                            messages: [],
                            typing: { [userId]: false, [partnerId]: false },
                            status: "active"
                        };

                        transaction.set(doc(db, "active_chats", chatId), chatData);
                        transaction.update(queueRef, { waitingId: null });
                        
                        // Notify partner
                        transaction.set(doc(db, "signals", partnerId), { chatId: chatId, partnerId: userId });
                        
                        enterChat(chatId, partnerId, data.waitingName, data.waitingLang);
                    } else {
                        // WAIT IN QUEUE
                        transaction.set(queueRef, { 
                            waitingId: userId, 
                            waitingName: userName, 
                            waitingLang: currentLang 
                        });
                        listenForSignal();
                    }
                });
            } catch (e) { console.error(e); }
        }

        function listenForSignal() {
            const signalRef = doc(db, "signals", userId);
            const unsub = onSnapshot(signalRef, async (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    const chatSnap = await getDoc(doc(db, "active_chats", data.chatId));
                    const chatData = chatSnap.data();
                    unsub();
                    enterChat(data.chatId, data.partnerId, chatData.names[data.partnerId], chatData.langs[data.partnerId]);
                    deleteDoc(signalRef);
                }
            });
        }

        function enterChat(id, pId, pName, pLang) {
            chatId = id; partnerId = pId;
            document.getElementById('matching-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('partner-name').innerText = pName;
            document.getElementById('partner-lang-tag').innerText = pLang.toUpperCase();
            document.getElementById('partner-name-typing').innerText = pName;
            setupChatListener();
        }

        function setupChatListener() {
            if(unsubscribeChat) unsubscribeChat();
            const chatRef = doc(db, "active_chats", chatId);
            
            unsubscribeChat = onSnapshot(chatRef, (snap) => {
                if(!snap.exists()) {
                    handlePartnerLeft();
                    return;
                }
                const data = snap.data();
                renderMessages(data.messages);
                
                // Typing indicator
                const isTyping = data.typing[partnerId];
                document.getElementById('typing-indicator').style.opacity = isTyping ? '1' : '0';
            });
        }

        function renderMessages(msgs) {
            const container = document.getElementById('chat-messages');
            const currentCount = container.children.length;
            
            if(msgs.length > currentCount) {
                for(let i = currentCount; i < msgs.length; i++) {
                    const m = msgs[i];
                    const div = document.createElement('div');
                    div.className = `msg-bubble animate__animated animate__fadeInUp ${m.sender === userId ? 'msg-sent' : 'msg-received'}`;
                    div.innerHTML = `<p>${m.text}</p><span class="text-[9px] opacity-40 block text-right mt-1">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
                    container.appendChild(div);
                }
                container.scrollTop = container.scrollHeight;
            }
        }

        window.sendMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text || !chatId) return;

            input.value = '';
            const chatRef = doc(db, "active_chats", chatId);
            await updateDoc(chatRef, {
                messages: arrayUnion({
                    sender: userId,
                    text: text,
                    time: Date.now()
                })
            });
        };

        // Typing Status
        document.getElementById('message-input').oninput = async (e) => {
            if(!chatId) return;
            const chatRef = doc(db, "active_chats", chatId);
            await updateDoc(chatRef, { [`typing.${userId}`]: e.target.value.length > 0 });
            
            clearTimeout(window.typingTimer);
            window.typingTimer = setTimeout(async () => {
                await updateDoc(chatRef, { [`typing.${userId}`]: false });
            }, 3000);
        };

        window.handleCloseChat = async () => {
            if(chatId) {
                await deleteDoc(doc(db, "active_chats", chatId));
                location.reload();
            }
        };

        function handlePartnerLeft() {
            Swal.fire({
                title: 'SİQNAL İTDİ',
                text: TRANSLATIONS[currentLang].left,
                icon: 'error',
                background: '#050505',
                color: '#fff',
                confirmButtonColor: '#00f3ff'
            }).then(() => location.reload());
        }

        window.handleChangeChat = () => handleCloseChat();
        window.handleCancelMatching = () => location.reload();
        
        // Enter key for message
        document.getElementById('message-input').onkeydown = (e) => { if(e.key === 'Enter') sendMessage(); };
    </script>
</body>
</html>
