<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AxtarGet Chat — Anonim Online Chat Platforması</title>
    <meta name="description" content="AxtarGet ilə pulsuz online chat edin. Yeni insanlarla tanış olun. Heç bir qeydiyyat yoxdur.">
    <link rel="canonical" href="https://axtarget.com/">

    <!-- Google Fonts: Outfit + Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- =============================================
         GLOBAL STYLES — Glassmorphism 2.0
    ============================================= -->
    <style>
        /* ---- CSS Reset & Variables ---- */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark:        #060a14;
            --glass-bg:       rgba(255,255,255,0.05);
            --glass-border:   rgba(255,255,255,0.12);
            --glass-blur:     blur(24px);
            --accent:         #38bdf8;
            --accent-glow:    rgba(56,189,248,0.25);
            --accent2:        #818cf8;
            --accent2-glow:   rgba(129,140,248,0.20);
            --success:        #34d399;
            --danger:         #f87171;
            --warning:        #fbbf24;
            --text-primary:   #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted:     #475569;
            --radius-lg:      20px;
            --radius-md:      14px;
            --radius-sm:      8px;
            --shadow-glow:    0 0 40px rgba(56,189,248,0.12);
            --transition:     all 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        html, body {
            height: 100%;
            width: 100%;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Outfit', 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* ---- Animated Mesh Gradient Background ---- */
        /* Bu arxa fon — hərəkət edən neon duman effektidir */
        #bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .mesh-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: orbFloat linear infinite;
        }

        .orb1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #0ea5e9 0%, transparent 70%);
            top: -20%;
            left: -10%;
            animation-duration: 18s;
            animation-delay: 0s;
        }

        .orb2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #818cf8 0%, transparent 70%);
            top: 30%;
            right: -10%;
            animation-duration: 22s;
            animation-delay: -5s;
        }

        .orb3 {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, #06b6d4 0%, transparent 70%);
            bottom: -10%;
            left: 30%;
            animation-duration: 25s;
            animation-delay: -10s;
        }

        .orb4 {
            width: 280px;
            height: 280px;
            background: radial-gradient(circle, #a78bfa 0%, transparent 70%);
            top: 60%;
            left: -5%;
            animation-duration: 20s;
            animation-delay: -3s;
        }

        @keyframes orbFloat {
            0%   { transform: translate(0px, 0px) rotate(0deg) scale(1); }
            25%  { transform: translate(40px, -30px) rotate(90deg) scale(1.1); }
            50%  { transform: translate(-20px, 50px) rotate(180deg) scale(0.9); }
            75%  { transform: translate(-40px, -20px) rotate(270deg) scale(1.05); }
            100% { transform: translate(0px, 0px) rotate(360deg) scale(1); }
        }

        /* Noise texture overlay for depth */
        #bg-canvas::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.4;
            pointer-events: none;
        }

        /* ---- App Shell ---- */
        #app {
            position: relative;
            z-index: 1;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        /* ---- Glassmorphism Card ---- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
        }

        .glass-strong {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3), var(--shadow-glow);
        }

        /* ---- Gradient Text ---- */
        .gradient-text {
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 50%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ---- Screens ---- */
        .screen {
            display: none;
            width: 100%;
            max-width: 520px;
            animation: screenFade 0.4s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes screenFade {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ---- Buttons ---- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(14,165,233,0.30);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(14,165,233,0.45);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-ghost {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: rgba(255,255,255,0.10);
            color: var(--text-primary);
        }

        .btn-danger {
            background: rgba(248,113,113,0.15);
            border: 1px solid rgba(248,113,113,0.3);
            color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(248,113,113,0.25);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
        }

        /* ---- Input ---- */
        .input-field {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            outline: none;
            transition: var(--transition);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56,189,248,0.15);
        }

        /* ---- START SCREEN ---- */
        #start-screen {
            text-align: center;
        }

        .logo-wrap {
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 8px 32px rgba(14,165,233,0.3);
            animation: logoPulse 3s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { box-shadow: 0 8px 32px rgba(14,165,233,0.3); }
            50%       { box-shadow: 0 8px 48px rgba(99,102,241,0.5); }
        }

        .logo-title {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .logo-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .start-card {
            padding: 28px;
            text-align: left;
        }

        .alert-box {
            padding: 14px;
            background: rgba(251,191,36,0.08);
            border: 1px solid rgba(251,191,36,0.25);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: #fcd34d;
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
        }

        .input-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .input-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .start-footer {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 16px;
            line-height: 1.6;
        }

        /* ---- LANGUAGE SELECTOR ---- */
        .lang-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .lang-btn-wrap {
            display: flex;
            gap: 6px;
        }

        .lang-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Outfit', sans-serif;
        }

        .lang-btn.active {
            background: rgba(56,189,248,0.15);
            border-color: rgba(56,189,248,0.4);
            color: var(--accent);
        }

        /* ---- MATCHING SCREEN ---- */
        .match-card {
            padding: 48px 32px;
            text-align: center;
        }

        .match-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 28px;
            position: relative;
        }

        .match-spinner::before,
        .match-spinner::after {
            content: '';
            position: absolute;
            border-radius: 50%;
        }

        .match-spinner::before {
            inset: 0;
            border: 3px solid rgba(56,189,248,0.15);
        }

        .match-spinner::after {
            inset: 0;
            border: 3px solid transparent;
            border-top-color: var(--accent);
            border-right-color: var(--accent2);
            animation: spinRing 1s linear infinite;
        }

        @keyframes spinRing {
            to { transform: rotate(360deg); }
        }

        .match-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .match-countdown {
            font-size: 15px;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 28px;
        }

        /* ---- CHAT SCREEN ---- */
        #chat-screen {
            max-width: 640px;
            height: 100dvh;
            display: none;
            flex-direction: column;
        }

        #chat-screen.active {
            display: flex;
        }

        /* Chat Header */
        .chat-header {
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-shrink: 0;
            margin-bottom: 8px;
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        /* Generative Avatar */
        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: #fff;
            position: relative;
        }

        .avatar::after {
            content: '';
            position: absolute;
            bottom: 1px;
            right: 1px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            border: 2px solid var(--bg-dark);
            transition: var(--transition);
        }

        .avatar.offline::after {
            background: var(--text-muted);
        }

        .partner-name {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .partner-status {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
            min-height: 16px;
        }

        .typing-dots {
            display: inline-flex;
            gap: 3px;
            align-items: center;
        }

        .typing-dot {
            width: 5px;
            height: 5px;
            background: var(--warning);
            border-radius: 50%;
            animation: dotBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-5px); opacity: 1; }
        }

        .chat-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* Messages Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* Message Bubbles */
        .msg-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 78%;
            position: relative;
            animation: msgSlide 0.25s ease;
        }

        @keyframes msgSlide {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg-wrapper.self {
            align-self: flex-end;
            align-items: flex-end;
        }

        .msg-wrapper.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .msg-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
            position: relative;
            cursor: default;
            transition: transform 0.1s;
        }

        .msg-bubble:active {
            transform: scale(0.98);
        }

        .msg-wrapper.self .msg-bubble {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #fff;
            border-bottom-right-radius: 5px;
        }

        .msg-wrapper.other .msg-bubble {
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            border-bottom-left-radius: 5px;
        }

        /* Emoji Reactions */
        .reaction-picker {
            position: absolute;
            bottom: calc(100% + 6px);
            background: rgba(20,20,40,0.95);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 6px 10px;
            display: none;
            gap: 6px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .msg-wrapper.self .reaction-picker {
            right: 0;
        }

        .msg-wrapper.other .reaction-picker {
            left: 0;
        }

        .reaction-picker.visible {
            display: flex;
            animation: reactionPop 0.2s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes reactionPop {
            from { opacity: 0; transform: scale(0.7) translateY(4px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .reaction-emoji {
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.15s;
            line-height: 1;
        }

        .reaction-emoji:hover {
            transform: scale(1.4);
        }

        .msg-reaction-display {
            margin-top: 3px;
            font-size: 16px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .reaction-badge {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .reaction-badge:hover {
            background: rgba(255,255,255,0.18);
        }

        /* Message Meta (time + ticks) */
        .msg-meta {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 3px;
            padding: 0 4px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .msg-ticks {
            font-size: 11px;
            color: var(--text-muted);
        }

        .msg-ticks.read {
            color: var(--accent);
        }

        /* Image message */
        .msg-image {
            max-width: 240px;
            max-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            object-fit: cover;
            display: block;
            transition: transform 0.2s;
        }

        .msg-image:hover {
            transform: scale(1.02);
        }

        /* System message */
        .msg-system {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            padding: 6px 16px;
            background: rgba(255,255,255,0.04);
            border-radius: 20px;
            align-self: center;
            max-width: 80%;
        }

        /* Voice message UI */
        .voice-msg {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition);
            flex-shrink: 0;
            color: #fff;
        }

        .voice-play-btn:hover {
            background: rgba(255,255,255,0.35);
        }

        .voice-waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 24px;
        }

        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.5);
            border-radius: 2px;
            transition: height 0.1s;
        }

        .voice-duration {
            font-size: 12px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        /* ---- CHAT INPUT AREA ---- */
        .chat-input-area {
            padding: 10px 12px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
            margin-top: 8px;
        }

        .chat-input-wrap {
            flex: 1;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            display: flex;
            align-items: center;
            padding: 6px 8px 6px 16px;
            gap: 8px;
            transition: var(--transition);
        }

        .chat-input-wrap:focus-within {
            border-color: rgba(56,189,248,0.4);
            box-shadow: 0 0 0 3px rgba(56,189,248,0.08);
        }

        #message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 120px;
            padding: 6px 0;
            line-height: 1.4;
        }

        #message-input::placeholder {
            color: var(--text-muted);
        }

        .input-action-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
            flex-shrink: 0;
            background: transparent;
            color: var(--text-muted);
        }

        .input-action-btn:hover {
            background: rgba(255,255,255,0.08);
            color: var(--text-primary);
        }

        .send-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(14,165,233,0.3);
        }

        .send-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px rgba(14,165,233,0.45);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* Voice recording UI */
        .voice-record-wrap {
            display: none;
            align-items: center;
            gap: 10px;
            flex: 1;
            padding: 0 8px;
        }

        .voice-record-wrap.active {
            display: flex;
        }

        .voice-record-indicator {
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            animation: recBlink 1s ease infinite;
            flex-shrink: 0;
        }

        @keyframes recBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        .voice-record-waves {
            display: flex;
            align-items: center;
            gap: 3px;
            flex: 1;
        }

        .voice-record-wave {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            animation: waveAnim 0.5s ease infinite alternate;
        }

        @keyframes waveAnim {
            from { height: 4px; }
            to   { height: 20px; }
        }

        .voice-record-time {
            font-size: 13px;
            font-weight: 600;
            color: var(--danger);
            min-width: 40px;
        }

        /* ---- MODALS ---- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.25s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .modal-card {
            width: 100%;
            max-width: 420px;
            padding: 28px;
            background: rgba(10,15,30,0.95);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: 0 24px 64px rgba(0,0,0,0.5);
            animation: modalSlide 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.12);
            color: var(--text-primary);
        }

        /* ---- FEEDBACK SCREEN ---- */
        .feedback-stars {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .star-btn {
            font-size: 32px;
            cursor: pointer;
            transition: transform 0.2s;
            opacity: 0.4;
            line-height: 1;
            background: none;
            border: none;
        }

        .star-btn.active {
            opacity: 1;
        }

        .star-btn:hover {
            transform: scale(1.3);
        }

        .feedback-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }

        .feedback-tag {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .feedback-tag.selected {
            border-color: var(--accent);
            background: rgba(56,189,248,0.1);
            color: var(--accent);
        }

        /* ---- LIGHTBOX ---- */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 900;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .lightbox.open {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .lightbox img {
            max-width: 92vw;
            max-height: 88vh;
            border-radius: var(--radius-md);
            box-shadow: 0 24px 64px rgba(0,0,0,0.6);
            animation: imgZoom 0.25s ease;
        }

        @keyframes imgZoom {
            from { transform: scale(0.85); }
            to   { transform: scale(1); }
        }

        .lightbox-close {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.25);
        }

        /* ---- TOAST NOTIFICATIONS ---- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            background: rgba(10,15,30,0.95);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            animation: toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
            backdrop-filter: blur(16px);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-16px) scale(0.9); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to   { opacity: 0; transform: translateY(-16px) scale(0.9); }
        }

        /* ---- CONFETTI ---- */
        .confetti-piece {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            z-index: 800;
            pointer-events: none;
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            0%   { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* ---- MATCH SHAKE ANIMATION ---- */
        @keyframes matchShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80%     { transform: translateX(6px); }
        }

        .shake {
            animation: matchShake 0.5s ease;
        }

        /* ---- TUTORIAL STEPS ---- */
        .tutorial-step {
            display: flex;
            gap: 14px;
            align-items: flex-start;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .tutorial-step:last-child {
            border-bottom: none;
        }

        .step-num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #fff;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .step-text h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-text p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ---- MISC ---- */
        .divider {
            height: 1px;
            background: var(--glass-border);
            margin: 20px 0;
        }

        /* Responsive for chat screen */
        @media (max-width: 640px) {
            #chat-screen {
                max-width: 100%;
            }

            .msg-wrapper {
                max-width: 88%;
            }
        }

        /* Safe area for mobile */
        .chat-input-area {
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        /* Loading animation overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 999;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        #loading-overlay.hide {
            opacity: 0;
            pointer-events: none;
        }

        /* =====================================================
           NEW: AUTH SCREEN — Login / Register / Anonim
        ===================================================== */
        #auth-screen {
            position: fixed;
            inset: 0;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: var(--bg-dark);
        }
        #auth-screen.hidden { display: none; }

        .auth-outer {
            position: relative;
            width: 100%;
            max-width: 420px;
        }
        /* Animated gradient border */
        .auth-outer::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: calc(var(--radius-lg) + 1px);
            background: linear-gradient(135deg, #0ea5e9, #6366f1, #a78bfa, #0ea5e9);
            background-size: 300% 300%;
            animation: gradBorder 4s linear infinite;
            z-index: -1;
            opacity: 0.6;
        }
        @keyframes gradBorder {
            0%   { background-position:   0% 50%; }
            50%  { background-position: 100% 50%; }
            100% { background-position:   0% 50%; }
        }
        .auth-card {
            padding: 36px 32px 28px;
            background: rgba(8,12,26,0.97);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(32px);
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 28px;
        }
        .auth-logo .logo-icon { margin: 0 auto 10px; }
        .auth-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            padding: 4px;
            border: 1px solid var(--glass-border);
        }
        .auth-tab {
            flex: 1;
            padding: 9px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 7px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            transition: var(--transition);
        }
        .auth-tab.active {
            background: linear-gradient(135deg,#0ea5e9,#6366f1);
            color: #fff;
        }
        .auth-form { display: none; }
        .auth-form.active { display: block; animation: screenFade .3s ease; }
        .auth-label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--text-muted);
            margin-bottom: 7px;
        }
        .auth-input-group { margin-bottom: 14px; }
        .auth-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 18px 0;
            color: var(--text-muted);
            font-size: 12px;
        }
        .auth-divider::before, .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--glass-border);
        }
        .btn-anon {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            transition: var(--transition);
        }
        .btn-anon:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        .auth-error {
            background: rgba(248,113,113,0.1);
            border: 1px solid rgba(248,113,113,0.3);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            font-size: 13px;
            color: var(--danger);
            margin-bottom: 14px;
            display: none;
        }
        .auth-error.visible { display: block; }

        /* =====================================================
           NEW: DISCORD SIDEBAR — Fixed left 72px
        ===================================================== */
        #discord-sidebar {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 72px;
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 4px;
            background: rgba(4,6,15,0.90);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border-right: 1px solid var(--glass-border);
        }
        body.logged-in #discord-sidebar { display: flex; }
        body.logged-in .lang-selector { left: 80px; right: auto; }
        body.logged-in #app { margin-left: 72px; }

        .sb-logo {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg,#0ea5e9,#6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 6px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(14,165,233,0.3);
            transition: var(--transition);
        }
        .sb-logo:hover { transform: scale(1.08); }
        .sb-sep {
            width: 34px;
            height: 1px;
            background: var(--glass-border);
            margin: 4px 0;
        }
        .sb-icon {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 21px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            background: transparent;
            position: relative;
            border: none;
            color: var(--text-muted);
        }
        .sb-icon:hover {
            border-radius: 16px;
            background: rgba(56,189,248,0.15);
            color: var(--text-primary);
        }
        .sb-icon.active {
            border-radius: 16px;
            background: linear-gradient(135deg,#0ea5e9,#6366f1);
            color: #fff;
        }
        .sb-badge {
            position: absolute;
            top: -3px; right: -3px;
            width: 18px; height: 18px;
            border-radius: 50%;
            background: var(--danger);
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #04060f;
            animation: badgePulse 2s ease infinite;
            display: none;
        }
        .sb-badge.show { display: flex; }
        @keyframes badgePulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(248,113,113,.4); }
            50%      { box-shadow: 0 0 0 5px rgba(248,113,113,0); }
        }
        .sb-tooltip {
            position: absolute;
            left: 56px;
            background: rgba(10,15,30,0.97);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity .2s;
            z-index: 999;
            color: var(--text-primary);
        }
        .sb-icon:hover .sb-tooltip { opacity: 1; }
        .sb-bottom {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding-top: 8px;
            border-top: 1px solid var(--glass-border);
            width: 100%;
        }
        .sb-user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        .sb-user-avatar:hover { transform: scale(1.1); }
        .sb-user-status {
            position: absolute;
            bottom: -1px; right: -1px;
            width: 11px; height: 11px;
            border-radius: 50%;
            border: 2px solid #04060f;
        }

        /* =====================================================
           NEW: FULL PANELS — Friends, DM, Profile
        ===================================================== */
        .dc-panel {
            position: fixed;
            top: 0; left: 72px; right: 0; bottom: 0;
            z-index: 20;
            display: none;
            flex-direction: row;
            background: rgba(6,10,20,0.97);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
        }
        .dc-panel.open { display: flex; animation: screenFade .25s ease; }

        /* Panel secondary sidebar (friends list, DM list) */
        .panel-sidebar {
            width: 240px;
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow: hidden;
        }
        .panel-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .panel-title {
            font-size: 17px;
            font-weight: 700;
            flex: 1;
        }
        .panel-close {
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition);
        }
        .panel-close:hover { background: rgba(255,255,255,0.12); color: #fff; }

        /* Friends tabs */
        .friends-tabs {
            display: flex;
            gap: 2px;
            padding: 12px 16px 0;
        }
        .f-tab {
            padding: 7px 14px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-muted);
            transition: var(--transition);
            font-family: 'Outfit', sans-serif;
            position: relative;
        }
        .f-tab.active { background: rgba(56,189,248,0.12); color: var(--accent); }
        .f-tab-badge {
            position: absolute;
            top: 2px; right: 4px;
            width: 16px; height: 16px;
            border-radius: 50%;
            background: var(--danger);
            font-size: 9px;
            font-weight: 700;
            color: #fff;
            display: none; align-items: center; justify-content: center;
        }
        .f-tab-badge.show { display: flex; }

        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.08) transparent;
        }
        .friends-list::-webkit-scrollbar { width: 4px; }
        .friends-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        .section-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            padding: 12px 8px 6px;
        }

        /* Friend card */
        .friend-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: var(--radius-md);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }
        .friend-card:hover { background: rgba(255,255,255,0.05); }
        .friend-info { flex: 1; min-width: 0; }
        .friend-name { font-size: 14px; font-weight: 600; }
        .friend-sub  { font-size: 12px; color: var(--text-muted); }
        .friend-actions {
            display: flex; gap: 5px;
            opacity: 0; transition: opacity .2s;
        }
        .friend-card:hover .friend-actions { opacity: 1; }
        .fa-btn {
            width: 30px; height: 30px;
            border-radius: 50%;
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: var(--transition);
        }
        .fa-btn.green  { background: rgba(52,211,153,.15); color: var(--success); }
        .fa-btn.green:hover  { background: rgba(52,211,153,.3); }
        .fa-btn.red    { background: rgba(248,113,113,.15); color: var(--danger); }
        .fa-btn.red:hover    { background: rgba(248,113,113,.3); }
        .fa-btn.blue   { background: rgba(56,189,248,.15); color: var(--accent); }
        .fa-btn.blue:hover   { background: rgba(56,189,248,.3); }

        /* Avatar sm */
        .av-sm {
            width: 38px; height: 38px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 15px; font-weight: 700; color: #fff;
            flex-shrink: 0; position: relative;
        }
        .av-sm .s-dot {
            position: absolute;
            bottom: 0; right: 0;
            width: 11px; height: 11px;
            border-radius: 50%;
            border: 2px solid #06091a;
        }
        .s-dot.online  { background: var(--success); }
        .s-dot.away    { background: var(--warning); }
        .s-dot.dnd     { background: var(--danger); }
        .s-dot.offline { background: var(--text-muted); }

        /* Add friend bar */
        .add-friend-bar {
            padding: 14px 16px;
            border-bottom: 1px solid var(--glass-border);
            display: flex; gap: 8px;
            flex-shrink: 0;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 52px 20px;
            color: var(--text-muted);
        }
        .empty-state .e-icon { font-size: 52px; margin-bottom: 14px; }
        .empty-state .e-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: var(--text-secondary); }
        .empty-state .e-text  { font-size: 13px; line-height: 1.6; max-width: 280px; margin: 0 auto; }

        /* ---- DM Chat (inside DM panel) ---- */
        .dm-msgs {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.08) transparent;
        }
        .dm-input-area {
            padding: 10px 16px;
            border-top: 1px solid var(--glass-border);
            display: flex; align-items: flex-end; gap: 8px;
            flex-shrink: 0;
        }
        .dm-input-wrap {
            flex: 1;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            border-radius: 22px;
            display: flex; align-items: center;
            padding: 6px 8px 6px 16px; gap: 8px;
            transition: var(--transition);
        }
        .dm-input-wrap:focus-within {
            border-color: rgba(56,189,248,.4);
            box-shadow: 0 0 0 3px rgba(56,189,248,.08);
        }
        #dm-message-input {
            flex: 1;
            background: transparent; border: none;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 14px; outline: none;
            resize: none; max-height: 100px;
            padding: 4px 0; line-height: 1.4;
        }
        #dm-message-input::placeholder { color: var(--text-muted); }

        /* DM sidebar (list of DM conversations) */
        .dm-list-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 10px; border-radius: var(--radius-md);
            cursor: pointer; transition: var(--transition);
        }
        .dm-list-item:hover { background: rgba(255,255,255,0.05); }
        .dm-list-item.active { background: rgba(56,189,248,0.1); }
        .dm-list-text { flex: 1; min-width: 0; }
        .dm-list-name { font-size: 14px; font-weight: 600; }
        .dm-list-preview { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dm-unread {
            width: 18px; height: 18px;
            border-radius: 50%;
            background: var(--accent);
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            display: none; align-items: center; justify-content: center;
        }
        .dm-unread.show { display: flex; }

        /* ---- Profile Panel ---- */
        .profile-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 32px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .profile-scroll > * { max-width: 480px; width: 100%; }
        .profile-hero {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 32px 24px;
            text-align: center;
            margin-bottom: 16px;
            position: relative;
        }
        .profile-av-lg {
            width: 88px; height: 88px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 38px; font-weight: 700; color: #fff;
            margin: 0 auto 14px;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
            transition: var(--transition);
        }
        .profile-av-lg:hover { transform: scale(1.05); }
        .profile-av-edit {
            position: absolute; inset: 0;
            border-radius: 50%;
            background: rgba(0,0,0,0.55);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; opacity: 0; transition: opacity .2s;
        }
        .profile-av-lg:hover .profile-av-edit { opacity: 1; }
        .profile-display-name { font-size: 24px; font-weight: 800; margin-bottom: 4px; }
        .profile-username-tag { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }
        .status-pills { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        .status-pill {
            padding: 5px 14px; border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: transparent;
            font-size: 12px; cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
        }
        .status-pill.selected { border-color: var(--accent); background: rgba(56,189,248,.12); color: var(--accent); }
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 10px; margin-bottom: 16px;
        }
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 16px 10px; text-align: center;
        }
        .stat-value {
            font-size: 26px; font-weight: 800;
            background: linear-gradient(135deg,#38bdf8,#818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
        .profile-edit-form {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 20px;
        }
        .profile-edit-form h3 { font-size: 15px; font-weight: 700; margin-bottom: 16px; }

        /* Add Friend modal */
        .add-friend-search-result {
            display: flex; align-items: center; gap: 10px;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            margin-top: 12px;
        }

        /* Responsive adjustments */
        @media (max-width: 700px) {
            .panel-sidebar { width: 200px; }
            .profile-stats { grid-template-columns: repeat(3,1fr); }
        }
        @media (max-width: 540px) {
            .dc-panel { left: 60px; }
            .panel-sidebar { display: none; }
            body.logged-in #app { margin-left: 60px; }
            #discord-sidebar { width: 60px; }
        }
    </style>
</head>
<body>

<!-- ===== ANIMATED BACKGROUND ===== -->
<div id="bg-canvas">
    <div class="mesh-orb orb1"></div>
    <div class="mesh-orb orb2"></div>
    <div class="mesh-orb orb3"></div>
    <div class="mesh-orb orb4"></div>
</div>

<!-- ===== LOADING OVERLAY ===== -->
<div id="loading-overlay">
    <div style="text-align:center">
        <div class="logo-icon" style="margin:0 auto 16px;">💬</div>
        <div class="gradient-text" style="font-size:28px;font-weight:800;">AxtarGet</div>
    </div>
</div>

<!-- ===== TOAST CONTAINER ===== -->
<div id="toast-container"></div>

<!-- =====================================================
     NEW: AUTH SCREEN
===================================================== -->
<div id="auth-screen">
    <div class="auth-outer">
        <div class="auth-card">
            <div class="auth-logo">
                <div class="logo-icon" style="margin:0 auto 10px;">💬</div>
                <div class="gradient-text" style="font-size:30px;font-weight:800;">AxtarGet</div>
                <p style="font-size:13px;color:var(--text-muted);margin-top:4px;">Söhbət. Dostluq. Əylənc.</p>
            </div>

            <!-- Tabs: Login / Register -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Giriş</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Qeydiyyat</button>
            </div>

            <!-- LOGIN FORM -->
            <div class="auth-form active" id="auth-login-form">
                <div id="auth-login-error" class="auth-error"></div>
                <div class="auth-input-group">
                    <label class="auth-label">E-poçt</label>
                    <input class="input-field" type="email" id="login-email" placeholder="sizin@email.com">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">Şifrə</label>
                    <input class="input-field" type="password" id="login-password" placeholder="••••••••"
                        onkeydown="if(event.key==='Enter') doLogin()">
                </div>
                <button class="btn btn-primary" onclick="doLogin()" id="login-btn" style="margin-top:4px;">
                    <span class="auth-btn-text">🔐 Daxil ol</span>
                    <span class="auth-btn-loading">⏳</span>
                </button>
            </div>

            <!-- REGISTER FORM -->
            <div class="auth-form" id="auth-register-form">
                <div id="auth-register-error" class="auth-error"></div>
                <div class="auth-input-group">
                    <label class="auth-label">İstifadəçi adı</label>
                    <input class="input-field" type="text" id="register-username" placeholder="cooluser123" maxlength="20">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">Ad Soyad</label>
                    <input class="input-field" type="text" id="register-displayname" placeholder="Əli Vəliyev" maxlength="30">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">E-poçt</label>
                    <input class="input-field" type="email" id="register-email" placeholder="sizin@email.com">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">Şifrə</label>
                    <input class="input-field" type="password" id="register-password" placeholder="min 6 simvol"
                        onkeydown="if(event.key==='Enter') doRegister()">
                </div>
                <button class="btn btn-primary" onclick="doRegister()" id="register-btn" style="margin-top:4px;">
                    <span class="auth-btn-text">✨ Qeydiyyat</span>
                    <span class="auth-btn-loading">⏳</span>
                </button>
            </div>

            <!-- ANONYMOUS OPTION -->
            <div class="auth-divider">və ya</div>
            <button class="btn btn-anon" onclick="continueAnon()">
                🎭 Anonim Davam Et
            </button>
        </div>
    </div>
</div>

<!-- =====================================================
     NEW: DISCORD SIDEBAR
===================================================== -->
<div id="discord-sidebar">
    <!-- Logo -->
    <div class="sb-logo" onclick="closePanels()">💬</div>
    <div class="sb-sep"></div>

    <!-- Nav icons -->
    <button class="sb-icon" id="sb-anon" onclick="switchSbPanel('anon')" title="">
        ⚡
        <span class="sb-tooltip">Anonim Chat</span>
    </button>
    <button class="sb-icon" id="sb-friends" onclick="switchSbPanel('friends')" title="">
        👥
        <span class="sb-badge" id="sb-friend-badge">0</span>
        <span class="sb-tooltip">Dostlar</span>
    </button>
    <button class="sb-icon" id="sb-dms" onclick="switchSbPanel('dms')" title="">
        💬
        <span class="sb-badge" id="sb-dm-badge">0</span>
        <span class="sb-tooltip">Mesajlar</span>
    </button>

    <div class="sb-sep"></div>

    <!-- User profile button -->
    <div class="sb-bottom">
        <div class="sb-user-avatar" id="sb-user-av" onclick="switchSbPanel('profile')" style="background:linear-gradient(135deg,#0ea5e9,#6366f1)">
            ?
            <div class="sb-user-status s-dot online" id="sb-user-status-dot"></div>
        </div>
        <!-- Logout -->
        <button class="sb-icon" onclick="doLogout()" style="font-size:17px;" title="">
            🚪
            <span class="sb-tooltip">Çıxış</span>
        </button>
    </div>
</div>

<!-- =====================================================
     NEW: FRIENDS PANEL
===================================================== -->
<div class="dc-panel" id="panel-friends">
    <!-- Left sidebar: DM list -->
    <div class="panel-sidebar">
        <div class="panel-header">
            <span style="font-size:16px;">💬</span>
            <span class="panel-title">Birbaşa Mesajlar</span>
        </div>
        <div class="friends-list" id="dm-sidebar-list">
            <!-- DM list items populated by JS -->
        </div>
    </div>

    <!-- Main area: friends tabs content -->
    <div class="panel-main">
        <div class="panel-header">
            <span style="font-size:16px;">👥</span>
            <span class="panel-title">Dostlar</span>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-primary btn-sm" onclick="openAddFriendModal()" style="padding:7px 14px;font-size:13px;">
                    ➕ Dost Əlavə Et
                </button>
                <button class="panel-close" onclick="closePanels()">✕</button>
            </div>
        </div>

        <!-- Friends Tabs -->
        <div class="friends-tabs">
            <button class="f-tab active" onclick="switchFriendsTab('online')" id="ftab-online">🟢 Online</button>
            <button class="f-tab" onclick="switchFriendsTab('all')" id="ftab-all">Hamısı</button>
            <button class="f-tab" onclick="switchFriendsTab('pending')" id="ftab-pending">
                Gözləyir
                <span class="f-tab-badge" id="ftab-pending-badge">0</span>
            </button>
        </div>

        <!-- Add friend quick bar -->
        <div class="add-friend-bar" id="add-friend-bar" style="display:none;">
            <input class="input-field" type="text" id="add-friend-input" placeholder="İstifadəçi adı ilə axtar..." style="flex:1;padding:10px 14px;">
            <button class="btn btn-primary btn-sm" onclick="searchAndAddFriend()" style="padding:10px 16px;">Axtar</button>
            <button class="btn btn-ghost btn-sm" onclick="closeAddFriendBar()" style="padding:10px;">✕</button>
        </div>

        <!-- Friends list content -->
        <div class="friends-list" id="friends-list-content">
            <div class="empty-state">
                <div class="e-icon">👥</div>
                <div class="e-title">Dostunuz yoxdur</div>
                <div class="e-text">Dost əlavə etmək üçün "Dost Əlavə Et" düyməsinə basın.</div>
            </div>
        </div>
    </div>
</div>

<!-- =====================================================
     NEW: DM PANEL (opens when clicking a friend)
===================================================== -->
<div class="dc-panel" id="panel-dm">
    <div class="panel-sidebar">
        <div class="panel-header" style="padding:12px 16px;">
            <span style="font-size:15px;">💬</span>
            <span class="panel-title" style="font-size:15px;">Mesajlar</span>
        </div>
        <div class="friends-list" id="dm-conversations-list">
            <!-- Populated by JS -->
        </div>
    </div>

    <div class="panel-main">
        <!-- DM Header -->
        <div class="panel-header" id="dm-chat-header">
            <button class="panel-close" onclick="switchSbPanel('friends')" style="margin-right:4px;">←</button>
            <div class="av-sm" id="dm-partner-av" style="background:linear-gradient(135deg,#0ea5e9,#6366f1)">?</div>
            <div>
                <div style="font-size:15px;font-weight:700;" id="dm-partner-name">...</div>
                <div style="font-size:12px;color:var(--success);" id="dm-partner-status">● Online</div>
            </div>
            <div style="margin-left:auto;display:flex;gap:8px;">
                <button class="panel-close" onclick="closePanels()">✕</button>
            </div>
        </div>

        <!-- DM Messages -->
        <div class="dm-msgs" id="dm-messages"></div>

        <!-- DM Input -->
        <div class="dm-input-area">
            <div class="dm-input-wrap">
                <textarea id="dm-message-input" rows="1"
                    placeholder="Mesaj yazın..."
                    oninput="autoResizeTextarea(this)"
                    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendDmMessage();}"></textarea>
                <button class="input-action-btn" onclick="triggerDmImagePicker()" title="Şəkil">📷</button>
            </div>
            <input type="file" id="dm-image-picker" accept="image/*" style="display:none" onchange="handleDmImageSelected(event)">
            <button class="send-btn" onclick="sendDmMessage()">➤</button>
        </div>
    </div>
</div>

<!-- =====================================================
     NEW: PROFILE PANEL
===================================================== -->
<div class="dc-panel" id="panel-profile">
    <div style="width:100%;display:flex;flex-direction:column;">
        <div class="panel-header">
            <span style="font-size:16px;">👤</span>
            <span class="panel-title">Profilim</span>
            <button class="panel-close" onclick="closePanels()">✕</button>
        </div>

        <div class="profile-scroll">
            <!-- Hero card -->
            <div class="profile-hero">
                <div class="profile-av-lg" id="profile-avatar-lg" style="background:linear-gradient(135deg,#0ea5e9,#6366f1)">
                    ?
                    <div class="profile-av-edit">✏️</div>
                </div>
                <div class="profile-display-name" id="profile-display-name">İstifadəçi</div>
                <div class="profile-username-tag" id="profile-username-tag">@istifadeci</div>

                <!-- Status selector -->
                <div class="status-pills">
                    <button class="status-pill selected" onclick="setUserStatus('online')" id="sp-online">🟢 Online</button>
                    <button class="status-pill" onclick="setUserStatus('away')" id="sp-away">🟡 Meşğul</button>
                    <button class="status-pill" onclick="setUserStatus('dnd')" id="sp-dnd">🔴 Narahat etmə</button>
                    <button class="status-pill" onclick="setUserStatus('invisible')" id="sp-invisible">⚫ Görünməz</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-friends">0</div>
                    <div class="stat-label">Dostlar</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-chats">0</div>
                    <div class="stat-label">Söhbətlər</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-msgs">0</div>
                    <div class="stat-label">Mesajlar</div>
                </div>
            </div>

            <!-- Edit form -->
            <div class="profile-edit-form">
                <h3>✏️ Profili Düzənlə</h3>
                <div class="auth-input-group">
                    <label class="auth-label">Görünən Ad</label>
                    <input class="input-field" type="text" id="edit-displayname" maxlength="30" placeholder="Adınız...">
                </div>
                <div class="auth-input-group">
                    <label class="auth-label">Haqqımda</label>
                    <textarea class="input-field" id="edit-bio" rows="3" maxlength="120" placeholder="Özünüz haqqında bir şey yazın..." style="resize:none;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveProfile()" style="margin-top:4px;">💾 Yadda saxla</button>
            </div>

            <!-- Danger zone -->
            <div style="background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.2);border-radius:var(--radius-md);padding:16px;margin-top:16px;">
                <p style="font-size:14px;font-weight:600;color:var(--danger);margin-bottom:10px;">⚠️ Hesabı sil</p>
                <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Bu əməliyyat geri qaytarıla bilməz. Bütün məlumatlarınız silinəcək.</p>
                <button class="btn btn-danger btn-sm" onclick="confirmDeleteAccount()" style="width:auto;">Hesabı Sil</button>
            </div>
        </div>
    </div>
</div>

<!-- =====================================================
     NEW: ADD FRIEND MODAL
===================================================== -->
<div class="modal-overlay" id="add-friend-modal">
    <div class="modal-card">
        <div class="modal-title">
            <span>➕ Dost Əlavə Et</span>
            <button class="modal-close" onclick="closeAddFriendModal()">✕</button>
        </div>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">İstifadəçi adı ilə axtarın:</p>
        <div style="display:flex;gap:8px;">
            <input class="input-field" type="text" id="modal-add-friend-input"
                placeholder="@cooluser123"
                onkeydown="if(event.key==='Enter') modalSearchFriend()"
                style="flex:1;">
            <button class="btn btn-primary btn-sm" onclick="modalSearchFriend()" style="width:auto;padding:12px 16px;">🔍</button>
        </div>
        <div id="add-friend-result" style="margin-top:12px;"></div>
    </div>
</div>
<div class="lang-selector">
    <div class="lang-btn-wrap">
        <button class="lang-btn active" id="az-btn" onclick="setLang('az')">🇦🇿 AZ</button>
        <button class="lang-btn" id="tr-btn" onclick="setLang('tr')">🇹🇷 TR</button>
    </div>
</div>

<!-- ===== APP SHELL ===== -->
<div id="app">

    <!-- ============================
         START SCREEN
    ============================ -->
    <div class="screen active" id="start-screen">
        <!-- Logo -->
        <div class="logo-wrap">
            <div class="logo-icon">💬</div>
            <h1 class="logo-title gradient-text">AxtarGet</h1>
            <p class="logo-subtitle" id="t-subtitle">Pulsuz Online Chat Platforması</p>
        </div>

        <!-- Card -->
        <div class="glass-strong start-card">
            <div class="alert-box">
                <span>⚠️</span>
                <span><strong id="t-alertTitle">Diqqət:</strong> <span id="t-alertText">Yazışmalarınız serverdə saxlanılmır. Söhbət bitdikdə avtomatik silinir.</span></span>
            </div>

            <label class="input-label" id="t-nameLabel">ADINIIZ (İSTƏYƏ BAĞLI)</label>
            <input class="input-field" type="text" id="user-name-input" maxlength="20" placeholder="Adınızı yazın..." id="t-namePlaceholder">
            <p class="input-hint" id="t-nameHint">Boş buraxsanız təsadüfi ad təyin olunacaq</p>

            <div style="height:20px"></div>
            <button class="btn btn-primary" onclick="handleStart()" id="t-startBtn">
                <span>⚡</span> <span id="t-startBtnText">Söhbətə Başla</span>
            </button>
            <div style="height:10px"></div>
            <button class="btn btn-ghost" onclick="openTutorial()" id="t-tutorialBtn">
                ℹ️ <span id="t-tutorialBtnText">Necə İstifadə Olunur?</span>
            </button>
        </div>

        <p class="start-footer" id="t-footer">AxtarGet — Azərbaycanda ən yaxşı pulsuz chat platforması.</p>
    </div>

    <!-- ============================
         MATCHING SCREEN
    ============================ -->
    <div class="screen" id="matching-screen">
        <div class="glass-strong match-card">
            <div class="match-spinner"></div>
            <p class="match-title" id="t-matchingText">Söhbət Tərəfdaşı Axtarılır...</p>
            <p class="match-countdown" id="countdown-display">⏱ Qalan vaxt: 20 saniyə</p>
            <button class="btn btn-danger" onclick="handleCancelMatching()">
                ✕ <span id="t-cancelBtn">Ləğv Et</span>
            </button>
            <div id="retry-wrap" style="display:none;margin-top:20px;border-top:1px solid var(--glass-border);padding-top:20px;">
                <p style="color:var(--warning);font-size:14px;margin-bottom:12px;" id="t-noUsers">Heç bir aktiv istifadəçi tapılmadı</p>
                <button class="btn btn-primary" onclick="handleStart()">
                    🔄 <span id="t-retryBtn">Yenidən Cəhd Et</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ============================
         CHAT SCREEN
    ============================ -->
    <div class="screen" id="chat-screen">
        <!-- Header -->
        <div class="glass chat-header">
            <div class="chat-partner-info">
                <!-- Generative avatar — JS tərəfindən doldurulur -->
                <div class="avatar" id="partner-avatar">?</div>
                <div>
                    <div class="partner-name" id="partner-name">...</div>
                    <div class="partner-status" id="partner-status">
                        <span style="color:var(--success)">●</span>
                        <span id="t-activeText">Aktiv</span>
                    </div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="btn btn-ghost btn-sm" onclick="handleChangeChat()">
                    🔄 <span id="t-changeBtn">Dəyiş</span>
                </button>
                <button class="btn btn-danger btn-sm" onclick="handleCloseChat()">
                    ✕ <span id="t-closeBtn">Bağla</span>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chat-messages"></div>

        <!-- Input Area -->
        <div class="glass chat-input-area">
            <div class="chat-input-wrap" id="input-wrap">
                <!-- Voice record mode (hidden default) -->
                <div class="voice-record-wrap" id="voice-record-wrap">
                    <div class="voice-record-indicator"></div>
                    <div class="voice-record-waves" id="record-waves"></div>
                    <div class="voice-record-time" id="record-time">0:00</div>
                </div>
                <!-- Normal input -->
                <textarea
                    id="message-input"
                    rows="1"
                    placeholder="Mesajınızı yazın..."
                    oninput="autoResizeTextarea(this); handleTyping();"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMessage();}"
                ></textarea>
                <!-- Image button -->
                <button class="input-action-btn" onclick="triggerImagePicker()" title="Şəkil göndər">📷</button>
                <!-- Voice button -->
                <button class="input-action-btn" id="voice-btn" onmousedown="startVoiceRecord()" onmouseup="stopVoiceRecord()" ontouchstart="startVoiceRecord()" ontouchend="stopVoiceRecord()" title="Səsli mesaj">🎤</button>
            </div>
            <!-- Hidden file input -->
            <input type="file" id="image-picker" accept="image/*" style="display:none" onchange="handleImageSelected(event)">
            <!-- Send button -->
            <button class="send-btn" onclick="sendMessage()">➤</button>
        </div>
    </div>

</div><!-- #app -->

<!-- ===== TUTORIAL MODAL ===== -->
<div class="modal-overlay" id="tutorial-modal">
    <div class="modal-card">
        <div class="modal-title">
            <span id="t-tutorialTitle">AxtarGet Necə İstifadə Olunur?</span>
            <button class="modal-close" onclick="closeTutorial()">✕</button>
        </div>
        <div class="tutorial-step">
            <div class="step-num">1</div>
            <div class="step-text">
                <h4 id="t-step1Title">Adınızı Yazın (İstəyə Bağlı)</h4>
                <p id="t-step1Text">Adınızı yazın və ya boş buraxın. Boş buraxsanız, sistem təsadüfi ad verəcək.</p>
            </div>
        </div>
        <div class="tutorial-step">
            <div class="step-num">2</div>
            <div class="step-text">
                <h4 id="t-step2Title">Söhbətə Başlayın</h4>
                <p id="t-step2Text">"Söhbətə Başla" düyməsinə basın. Sistem sizi digər istifadəçilərlə qoşacaq.</p>
            </div>
        </div>
        <div class="tutorial-step">
            <div class="step-num">3</div>
            <div class="step-text">
                <h4 id="t-step3Title">Söhbət Edin</h4>
                <p id="t-step3Text">Şəkil göndərin, səsli mesaj bıraxın, reaksiyalar əlavə edin. Mesajlara uzun basan zaman emoji seçimi çıxacaq.</p>
            </div>
        </div>
        <div class="tutorial-step">
            <div class="step-num">4</div>
            <div class="step-text">
                <h4 id="t-step4Title">Dil Seçin</h4>
                <p id="t-step4Text">Yuxarı sağ küncündən dil seçin. Seçilən dil qarşı tərəfdə görünür.</p>
            </div>
        </div>
        <div style="margin-top:20px;">
            <button class="btn btn-primary" onclick="closeTutorial()">
                ✅ <span id="t-understandBtn">Başa düşdüm, Başlayaq!</span>
            </button>
        </div>
    </div>
</div>

<!-- ===== FEEDBACK MODAL ===== -->
<div class="modal-overlay" id="feedback-modal">
    <div class="modal-card" style="text-align:center;">
        <div class="modal-title" style="justify-content:center;flex-direction:column;gap:6px;">
            <span style="font-size:40px;">👋</span>
            <span id="t-feedbackTitle">Söhbət necə keçdi?</span>
        </div>
        <p style="font-size:14px;color:var(--text-secondary);margin-bottom:8px;" id="t-feedbackSubtitle">Rəyiniz bizim üçün vacibdir</p>
        <div class="feedback-stars" id="feedback-stars">
            <button class="star-btn" data-val="1" onclick="setStarRating(1)">⭐</button>
            <button class="star-btn" data-val="2" onclick="setStarRating(2)">⭐</button>
            <button class="star-btn" data-val="3" onclick="setStarRating(3)">⭐</button>
            <button class="star-btn" data-val="4" onclick="setStarRating(4)">⭐</button>
            <button class="star-btn" data-val="5" onclick="setStarRating(5)">⭐</button>
        </div>
        <div class="feedback-tags" id="feedback-tags">
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag1">Mehriban idi</button>
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag2">Maraqlı söhbət</button>
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag3">Tez bitdi</button>
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag4">Münasib deyildi</button>
        </div>
        <button class="btn btn-primary" onclick="submitFeedback()" id="t-feedbackSubmit">Göndər</button>
        <button class="btn btn-ghost" style="margin-top:10px;" onclick="skipFeedback()" id="t-feedbackSkip">Keç</button>
    </div>
</div>

<!-- ===== LIGHTBOX ===== -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">✕</button>
    <img id="lightbox-img" src="" alt="Full view">
</div>

<!-- =============================================
     JAVASCRIPT — Full Logic
============================================= -->
<script>
/* ================================================
   TRANSLATIONS — AZ / TR
================================================ */
const T = {
    az: {
        subtitle: 'Pulsuz Online Chat Platforması',
        alertTitle: 'Diqqət:',
        alertText: 'Yazışmalarınız serverdə saxlanılmır. Söhbət bitdikdə avtomatik silinir.',
        nameLabel: 'ADINIZ (İSTƏYƏ BAĞLI)',
        namePlaceholder: 'Adınızı yazın...',
        nameHint: 'Boş buraxsanız təsadüfi ad təyin olunacaq',
        startBtnText: 'Söhbətə Başla',
        tutorialBtnText: 'Necə İstifadə Olunur?',
        footer: 'AxtarGet — Azərbaycanda ən yaxşı pulsuz chat platforması.',
        matchingText: 'Söhbət Tərəfdaşı Axtarılır...',
        cancelBtn: 'Ləğv Et',
        noUsers: 'Heç bir aktiv istifadəçi tapılmadı',
        retryBtn: 'Yenidən Cəhd Et',
        activeText: 'Aktiv',
        typingText: 'yazır...',
        changeBtn: 'Dəyiş',
        closeBtn: 'Bağla',
        msgPlaceholder: 'Mesajınızı yazın...',
        tutorialTitle: 'AxtarGet Necə İstifadə Olunur?',
        step1Title: 'Adınızı Yazın (İstəyə Bağlı)',
        step1Text: 'Adınızı yazın və ya boş buraxın. Boş buraxsanız, sistem təsadüfi ad verəcək.',
        step2Title: 'Söhbətə Başlayın',
        step2Text: '"Söhbətə Başla" düyməsinə basın. Sistem sizi digər istifadəçilərlə qoşacaq.',
        step3Title: 'Söhbət Edin',
        step3Text: 'Şəkil göndərin, səsli mesaj bıraxın, reaksiyalar əlavə edin.',
        step4Title: 'Dil Seçin',
        step4Text: 'Yuxarı sağ küncündən dil seçin. Seçilən dil qarşı tərəfdə görünür.',
        understandBtn: 'Başa düşdüm, Başlayaq!',
        feedbackTitle: 'Söhbət necə keçdi?',
        feedbackSubtitle: 'Rəyiniz bizim üçün vacibdir',
        tag1: 'Mehriban idi',
        tag2: 'Maraqlı söhbət',
        tag3: 'Tez bitdi',
        tag4: 'Münasib deyildi',
        feedbackSubmit: 'Göndər',
        feedbackSkip: 'Keç',
        partnerLeft: '❌ Tərəfdaş söhbəti bağladı',
        msgError: '⚠️ Mesaj göndərilə bilmədi',
        matchFound: '🎉 Tərəfdaş tapıldı!',
        connecting: 'Qoşulur...',
        you: 'Siz',
    },
    tr: {
        subtitle: 'Ücretsiz Online Chat Platformu',
        alertTitle: 'Dikkat:',
        alertText: 'Yazışmalarınız sunucuda saklanmaz. Sohbet bittiğinde otomatik silinir.',
        nameLabel: 'ADINIZ (İSTEĞE BAĞLI)',
        namePlaceholder: 'Adınızı yazın...',
        nameHint: 'Boş bırakırsanız rastgele ad atanacak',
        startBtnText: 'Sohbete Başla',
        tutorialBtnText: 'Nasıl Kullanılır?',
        footer: 'AxtarGet — Azerbaycandaki en iyi ücretsiz chat platformu.',
        matchingText: 'Sohbet Partneri Aranıyor...',
        cancelBtn: 'İptal Et',
        noUsers: 'Hiçbir aktif kullanıcı bulunamadı',
        retryBtn: 'Yeniden Dene',
        activeText: 'Aktif',
        typingText: 'yazıyor...',
        changeBtn: 'Değiştir',
        closeBtn: 'Kapat',
        msgPlaceholder: 'Mesajınızı yazın...',
        tutorialTitle: 'AxtarGet Nasıl Kullanılır?',
        step1Title: 'Adınızı Yazın (İsteğe Bağlı)',
        step1Text: 'Adınızı yazın veya boş bırakın. Boş bırakırsanız, sistem rastgele ad verecek.',
        step2Title: 'Sohbete Başlayın',
        step2Text: '"Sohbete Başla" butonuna tıklayın.',
        step3Title: 'Sohbet Edin',
        step3Text: 'Fotoğraf gönderin, sesli mesaj bırakın, reaksiyonlar ekleyin.',
        step4Title: 'Dil Seçin',
        step4Text: 'Sağ üst köşeden dil seçin.',
        understandBtn: 'Anladım, Başlayalım!',
        feedbackTitle: 'Sohbet nasıldı?',
        feedbackSubtitle: 'Görüşünüz bizim için önemli',
        tag1: 'Nazikti',
        tag2: 'İlginç sohbet',
        tag3: 'Erken bitti',
        tag4: 'Uygun değildi',
        feedbackSubmit: 'Gönder',
        feedbackSkip: 'Geç',
        partnerLeft: '❌ Partner sohbeti kapattı',
        msgError: '⚠️ Mesaj gönderilemedi',
        matchFound: '🎉 Partner bulundu!',
        connecting: 'Bağlanıyor...',
        you: 'Siz',
    }
};

/* ================================================
   APP STATE
================================================ */
let lang = 'az'; // current language

/* setLang — dili dəyiş */
function setLang(l) {
    lang = l;
    document.getElementById('az-btn').classList.toggle('active', l === 'az');
    document.getElementById('tr-btn').classList.toggle('active', l === 'tr');
    applyTranslations();
}

/* Bütün UI mətnlərini tətbiq et */
function applyTranslations() {
    const t = T[lang];
    const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    const setPlaceholder = (id, val) => { const el = document.getElementById(id); if(el) el.placeholder = val; };

    set('t-subtitle', t.subtitle);
    set('t-alertTitle', t.alertTitle);
    set('t-alertText', t.alertText);
    set('t-nameLabel', t.nameLabel);
    setPlaceholder('user-name-input', t.namePlaceholder);
    document.querySelector('.input-hint') && (document.querySelector('.input-hint').textContent = t.nameHint);
    set('t-startBtnText', t.startBtnText);
    set('t-tutorialBtnText', t.tutorialBtnText);
    set('t-footer', t.footer);
    set('t-matchingText', t.matchingText);
    set('t-cancelBtn', t.cancelBtn);
    set('t-noUsers', t.noUsers);
    set('t-retryBtn', t.retryBtn);
    set('t-activeText', t.activeText);
    set('t-changeBtn', t.changeBtn);
    set('t-closeBtn', t.closeBtn);
    setPlaceholder('message-input', t.msgPlaceholder);
    set('t-tutorialTitle', t.tutorialTitle);
    set('t-step1Title', t.step1Title);
    set('t-step1Text', t.step1Text);
    set('t-step2Title', t.step2Title);
    set('t-step2Text', t.step2Text);
    set('t-step3Title', t.step3Title);
    set('t-step3Text', t.step3Text);
    set('t-step4Title', t.step4Title);
    set('t-step4Text', t.step4Text);
    set('t-understandBtn', t.understandBtn);
    set('t-feedbackTitle', t.feedbackTitle);
    set('t-feedbackSubtitle', t.feedbackSubtitle);
    set('t-tag1', t.tag1);
    set('t-tag2', t.tag2);
    set('t-tag3', t.tag3);
    set('t-tag4', t.tag4);
    set('t-feedbackSubmit', t.feedbackSubmit);
    set('t-feedbackSkip', t.feedbackSkip);
}

/* ================================================
   SCREEN MANAGER
================================================ */
function showScreen(id) {
    ['start-screen','matching-screen','chat-screen'].forEach(s => {
        const el = document.getElementById(s);
        el.classList.remove('active');
    });
    const target = document.getElementById(id);
    target.classList.add('active');
}

/* ================================================
   TUTORIAL
================================================ */
function openTutorial() {
    document.getElementById('tutorial-modal').classList.add('open');
}
function closeTutorial() {
    document.getElementById('tutorial-modal').classList.remove('open');
}

/* ================================================
   TOAST NOTIFICATIONS
================================================ */
function showToast(msg, type = 'info', duration = 3000) {
    const icons = { info: 'ℹ️', success: '✅', error: '❌', warning: '⚠️' };
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `<span>${icons[type]||'ℹ️'}</span><span>${msg}</span>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'toastOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

/* ================================================
   LIGHTBOX
================================================ */
function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('open');
}

/* ================================================
   CONFETTI ANIMATION (Match Found!)
================================================ */
function launchConfetti() {
    const colors = ['#38bdf8','#818cf8','#34d399','#fbbf24','#f87171','#a78bfa','#fb923c'];
    for (let i = 0; i < 80; i++) {
        setTimeout(() => {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.top = '-10px';
            piece.style.background = colors[Math.floor(Math.random() * colors.length)];
            piece.style.width = (6 + Math.random() * 8) + 'px';
            piece.style.height = (6 + Math.random() * 8) + 'px';
            piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
            piece.style.animationDuration = (1.5 + Math.random() * 2) + 's';
            piece.style.animationDelay = Math.random() * 0.5 + 's';
            document.body.appendChild(piece);
            setTimeout(() => piece.remove(), 4000);
        }, i * 20);
    }
}

/* Screen shake */
function shakeScreen() {
    document.getElementById('app').classList.add('shake');
    setTimeout(() => document.getElementById('app').classList.remove('shake'), 600);
}

/* ================================================
   GENERATIVE AVATAR — ID-based gradient
================================================ */
function generateAvatar(name, id = '') {
    const colors = [
        ['#0ea5e9','#6366f1'],
        ['#10b981','#06b6d4'],
        ['#f59e0b','#ef4444'],
        ['#8b5cf6','#ec4899'],
        ['#14b8a6','#3b82f6'],
        ['#f97316','#a855f7'],
    ];
    // Seçim ID-ə görə deterministik olsun
    const seed = (id + name).split('').reduce((a,c) => a + c.charCodeAt(0), 0);
    const pair = colors[seed % colors.length];
    const initials = (name || '?').trim()[0].toUpperCase();

    const avatar = document.getElementById('partner-avatar');
    avatar.style.background = `linear-gradient(135deg, ${pair[0]}, ${pair[1]})`;
    avatar.textContent = initials;
}

/* ================================================
   TIMESTAMP FORMATTER
================================================ */
function formatTime(ts) {
    const d = ts ? new Date(ts) : new Date();
    return d.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });
}

function formatDate(ts) {
    const d = ts ? new Date(ts) : new Date();
    const now = new Date();
    const diff = Math.floor((now - d) / 86400000);
    if (diff === 0) return formatTime(ts);
    if (diff === 1) return lang === 'az' ? 'Dünən' : 'Dün';
    if (diff < 7) return `${diff} ${lang === 'az' ? 'gün əvvəl' : 'gün önce'}`;
    return d.toLocaleDateString('az-AZ');
}

/* ================================================
   ESCAPE HTML
================================================ */
function esc(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

/* ================================================
   TEXTAREA AUTO-RESIZE
================================================ */
function autoResizeTextarea(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

/* ================================================
   VOICE MESSAGE UI
================================================ */
let isRecording = false;
let recordTimer = null;
let recordSeconds = 0;

function startVoiceRecord() {
    if (isRecording) return;
    isRecording = true;
    recordSeconds = 0;
    document.getElementById('voice-record-wrap').classList.add('active');
    document.getElementById('message-input').style.display = 'none';
    // Build wave bars
    const waves = document.getElementById('record-waves');
    waves.innerHTML = '';
    for (let i = 0; i < 24; i++) {
        const bar = document.createElement('div');
        bar.className = 'voice-record-wave';
        bar.style.height = (4 + Math.random() * 18) + 'px';
        bar.style.animationDuration = (0.3 + Math.random() * 0.4) + 's';
        bar.style.animationDelay = (Math.random() * 0.3) + 's';
        waves.appendChild(bar);
    }
    recordTimer = setInterval(() => {
        recordSeconds++;
        const m = Math.floor(recordSeconds / 60);
        const s = recordSeconds % 60;
        document.getElementById('record-time').textContent = `${m}:${s.toString().padStart(2,'0')}`;
    }, 1000);
}

function stopVoiceRecord() {
    if (!isRecording) return;
    isRecording = false;
    clearInterval(recordTimer);
    document.getElementById('voice-record-wrap').classList.remove('active');
    document.getElementById('message-input').style.display = '';
    if (recordSeconds >= 1) {
        // Simulate sending a voice message
        sendVoiceMessage(recordSeconds);
    }
    recordSeconds = 0;
}

/* ================================================
   IMAGE PICKER
================================================ */
function triggerImagePicker() {
    document.getElementById('image-picker').click();
}

function handleImageSelected(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 3 * 1024 * 1024) {
        showToast('Şəkil 3MB-dan kiçik olmalıdır', 'error');
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        const base64 = e.target.result;
        sendImageMessage(base64);
    };
    reader.readAsDataURL(file);
    event.target.value = '';
}

/* ================================================
   FEEDBACK
================================================ */
let feedbackRating = 0;

function setStarRating(val) {
    feedbackRating = val;
    document.querySelectorAll('.star-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i < val);
    });
}

function toggleFeedbackTag(el) {
    el.classList.toggle('selected');
}

function submitFeedback() {
    document.getElementById('feedback-modal').classList.remove('open');
    showToast(lang === 'az' ? 'Rəyiniz üçün təşəkkür!' : 'Geri bildiriminiz için teşekkür!', 'success');
    showScreen('start-screen');
    document.getElementById('user-name-input').value = '';
    feedbackRating = 0;
}

function skipFeedback() {
    document.getElementById('feedback-modal').classList.remove('open');
    showScreen('start-screen');
    document.getElementById('user-name-input').value = '';
}

/* ================================================
   REACTION SYSTEM
================================================ */
const REACTIONS = ['❤️', '😂', '🔥', '👍', '😢'];
let reactionTimers = {};
let currentReactionMsg = null;

function attachReactionListeners(wrapper, msgId) {
    let pressTimer;

    const showPicker = () => {
        // Close any open pickers
        document.querySelectorAll('.reaction-picker.visible').forEach(p => {
            if (p !== wrapper.querySelector('.reaction-picker'))
                p.classList.remove('visible');
        });
        wrapper.querySelector('.reaction-picker').classList.add('visible');
        currentReactionMsg = msgId;
    };

    // Long press (touch)
    wrapper.addEventListener('touchstart', () => {
        pressTimer = setTimeout(showPicker, 450);
    }, { passive: true });
    wrapper.addEventListener('touchend', () => clearTimeout(pressTimer), { passive: true });
    wrapper.addEventListener('touchmove', () => clearTimeout(pressTimer), { passive: true });

    // Hover (desktop) — show after brief delay
    wrapper.addEventListener('mouseenter', () => {
        pressTimer = setTimeout(showPicker, 700);
    });
    wrapper.addEventListener('mouseleave', () => {
        clearTimeout(pressTimer);
        setTimeout(() => {
            const picker = wrapper.querySelector('.reaction-picker');
            if (picker && !picker.matches(':hover')) {
                picker.classList.remove('visible');
            }
        }, 300);
    });
}

function addReactionToMsg(msgId, emoji, isSelf) {
    const wrapper = document.querySelector(`[data-msg-id="${msgId}"]`);
    if (!wrapper) return;
    let display = wrapper.querySelector('.msg-reaction-display');
    if (!display) {
        display = document.createElement('div');
        display.className = 'msg-reaction-display';
        wrapper.appendChild(display);
    }
    // Check if same emoji already exists
    const existing = Array.from(display.querySelectorAll('.reaction-badge')).find(b => b.dataset.emoji === emoji);
    if (existing) {
        const count = parseInt(existing.dataset.count || '1') + 1;
        existing.dataset.count = count;
        existing.querySelector('.r-count').textContent = count > 1 ? count : '';
    } else {
        const badge = document.createElement('span');
        badge.className = 'reaction-badge';
        badge.dataset.emoji = emoji;
        badge.dataset.count = '1';
        badge.innerHTML = `${emoji}<span class="r-count"></span>`;
        display.appendChild(badge);
    }
    wrapper.querySelector('.reaction-picker').classList.remove('visible');
}

/* ================================================
   MESSAGE RENDERING
================================================ */
let renderedMessageIds = new Set();
let shouldAutoScroll = true;

const msgsContainer = () => document.getElementById('chat-messages');

function addMessage({ id, senderName, text, isSelf, timestamp, type = 'text', imageData, voiceDuration }) {
    if (id && renderedMessageIds.has(id)) return;
    if (id) renderedMessageIds.add(id);

    const container = msgsContainer();
    const wrapper = document.createElement('div');
    wrapper.className = `msg-wrapper ${isSelf ? 'self' : 'other'}`;
    wrapper.dataset.msgId = id || Date.now();

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';

    if (type === 'image' && imageData) {
        const img = document.createElement('img');
        img.className = 'msg-image';
        img.src = imageData;
        img.alt = 'Image';
        img.onclick = () => openLightbox(imageData);
        bubble.appendChild(img);
    } else if (type === 'voice') {
        bubble.innerHTML = `
            <div class="voice-msg">
                <button class="voice-play-btn" onclick="simulateVoicePlay(this)">▶</button>
                <div class="voice-waveform">${generateWaveBars()}</div>
                <span class="voice-duration">${formatVoiceDuration(voiceDuration || 0)}</span>
            </div>`;
    } else {
        bubble.innerHTML = `<span>${esc(text)}</span>`;
    }

    // Reaction picker
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    REACTIONS.forEach(emoji => {
        const btn = document.createElement('span');
        btn.className = 'reaction-emoji';
        btn.textContent = emoji;
        btn.onclick = (e) => {
            e.stopPropagation();
            addReactionToMsg(wrapper.dataset.msgId, emoji, isSelf);
            // Send reaction to Firebase if needed
            if (chatId && userId) {
                sendReactionToFirebase(wrapper.dataset.msgId, emoji).catch(()=>{});
            }
        };
        picker.appendChild(btn);
    });
    bubble.appendChild(picker);

    // Meta (time + ticks)
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    if (isSelf) {
        meta.innerHTML = `
            <span class="msg-time">${formatDate(timestamp)}</span>
            <span class="msg-ticks" id="ticks-${id||''}">✓✓</span>`;
    } else {
        meta.innerHTML = `<span class="msg-time">${formatDate(timestamp)}</span>`;
    }

    wrapper.appendChild(bubble);
    wrapper.appendChild(meta);

    // Attach reaction listeners
    attachReactionListeners(wrapper, wrapper.dataset.msgId);

    container.appendChild(wrapper);

    // Smart auto-scroll
    smartScroll();
}

function smartScroll() {
    const c = msgsContainer();
    const isNearBottom = c.scrollHeight - c.scrollTop - c.clientHeight < 120;
    if (isNearBottom || shouldAutoScroll) {
        c.scrollTop = c.scrollHeight;
    }
}

function addSystemMessage(text) {
    const container = msgsContainer();
    const el = document.createElement('div');
    el.className = 'msg-system';
    el.textContent = text;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
}

function generateWaveBars() {
    let html = '';
    const heights = [4,8,14,10,18,12,6,16,10,8,14,6,18,10,12];
    heights.forEach(h => {
        html += `<div class="voice-bar" style="height:${h}px"></div>`;
    });
    return html;
}

function formatVoiceDuration(secs) {
    const m = Math.floor(secs / 60);
    const s = secs % 60;
    return `${m}:${s.toString().padStart(2,'0')}`;
}

function simulateVoicePlay(btn) {
    btn.textContent = '⏸';
    const waveform = btn.parentElement.querySelector('.voice-waveform');
    // Animate bars
    const bars = waveform.querySelectorAll('.voice-bar');
    let frame = 0;
    const anim = setInterval(() => {
        bars.forEach(b => {
            b.style.height = (4 + Math.random() * 18) + 'px';
            b.style.background = '#38bdf8';
        });
        frame++;
        if (frame > 30) {
            clearInterval(anim);
            bars.forEach(b => { b.style.height = '4px'; b.style.background = 'rgba(255,255,255,0.5)'; });
            btn.textContent = '▶';
        }
    }, 100);
}

/* ================================================
   FIREBASE — Real-time Chat
================================================ */
</script>

<!-- =====================================================
     NEW: AUTH + FRIENDS + DM + PROFILE — Non-module JS
===================================================== -->
<script>
/* ---- Auth UI state ---- */
let _currentAuthTab = 'login';
let _isAnon = false;

function switchAuthTab(tab) {
    _currentAuthTab = tab;
    document.querySelectorAll('.auth-tab').forEach((t,i) => {
        t.classList.toggle('active', (i === 0 && tab === 'login') || (i === 1 && tab === 'register'));
    });
    document.getElementById('auth-login-form').classList.toggle('active', tab === 'login');
    document.getElementById('auth-register-form').classList.toggle('active', tab === 'register');
    hideAuthErrors();
}

function hideAuthErrors() {
    ['auth-login-error','auth-register-error'].forEach(id => {
        const el = document.getElementById(id);
        if(el) { el.classList.remove('visible'); el.textContent = ''; }
    });
}

function showAuthError(formId, msg) {
    const el = document.getElementById(formId);
    if(el) { el.textContent = msg; el.classList.add('visible'); }
}

function setAuthBtnLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    if(!btn) return;
    btn.classList.toggle('loading', loading);
    btn.disabled = loading;
}

/* continueAnon — close auth screen, use existing anon session */
function continueAnon() {
    _isAnon = true;
    document.getElementById('auth-screen').classList.add('hidden');
    // Anon users get sidebar but limited features
    document.body.classList.add('logged-in');
    updateSidebarForAnon();
    showToast('Anonim olaraq davam edirsiniz', 'info');
}

function updateSidebarForAnon() {
    // Show anon indicator in sidebar user avatar
    const av = document.getElementById('sb-user-av');
    if(av) {
        av.textContent = '👤';
        av.style.background = 'rgba(255,255,255,0.1)';
    }
}

/* Called after successful email auth — reveal Discord layout */
function onAuthSuccess(profile) {
    document.getElementById('auth-screen').classList.add('hidden');
    document.body.classList.add('logged-in');
    loadUserProfile(profile);
}

function loadUserProfile(profile) {
    if(!profile) return;
    // Sidebar avatar
    const av = document.getElementById('sb-user-av');
    const initials = (profile.displayName || profile.username || '?')[0].toUpperCase();
    const colors = [['#0ea5e9','#6366f1'],['#10b981','#06b6d4'],['#f59e0b','#ef4444'],['#8b5cf6','#ec4899']];
    const seed = (profile.uid||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const pair = colors[seed % colors.length];
    if(av) {
        av.textContent = initials;
        av.style.background = `linear-gradient(135deg,${pair[0]},${pair[1]})`;
    }
    // Profile panel
    const dn = document.getElementById('profile-display-name');
    const un = document.getElementById('profile-username-tag');
    const avLg = document.getElementById('profile-avatar-lg');
    if(dn) dn.textContent = profile.displayName || 'İstifadəçi';
    if(un) un.textContent = '@' + (profile.username || 'anonim');
    if(avLg) {
        avLg.style.background = `linear-gradient(135deg,${pair[0]},${pair[1]})`;
        avLg.childNodes[0].textContent = initials;
    }
    // Edit form
    const edn = document.getElementById('edit-displayname');
    const ebio = document.getElementById('edit-bio');
    if(edn) edn.value = profile.displayName || '';
    if(ebio) ebio.value = profile.bio || '';
}

/* ---- Panel switching ---- */
let _activePanel = null;

function switchSbPanel(panel) {
    // Close all panels
    document.querySelectorAll('.dc-panel').forEach(p => p.classList.remove('open'));
    // Update sidebar icons
    document.querySelectorAll('.sb-icon').forEach(i => i.classList.remove('active'));

    if(panel === _activePanel) {
        _activePanel = null;
        document.getElementById('sb-anon')?.classList.add('active');
        return;
    }

    _activePanel = panel;

    if(panel === 'friends') {
        document.getElementById('panel-friends').classList.add('open');
        document.getElementById('sb-friends')?.classList.add('active');
        loadFriendsList();
    } else if(panel === 'dms') {
        document.getElementById('panel-dm').classList.add('open');
        document.getElementById('sb-dms')?.classList.add('active');
        loadDmConversations();
    } else if(panel === 'profile') {
        document.getElementById('panel-profile').classList.add('open');
        loadProfileStats();
    } else if(panel === 'anon') {
        document.getElementById('sb-anon')?.classList.add('active');
    }
}

function closePanels() {
    document.querySelectorAll('.dc-panel').forEach(p => p.classList.remove('open'));
    document.querySelectorAll('.sb-icon').forEach(i => i.classList.remove('active'));
    document.getElementById('sb-anon')?.classList.add('active');
    _activePanel = null;
}

/* ---- Friends tabs ---- */
let _friendsTab = 'online';

function switchFriendsTab(tab) {
    _friendsTab = tab;
    document.querySelectorAll('.f-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('ftab-' + tab)?.classList.add('active');
    loadFriendsList();
}

/* ---- Add friend bar ---- */
function openAddFriendModal() {
    document.getElementById('add-friend-modal').classList.add('open');
    setTimeout(() => document.getElementById('modal-add-friend-input')?.focus(), 100);
}
function closeAddFriendModal() {
    document.getElementById('add-friend-modal').classList.remove('open');
    document.getElementById('add-friend-result').innerHTML = '';
    document.getElementById('modal-add-friend-input').value = '';
}
function closeAddFriendBar() {
    document.getElementById('add-friend-bar').style.display = 'none';
}

/* ---- Status ---- */
function setUserStatus(status) {
    document.querySelectorAll('.status-pill').forEach(p => p.classList.remove('selected'));
    document.getElementById('sp-' + status)?.classList.add('selected');
    // Update user status in Firebase
    if(window._setUserStatusFirebase) window._setUserStatusFirebase(status);
    // Update sidebar dot
    const dot = document.getElementById('sb-user-status-dot');
    if(dot) {
        dot.className = 'sb-user-status s-dot ' + (status === 'invisible' ? 'offline' : status);
    }
    showToast('Status güncəlləndi', 'success', 2000);
}

/* ---- Profile save ---- */
function saveProfile() {
    const displayName = document.getElementById('edit-displayname')?.value.trim();
    const bio = document.getElementById('edit-bio')?.value.trim();
    if(!displayName) { showToast('Ad boş ola bilməz', 'error'); return; }
    if(window._saveProfileFirebase) window._saveProfileFirebase({ displayName, bio });
    // Update display
    document.getElementById('profile-display-name').textContent = displayName;
    showToast('Profil yadda saxlandı! ✅', 'success');
}

/* ---- Profile stats (placeholder) ---- */
function loadProfileStats() {
    if(window._loadProfileStatsFirebase) window._loadProfileStatsFirebase();
}

function updateProfileStats(friends, chats, msgs) {
    const sf = document.getElementById('stat-friends');
    const sc = document.getElementById('stat-chats');
    const sm = document.getElementById('stat-msgs');
    if(sf) sf.textContent = friends || 0;
    if(sc) sc.textContent = chats || 0;
    if(sm) sm.textContent = msgs || 0;
}

/* ---- Confirm delete account ---- */
function confirmDeleteAccount() {
    if(confirm('Hesabınızı silmək istədiyinizə əminsiniz? Bu əməliyyat geri qaytarıla bilməz!')) {
        if(window._deleteAccountFirebase) window._deleteAccountFirebase();
    }
}

/* ---- Avatar generator for friend cards ---- */
function makeAvatarStyle(id, name) {
    const colors = [['#0ea5e9','#6366f1'],['#10b981','#06b6d4'],['#f59e0b','#ef4444'],['#8b5cf6','#ec4899'],['#14b8a6','#3b82f6']];
    const seed = (id+name).split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const [c1,c2] = colors[seed % colors.length];
    return `linear-gradient(135deg,${c1},${c2})`;
}

/* ---- Friends list rendering ---- */
function renderFriendsList(friends, type) {
    const container = document.getElementById('friends-list-content');
    if(!container) return;
    if(!friends || friends.length === 0) {
        const emptyTexts = {
            online: { icon:'🌙', title:'Kimse çevrimiçi değil', text:'Dostlarınız çevrimdışıdır.' },
            all: { icon:'👥', title:'Dostunuz yoxdur', text:'Dost əlavə etmək üçün "Dost Əlavə Et" düyməsinə basın.' },
            pending: { icon:'📨', title:'Gözləyən sorğu yoxdur', text:'Dost sorğusu almadınız.' }
        };
        const e = emptyTexts[type] || emptyTexts.all;
        container.innerHTML = `
            <div class="empty-state">
                <div class="e-icon">${e.icon}</div>
                <div class="e-title">${e.title}</div>
                <div class="e-text">${e.text}</div>
            </div>`;
        return;
    }

    let html = '';
    if(type !== 'pending') {
        html += `<div class="section-label">${type === 'online' ? '🟢 Onlayn' : '👥'} — ${friends.length}</div>`;
    } else {
        html += `<div class="section-label">📨 Gələn sorğular — ${friends.length}</div>`;
    }

    friends.forEach(f => {
        const avStyle = makeAvatarStyle(f.uid, f.displayName);
        const initials = (f.displayName||'?')[0].toUpperCase();
        const statusClass = f.status || 'offline';
        const statusLabel = { online:'Onlayn', away:'Meşğul', dnd:'Narahat etmə', offline:'Oflayn' }[statusClass] || 'Oflayn';

        if(type === 'pending') {
            // Incoming request
            html += `
            <div class="friend-card">
                <div class="av-sm" style="background:${avStyle}">
                    ${initials}
                    <div class="s-dot ${statusClass}"></div>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${esc(f.displayName)}</div>
                    <div class="friend-sub">@${esc(f.username||'')}</div>
                </div>
                <div class="friend-actions" style="opacity:1;">
                    <button class="fa-btn green" onclick="acceptFriendRequest('${f.uid}','${esc(f.displayName)}')" title="Qəbul et">✓</button>
                    <button class="fa-btn red" onclick="declineFriendRequest('${f.uid}')" title="Rədd et">✕</button>
                </div>
            </div>`;
        } else {
            // Normal friend
            html += `
            <div class="friend-card" onclick="openDmWith('${f.uid}','${esc(f.displayName)}')">
                <div class="av-sm" style="background:${avStyle}">
                    ${initials}
                    <div class="s-dot ${statusClass}"></div>
                </div>
                <div class="friend-info">
                    <div class="friend-name">${esc(f.displayName)}</div>
                    <div class="friend-sub">${statusLabel}</div>
                </div>
                <div class="friend-actions">
                    <button class="fa-btn blue" onclick="event.stopPropagation();openDmWith('${f.uid}','${esc(f.displayName)}')" title="Mesaj göndər">💬</button>
                    <button class="fa-btn red" onclick="event.stopPropagation();removeFriend('${f.uid}')" title="Dostu sil">🗑</button>
                </div>
            </div>`;
        }
    });

    container.innerHTML = html;
}

/* ---- Outgoing requests section ---- */
function renderOutgoingRequests(requests) {
    const container = document.getElementById('friends-list-content');
    if(!container || !requests || requests.length === 0) return;
    let extra = `<div class="section-label" style="margin-top:16px;">📤 Göndərilən sorğular — ${requests.length}</div>`;
    requests.forEach(r => {
        const avStyle = makeAvatarStyle(r.uid, r.displayName);
        const initials = (r.displayName||'?')[0].toUpperCase();
        extra += `
        <div class="friend-card">
            <div class="av-sm" style="background:${avStyle}">${initials}</div>
            <div class="friend-info">
                <div class="friend-name">${esc(r.displayName)}</div>
                <div class="friend-sub">Gözləyir...</div>
            </div>
            <div class="friend-actions" style="opacity:1;">
                <button class="fa-btn red" onclick="cancelFriendRequest('${r.uid}')" title="Geri al">✕</button>
            </div>
        </div>`;
    });
    container.innerHTML += extra;
}

/* ---- Add friend search result rendering ---- */
function renderAddFriendResult(user, alreadyFriend = false, pendingOut = false, isMe = false) {
    const container = document.getElementById('add-friend-result');
    if(!container) return;
    if(!user) {
        container.innerHTML = `<div style="color:var(--danger);font-size:13px;padding:10px;">İstifadəçi tapılmadı.</div>`;
        return;
    }
    const avStyle = makeAvatarStyle(user.uid, user.displayName);
    const initials = (user.displayName||'?')[0].toUpperCase();
    let actionBtn = '';
    if(isMe) {
        actionBtn = `<span style="font-size:12px;color:var(--text-muted);">Bu sizsiniz</span>`;
    } else if(alreadyFriend) {
        actionBtn = `<span style="font-size:12px;color:var(--success);">✓ Artıq dostdur</span>`;
    } else if(pendingOut) {
        actionBtn = `<span style="font-size:12px;color:var(--warning);">Sorğu göndərildi</span>`;
    } else {
        actionBtn = `<button class="btn btn-primary btn-sm" onclick="sendFriendRequest('${user.uid}','${esc(user.displayName)}')" style="width:auto;padding:8px 14px;">+ Dost əlavə et</button>`;
    }
    container.innerHTML = `
        <div class="add-friend-search-result">
            <div class="av-sm" style="background:${avStyle};width:44px;height:44px;font-size:18px;">${initials}</div>
            <div style="flex:1;">
                <div style="font-size:15px;font-weight:700;">${esc(user.displayName)}</div>
                <div style="font-size:12px;color:var(--text-muted);">@${esc(user.username||'')}</div>
            </div>
            ${actionBtn}
        </div>`;
}

/* ---- DM ---- */
let _currentDmPartnerId = null;
let _currentDmPartnerName = null;

function openDmWith(uid, name) {
    _currentDmPartnerId = uid;
    _currentDmPartnerName = name;
    // Update DM header
    const nameEl = document.getElementById('dm-partner-name');
    const avEl   = document.getElementById('dm-partner-av');
    if(nameEl) nameEl.textContent = name;
    if(avEl)   {
        avEl.style.background = makeAvatarStyle(uid, name);
        avEl.textContent = (name||'?')[0].toUpperCase();
    }
    // Clear messages and load
    const msgs = document.getElementById('dm-messages');
    if(msgs) msgs.innerHTML = '';
    // Close friends panel, open DM panel
    document.getElementById('panel-friends').classList.remove('open');
    document.getElementById('panel-dm').classList.add('open');
    document.getElementById('sb-dms')?.classList.add('active');
    document.getElementById('sb-friends')?.classList.remove('active');
    _activePanel = 'dms';
    // Load DM conversation from Firebase
    if(window._loadDmConversation) window._loadDmConversation(uid);
}

function loadDmConversations() {
    if(window._loadDmConversationsFirebase) window._loadDmConversationsFirebase();
}

function renderDmConversationsList(conversations) {
    const container = document.getElementById('dm-conversations-list');
    if(!container) return;
    if(!conversations || conversations.length === 0) {
        container.innerHTML = `<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px;">Heç bir mesaj yoxdur</div>`;
        return;
    }
    container.innerHTML = conversations.map(c => {
        const avStyle = makeAvatarStyle(c.uid, c.name);
        const initials = (c.name||'?')[0].toUpperCase();
        return `
        <div class="dm-list-item ${c.uid === _currentDmPartnerId ? 'active' : ''}" onclick="openDmWith('${c.uid}','${esc(c.name)}')">
            <div class="av-sm" style="background:${avStyle};width:36px;height:36px;font-size:14px;">${initials}</div>
            <div class="dm-list-text">
                <div class="dm-list-name">${esc(c.name)}</div>
                <div class="dm-list-preview">${esc(c.lastMsg||'')}</div>
            </div>
            ${c.unread ? `<div class="dm-unread show">${c.unread}</div>` : ''}
        </div>`;
    }).join('');
}

/* ---- Render a DM message ---- */
function addDmMessage({ id, text, isSelf, timestamp, type='text', imageData }) {
    const container = document.getElementById('dm-messages');
    if(!container) return;
    const wrapper = document.createElement('div');
    wrapper.className = `msg-wrapper ${isSelf?'self':'other'}`;
    wrapper.dataset.msgId = id || Date.now();
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    if(type === 'image' && imageData) {
        const img = document.createElement('img');
        img.className = 'msg-image';
        img.src = imageData;
        img.onclick = () => openLightbox(imageData);
        bubble.appendChild(img);
    } else {
        bubble.innerHTML = `<span>${esc(text||'')}</span>`;
    }
    // Reactions
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    REACTIONS.forEach(emoji => {
        const btn = document.createElement('span');
        btn.className = 'reaction-emoji';
        btn.textContent = emoji;
        btn.onclick = (e) => { e.stopPropagation(); addReactionToMsg(wrapper.dataset.msgId, emoji, isSelf); };
        picker.appendChild(btn);
    });
    bubble.appendChild(picker);
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.innerHTML = `<span class="msg-time">${formatDate(timestamp)}</span>${isSelf?'<span class="msg-ticks">✓✓</span>':''}`;
    wrapper.appendChild(bubble);
    wrapper.appendChild(meta);
    attachReactionListeners(wrapper, wrapper.dataset.msgId);
    container.appendChild(wrapper);
    container.scrollTop = container.scrollHeight;
}

function triggerDmImagePicker() {
    document.getElementById('dm-image-picker')?.click();
}

function handleDmImageSelected(event) {
    const file = event.target.files[0];
    if(!file) return;
    if(file.size > 3 * 1024 * 1024) { showToast('Şəkil 3MB-dan kiçik olmalıdır', 'error'); return; }
    const reader = new FileReader();
    reader.onload = (e) => { if(window._sendDmImage) window._sendDmImage(e.target.result); };
    reader.readAsDataURL(file);
    event.target.value = '';
}

/* ---- Placeholder functions called by Firebase module ---- */
window.loadFriendsList = function() {
    if(window._loadFriendsFirebase) window._loadFriendsFirebase(_friendsTab);
};

window.searchAndAddFriend = function() {
    const val = document.getElementById('add-friend-input')?.value.trim();
    if(!val) return;
    if(window._searchUserFirebase) window._searchUserFirebase(val);
};

window.modalSearchFriend = function() {
    const val = document.getElementById('modal-add-friend-input')?.value.trim();
    if(!val) return;
    if(window._searchUserFirebase) window._searchUserFirebase(val);
};

window.sendFriendRequest = function(uid, name) {
    if(window._sendFriendRequestFirebase) window._sendFriendRequestFirebase(uid, name);
    closeAddFriendModal();
};
window.acceptFriendRequest = function(uid, name) {
    if(window._acceptFriendRequestFirebase) window._acceptFriendRequestFirebase(uid, name);
};
window.declineFriendRequest = function(uid) {
    if(window._declineFriendRequestFirebase) window._declineFriendRequestFirebase(uid);
};
window.cancelFriendRequest = function(uid) {
    if(window._cancelFriendRequestFirebase) window._cancelFriendRequestFirebase(uid);
};
window.removeFriend = function(uid) {
    if(confirm('Bu dostu silmək istədiyinizə əminsiniz?')) {
        if(window._removeFriendFirebase) window._removeFriendFirebase(uid);
    }
};
window.sendDmMessage = function() {
    const input = document.getElementById('dm-message-input');
    const text = input?.value.trim();
    if(!text || !_currentDmPartnerId) return;
    input.value = '';
    input.style.height = 'auto';
    if(window._sendDmFirebase) window._sendDmFirebase(text);
};
</script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
    getFirestore, doc, updateDoc, onSnapshot, runTransaction,
    deleteDoc, serverTimestamp, arrayUnion, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---- Firebase Config ---- */
const firebaseConfig = {
    apiKey: "AIzaSyAAbLWwzSE9WgqFKK_n9hqsl5mokZlNacM",
    authDomain: "axtargetbot.firebaseapp.com",
    projectId: "axtargetbot",
    storageBucket: "axtargetbot.firebasestorage.app",
    messagingSenderId: "509543495829",
    appId: "1:509543495829:web:833feb9c271328f8e4039c"
};

const CHAT_COLLECTION = `artifacts/axtarget-anonimchat/public/data/chats`;
const MATCH_QUEUE_DOC = 'match_queue_doc';
const MATCHING_SECONDS = 20;
const HEARTBEAT_TIMEOUT = 10000;

/* ---- State ---- */
let app, db, auth;
let userId = null, userName = null;
let chatId = null, partnerId = null, partnerLanguage = null;
let isAuthReady = false;
let unsubscribeChat = null;
let matchingTimeout = null;
let typingTimeout = null;
let heartbeatInterval = null, partnerHeartbeatInterval = null;
let isFirstSnapshot = true;

/* ---- Initialize ---- */
async function initFirebase() {
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                // Hide loading overlay
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.add('hide');
                setTimeout(() => overlay.remove(), 600);
            } else {
                await signInAnonymously(auth);
            }
        });
    } catch (e) {
        console.error('Firebase init error:', e);
        showToast('Bağlantı xətası', 'error');
    }
}

/* ---- Heartbeat ---- */
function startHeartbeat() {
    if (heartbeatInterval) clearInterval(heartbeatInterval);
    heartbeatInterval = setInterval(async () => {
        if (!userId || !chatId) return;
        try {
            await updateDoc(doc(db, CHAT_COLLECTION, userId), {
                lastSeen: serverTimestamp(),
                isOnline: true,
                heartbeat: serverTimestamp(),
                language: lang
            });
        } catch(e) {}
    }, 3000);
}

function startPartnerCheck() {
    if (partnerHeartbeatInterval) clearInterval(partnerHeartbeatInterval);
    partnerHeartbeatInterval = setInterval(async () => {
        if (!partnerId || !chatId) return;
        try {
            const snap = await getDoc(doc(db, CHAT_COLLECTION, partnerId));
            if (snap.exists()) {
                const data = snap.data();
                const last = data.heartbeat?.toDate?.() || data.lastSeen?.toDate?.();
                if (last) {
                    const diff = Date.now() - last.getTime();
                    const avatar = document.getElementById('partner-avatar');
                    const statusEl = document.getElementById('partner-status');
                    if (diff < HEARTBEAT_TIMEOUT) {
                        avatar.classList.remove('offline');
                        statusEl.innerHTML = `<span style="color:var(--success)">●</span><span>${T[lang].activeText}</span>`;
                    } else {
                        avatar.classList.add('offline');
                        statusEl.innerHTML = `<span style="color:var(--text-muted)">●</span><span>Offline</span>`;
                    }
                }
            }
        } catch(e) {}
    }, 5000);
}

function stopHeartbeat() {
    if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval = null; }
    if (partnerHeartbeatInterval) { clearInterval(partnerHeartbeatInterval); partnerHeartbeatInterval = null; }
}

/* ---- handleStart ---- */
window.handleStart = async function() {
    if (!isAuthReady || !userId) {
        showToast(T[lang].connecting, 'info');
        await new Promise(r => setTimeout(r, 1500));
        if (!isAuthReady) return;
    }

    const nameInput = document.getElementById('user-name-input').value.trim();
    const randomNames = ['Anonim','Qaranlıq','Gizli','Naməlum','Sirlər'];
    userName = nameInput || randomNames[Math.floor(Math.random() * randomNames.length)] + '_' + Math.floor(Math.random() * 999);

    showScreen('matching-screen');

    // Countdown
    let remaining = MATCHING_SECONDS;
    document.getElementById('countdown-display').textContent = `⏱ ${T[lang].activeText !== 'Aktiv' ? 'Kalan süre:' : 'Qalan vaxt:'} ${remaining} ${lang === 'az' ? 'saniyə' : 'saniye'}`;
    document.getElementById('retry-wrap').style.display = 'none';

    matchingTimeout = setInterval(() => {
        remaining--;
        document.getElementById('countdown-display').textContent = `⏱ ${lang === 'az' ? 'Qalan vaxt' : 'Kalan süre'}: ${remaining} ${lang === 'az' ? 'saniyə' : 'saniye'}`;
        if (remaining <= 0) {
            clearInterval(matchingTimeout);
            document.getElementById('retry-wrap').style.display = 'block';
        }
    }, 1000);

    await startMatching();
};

async function startMatching() {
    try {
        const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC);

        await runTransaction(db, async (transaction) => {
            const queueDoc = await transaction.get(queueRef);
            const qData = queueDoc.data() || {};

            if (queueDoc.exists() && qData.waitingUserId && qData.waitingUserId !== userId) {
                // MATCH FOUND
                const waitingId = qData.waitingUserId;
                const waitingName = qData.waitingUserName || 'Anonim';
                const waitingLang = qData.waitingUserLanguage || 'az';
                const newChatId = [userId, waitingId].sort().join('_');

                // Clear queue
                transaction.set(queueRef, { waitingUserId: null, waitingUserName: null, waitingUserLanguage: null });

                // Create chat doc
                transaction.set(doc(db, CHAT_COLLECTION, newChatId), {
                    status: 'active',
                    users: [userId, waitingId],
                    messages: [],
                    typingStatus: {},
                    createdAt: serverTimestamp(),
                    lastActivity: serverTimestamp()
                });

                // Notify self
                transaction.set(doc(db, CHAT_COLLECTION, userId), {
                    matched: true,
                    chatId: newChatId,
                    partnerId: waitingId,
                    partnerName: waitingName,
                    partnerLanguage: waitingLang,
                    userName, userLanguage: lang, isOnline: true,
                    lastSeen: serverTimestamp(), heartbeat: serverTimestamp()
                });

                // Notify waiting user
                transaction.set(doc(db, CHAT_COLLECTION, waitingId), {
                    matched: true,
                    chatId: newChatId,
                    partnerId: userId,
                    partnerName: userName,
                    partnerLanguage: lang,
                    isOnline: true,
                    lastSeen: serverTimestamp(), heartbeat: serverTimestamp()
                });

                clearInterval(matchingTimeout);

                chatId = newChatId;
                partnerId = waitingId;
                partnerLanguage = waitingLang;

                document.getElementById('partner-name').textContent = waitingName;
                generateAvatar(waitingName, waitingId);

                setTimeout(() => {
                    shakeScreen();
                    launchConfetti();
                    showToast(T[lang].matchFound, 'success');
                    showScreen('chat-screen');
                    setupChatListener();
                    startHeartbeat();
                    startPartnerCheck();
                    deleteDoc(doc(db, CHAT_COLLECTION, userId)).catch(()=>{});
                }, 300);

            } else {
                // Add to queue
                transaction.set(queueRef, {
                    waitingUserId: userId,
                    waitingUserName: userName,
                    waitingUserLanguage: lang,
                    timestamp: serverTimestamp()
                });

                transaction.set(doc(db, CHAT_COLLECTION, userId), {
                    status: 'waiting',
                    userName, userLanguage: lang,
                    isOnline: true, lastSeen: serverTimestamp(), heartbeat: serverTimestamp()
                });

                startHeartbeat();
                setupMatchingListener();
            }
        });
    } catch(e) {
        console.error('Matching error:', e);
        showToast(T[lang].msgError, 'error');
    }
}

function setupMatchingListener() {
    const userRef = doc(db, CHAT_COLLECTION, userId);
    if (unsubscribeChat) unsubscribeChat();

    unsubscribeChat = onSnapshot(userRef, (snap) => {
        if (snap.exists() && snap.data().matched) {
            const data = snap.data();
            chatId = data.chatId;
            partnerId = data.partnerId;
            partnerLanguage = data.partnerLanguage || 'az';

            document.getElementById('partner-name').textContent = data.partnerName;
            generateAvatar(data.partnerName, partnerId);

            if (unsubscribeChat) unsubscribeChat();
            if (matchingTimeout) clearInterval(matchingTimeout);

            setTimeout(() => {
                shakeScreen();
                launchConfetti();
                showToast(T[lang].matchFound, 'success');
                showScreen('chat-screen');
                setupChatListener();
                startPartnerCheck();
                deleteDoc(userRef).catch(()=>{});
            }, 400);
        }
    });
}

function setupChatListener() {
    if (!chatId) return;
    const chatRef = doc(db, CHAT_COLLECTION, chatId);
    const container = document.getElementById('chat-messages');
    const statusEl = document.getElementById('partner-status');

    if (unsubscribeChat) unsubscribeChat();
    container.innerHTML = '';
    renderedMessageIds.clear();
    isFirstSnapshot = true;

    unsubscribeChat = onSnapshot(chatRef, (snap) => {
        if (!snap.exists()) {
            if (isFirstSnapshot) { isFirstSnapshot = false; return; }
            if (unsubscribeChat) unsubscribeChat();
            addSystemMessage(T[lang].partnerLeft);
            setTimeout(() => openFeedback(), 1800);
            return;
        }

        isFirstSnapshot = false;
        const data = snap.data();

        if (data.status === 'active') {
            // Typing indicator
            const isTyping = data.typingStatus?.[partnerId];
            if (isTyping) {
                statusEl.innerHTML = `
                    <span style="color:var(--warning)">✍️</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>${T[lang].typingText}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color:var(--success)">●</span><span id="t-activeText">${T[lang].activeText}</span>`;
            }

            // Render messages
            const messages = data.messages || [];
            messages.forEach((msg, idx) => {
                const id = `${msg.senderId}-${msg.timestamp}-${idx}`;
                if (renderedMessageIds.has(id)) return;
                addMessage({
                    id,
                    senderName: msg.senderName,
                    text: msg.text || '',
                    isSelf: msg.senderId === userId,
                    timestamp: msg.timestamp,
                    type: msg.type || 'text',
                    imageData: msg.imageData,
                    voiceDuration: msg.voiceDuration
                });
                // Mark read
                if (msg.senderId !== userId) {
                    markMessageRead(id);
                }
            });

            // Reactions sync
            if (data.reactions) {
                Object.entries(data.reactions).forEach(([msgRef, emojis]) => {
                    if (emojis) {
                        Object.entries(emojis).forEach(([emoji, count]) => {
                            // Update reaction display
                        });
                    }
                });
            }
        } else if (data.status === 'closed') {
            if (data.closedBy !== userId) {
                if (unsubscribeChat) unsubscribeChat();
                addSystemMessage(T[lang].partnerLeft);
                setTimeout(() => openFeedback(), 1800);
            }
        }
    }, (err) => console.error('Chat listener error:', err));
}

/* Mark message as read — show blue ticks */
function markMessageRead(msgId) {
    const el = document.getElementById(`ticks-${msgId}`);
    if (el) { el.classList.add('read'); el.textContent = '✓✓'; }
}

/* ---- Send Reaction to Firebase ---- */
async function sendReactionToFirebase(msgRef, emoji) {
    if (!chatId || !userId) return;
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            [`reactions.${msgRef}.${emoji}`]: arrayUnion(userId),
            lastActivity: serverTimestamp()
        });
    } catch(e) {}
}

/* ---- Send Message ---- */
window.sendMessage = async function() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text || !chatId || !userId) return;

    input.value = '';
    input.style.height = 'auto';

    const msgData = {
        senderId: userId,
        senderName: userName,
        text,
        type: 'text',
        timestamp: new Date().toISOString()
    };

    // Optimistic UI
    addMessage({
        id: `opt-${Date.now()}`,
        senderName: userName,
        text,
        isSelf: true,
        timestamp: msgData.timestamp
    });

    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            [`typingStatus.${userId}`]: false,
            messages: arrayUnion(msgData),
            lastActivity: serverTimestamp()
        });
    } catch(e) {
        console.error('Send error:', e);
        showToast(T[lang].msgError, 'error');
        input.value = text;
    }
};

/* ---- Send Image ---- */
window.sendImageMessage = async function(base64) {
    if (!chatId || !userId) return;
    showToast(lang === 'az' ? 'Şəkil göndərilir...' : 'Fotoğraf gönderiliyor...', 'info', 2000);
    const msgData = {
        senderId: userId, senderName: userName,
        type: 'image', imageData: base64,
        timestamp: new Date().toISOString(), text: ''
    };
    addMessage({ id: `img-${Date.now()}`, senderName: userName, isSelf: true, timestamp: msgData.timestamp, type: 'image', imageData: base64 });
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            messages: arrayUnion(msgData),
            lastActivity: serverTimestamp()
        });
    } catch(e) {
        showToast(T[lang].msgError, 'error');
    }
};

/* ---- Send Voice ---- */
window.sendVoiceMessage = async function(duration) {
    if (!chatId || !userId) return;
    const msgData = {
        senderId: userId, senderName: userName,
        type: 'voice', voiceDuration: duration,
        timestamp: new Date().toISOString(), text: ''
    };
    addMessage({ id: `voice-${Date.now()}`, senderName: userName, isSelf: true, timestamp: msgData.timestamp, type: 'voice', voiceDuration: duration });
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            messages: arrayUnion(msgData),
            lastActivity: serverTimestamp()
        });
    } catch(e) {}
};

/* ---- Typing ---- */
window.handleTyping = async function() {
    if (!chatId || !userId) return;
    const text = document.getElementById('message-input').value.trim();
    if (typingTimeout) clearTimeout(typingTimeout);
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            [`typingStatus.${userId}`]: text.length > 0,
            lastActivity: serverTimestamp()
        });
    } catch(e) {}
    typingTimeout = setTimeout(async () => {
        try {
            await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
                [`typingStatus.${userId}`]: false
            });
        } catch(e) {}
    }, 2000);
};

/* ---- Feedback ---- */
function openFeedback() {
    stopHeartbeat();
    document.getElementById('feedback-modal').classList.add('open');
    chatId = null; partnerId = null; partnerLanguage = null;
    renderedMessageIds.clear();
}

/* ---- Handle Close Chat ---- */
window.handleCloseChat = async function() {
    if (!chatId) { await disconnect(true); return; }
    const cId = chatId;
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, cId), { status: 'closed', closedBy: userId });
    } catch(e) {}
    await disconnect(false);
    setTimeout(() => {
        try { deleteDoc(doc(db, CHAT_COLLECTION, cId)); } catch(e) {}
    }, 500);
    openFeedback();
};

/* ---- Handle Change Chat ---- */
window.handleChangeChat = async function() {
    if (!chatId) return;
    const cId = chatId;
    showToast(lang === 'az' ? 'Yeni söhbət axtarılır...' : 'Yeni sohbet aranıyor...', 'info');
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, cId), { status: 'closed', closedBy: userId });
    } catch(e) {}
    await disconnect(false);
    setTimeout(() => { try { deleteDoc(doc(db, CHAT_COLLECTION, cId)); } catch(e) {} }, 300);
    document.getElementById('chat-messages').innerHTML = '';
    renderedMessageIds.clear();
    showScreen('matching-screen');
    await handleStart();
};

/* ---- Handle Cancel Matching ---- */
window.handleCancelMatching = async function() {
    if (matchingTimeout) clearInterval(matchingTimeout);
    await disconnect(false);
    showScreen('start-screen');
};

/* ---- Disconnect ---- */
async function disconnect(clearUI = true) {
    stopHeartbeat();
    if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
    if (matchingTimeout) { clearInterval(matchingTimeout); matchingTimeout = null; }
    if (typingTimeout) { clearTimeout(typingTimeout); typingTimeout = null; }

    try {
        const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC);
        await runTransaction(db, async (tx) => {
            const qDoc = await tx.get(queueRef);
            if (qDoc.exists() && qDoc.data().waitingUserId === userId) {
                tx.set(queueRef, { waitingUserId: null, waitingUserName: null, waitingUserLanguage: null });
            }
        });
    } catch(e) {}

    try { await deleteDoc(doc(db, CHAT_COLLECTION, userId)); } catch(e) {}

    chatId = null; partnerId = null; partnerLanguage = null;
    if (clearUI) {
        document.getElementById('chat-messages').innerHTML = '';
        renderedMessageIds.clear();
    }
}

/* ---- Cleanup on unload ---- */
window.addEventListener('beforeunload', async () => {
    stopHeartbeat();
    try {
        if (chatId) await updateDoc(doc(db, CHAT_COLLECTION, chatId), { status: 'closed', closedBy: userId });
        await deleteDoc(doc(db, CHAT_COLLECTION, userId));
        const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC);
        await runTransaction(db, async (tx) => {
            const qDoc = await tx.get(queueRef);
            if (qDoc.exists() && qDoc.data().waitingUserId === userId) {
                tx.set(queueRef, { waitingUserId: null, waitingUserName: null, waitingUserLanguage: null });
            }
        });
    } catch(e) {}
});

/* ---- Tab visibility ---- */
document.addEventListener('visibilitychange', () => {
    if (document.hidden) { stopHeartbeat(); }
    else if (userId && chatId) { startHeartbeat(); startPartnerCheck(); }
});

/* ---- Close reaction pickers on outside click ---- */
document.addEventListener('click', () => {
    document.querySelectorAll('.reaction-picker.visible').forEach(p => p.classList.remove('visible'));
});

/* ---- Scroll tracking ---- */
msgsContainer().addEventListener('scroll', () => {
    const c = document.getElementById('chat-messages');
    shouldAutoScroll = c.scrollHeight - c.scrollTop - c.clientHeight < 150;
});

/* ---- BOOT ---- */
applyTranslations();
initFirebase();

</script>

<!-- =====================================================
     NEW: FIREBASE — Auth / Friends / DM / Profile
===================================================== -->
<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged as onAuthChanged,
    deleteUser
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
    getFirestore,
    doc, setDoc, getDoc, updateDoc, deleteDoc,
    collection, query, where, getDocs,
    onSnapshot, serverTimestamp, arrayUnion, arrayRemove,
    increment
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---- Firebase (reuse existing app if already initialized) ---- */
const firebaseConfig = {
    apiKey: "AIzaSyAAbLWwzSE9WgqFKK_n9hqsl5mokZlNacM",
    authDomain: "axtargetbot.firebaseapp.com",
    projectId: "axtargetbot",
    storageBucket: "axtargetbot.firebasestorage.app",
    messagingSenderId: "509543495829",
    appId: "1:509543495829:web:833feb9c271328f8e4039c"
};

const fbApp = getApps().find(a => a.name === '[DEFAULT]') || initializeApp(firebaseConfig, 'social');
const db2   = getFirestore(fbApp);
const auth2 = getAuth(fbApp);

/* ---- Firestore collections ---- */
const USERS_COL     = 'artifacts/axtarget-anonimchat/public/data/users';
const FRIENDS_COL   = 'artifacts/axtarget-anonimchat/public/data/friends';
const DM_COL        = 'artifacts/axtarget-anonimchat/public/data/dms';

/* ---- Current user state ---- */
let _myUid  = null;
let _myProfile = null;
let _unsubFriends = null;
let _unsubDm = null;
let _pendingCount = 0;

/* ==================================================
   REGISTRATION
================================================== */
window.doRegister = async function() {
    const username     = document.getElementById('register-username')?.value.trim().toLowerCase();
    const displayName  = document.getElementById('register-displayname')?.value.trim();
    const email        = document.getElementById('register-email')?.value.trim();
    const password     = document.getElementById('register-password')?.value;

    if(!username || !displayName || !email || !password) {
        showAuthError('auth-register-error', 'Bütün sahələri doldurun.');
        return;
    }
    if(username.length < 3) { showAuthError('auth-register-error', 'İstifadəçi adı ən az 3 simvol olmalıdır.'); return; }
    if(password.length < 6) { showAuthError('auth-register-error', 'Şifrə ən az 6 simvol olmalıdır.'); return; }

    setAuthBtnLoading('register-btn', true);
    try {
        // Check username uniqueness
        const usernameQuery = query(collection(db2, USERS_COL), where('username','==', username));
        const snap = await getDocs(usernameQuery);
        if(!snap.empty) {
            showAuthError('auth-register-error', 'Bu istifadəçi adı artıq mövcuddur.');
            setAuthBtnLoading('register-btn', false);
            return;
        }

        // Create account
        const cred = await createUserWithEmailAndPassword(auth2, email, password);
        const uid  = cred.user.uid;

        // Save profile
        const profile = {
            uid, username, displayName, email,
            bio: '',
            status: 'online',
            createdAt: serverTimestamp(),
            friendCount: 0,
            chatCount: 0,
            msgCount: 0,
            friends: [],
            pendingIn: [],
            pendingOut: []
        };
        await setDoc(doc(db2, USERS_COL, uid), profile);

        _myUid = uid;
        _myProfile = profile;
        onAuthSuccess(profile);
        showToast(`Xoş gəldiniz, ${displayName}! 🎉`, 'success');
    } catch(e) {
        const msg = e.code === 'auth/email-already-in-use' ? 'Bu e-poçt artıq istifadə olunur.' :
                    e.code === 'auth/invalid-email' ? 'E-poçt formatı səhvdir.' : e.message;
        showAuthError('auth-register-error', msg);
    }
    setAuthBtnLoading('register-btn', false);
};

/* ==================================================
   LOGIN
================================================== */
window.doLogin = async function() {
    const email    = document.getElementById('login-email')?.value.trim();
    const password = document.getElementById('login-password')?.value;
    if(!email || !password) { showAuthError('auth-login-error', 'E-poçt və şifrəni daxil edin.'); return; }

    setAuthBtnLoading('login-btn', true);
    try {
        const cred = await signInWithEmailAndPassword(auth2, email, password);
        const uid  = cred.user.uid;
        // Load profile
        const snap = await getDoc(doc(db2, USERS_COL, uid));
        if(snap.exists()) {
            _myUid = uid;
            _myProfile = snap.data();
            // Set online
            await updateDoc(doc(db2, USERS_COL, uid), { status: 'online', lastSeen: serverTimestamp() });
            onAuthSuccess(_myProfile);
            showToast(`Xoş gəldiniz, ${_myProfile.displayName}! 👋`, 'success');
            // Start listening for friend notifications
            startFriendsListener();
        } else {
            showAuthError('auth-login-error', 'Profil tapılmadı. Yenidən qeydiyyatdan keçin.');
        }
    } catch(e) {
        const msg = e.code === 'auth/user-not-found' ? 'İstifadəçi tapılmadı.' :
                    e.code === 'auth/wrong-password' ? 'Şifrə səhvdir.' :
                    e.code === 'auth/invalid-credential' ? 'E-poçt və ya şifrə səhvdir.' : e.message;
        showAuthError('auth-login-error', msg);
    }
    setAuthBtnLoading('login-btn', false);
};

/* ==================================================
   LOGOUT
================================================== */
window.doLogout = async function() {
    if(!confirm('Çıxmaq istədiyinizə əminsiniz?')) return;
    if(_myUid) {
        try { await updateDoc(doc(db2, USERS_COL, _myUid), { status: 'offline', lastSeen: serverTimestamp() }); } catch(e){}
    }
    if(_unsubFriends) { _unsubFriends(); _unsubFriends = null; }
    if(_unsubDm) { _unsubDm(); _unsubDm = null; }
    try { await signOut(auth2); } catch(e){}
    _myUid = null; _myProfile = null;
    document.body.classList.remove('logged-in');
    document.querySelectorAll('.dc-panel').forEach(p => p.classList.remove('open'));
    document.getElementById('auth-screen').classList.remove('hidden');
    showToast('Çıxış edildi', 'info');
};

/* ==================================================
   DELETE ACCOUNT
================================================== */
window._deleteAccountFirebase = async function() {
    if(!_myUid) return;
    try {
        await deleteDoc(doc(db2, USERS_COL, _myUid));
        const user = auth2.currentUser;
        if(user) await deleteUser(user);
        _myUid = null; _myProfile = null;
        document.body.classList.remove('logged-in');
        document.querySelectorAll('.dc-panel').forEach(p => p.classList.remove('open'));
        document.getElementById('auth-screen').classList.remove('hidden');
        showToast('Hesabınız silindi.', 'info');
    } catch(e) {
        showToast('Hesab silinərkən xəta: ' + e.message, 'error');
    }
};

/* ==================================================
   PROFILE — Save & Status
================================================== */
window._saveProfileFirebase = async function({ displayName, bio }) {
    if(!_myUid) return;
    try {
        await updateDoc(doc(db2, USERS_COL, _myUid), { displayName, bio });
        if(_myProfile) { _myProfile.displayName = displayName; _myProfile.bio = bio; }
        loadUserProfile(_myProfile);
    } catch(e) { showToast('Xəta: ' + e.message, 'error'); }
};

window._setUserStatusFirebase = async function(status) {
    if(!_myUid) return;
    try { await updateDoc(doc(db2, USERS_COL, _myUid), { status, lastSeen: serverTimestamp() }); } catch(e){}
};

window._loadProfileStatsFirebase = async function() {
    if(!_myUid) return;
    try {
        const snap = await getDoc(doc(db2, USERS_COL, _myUid));
        if(snap.exists()) {
            const d = snap.data();
            updateProfileStats(d.friends?.length || d.friendCount || 0, d.chatCount || 0, d.msgCount || 0);
        }
    } catch(e){}
};

/* ==================================================
   FRIENDS LISTENER — Real-time pending notifications
================================================== */
function startFriendsListener() {
    if(!_myUid) return;
    if(_unsubFriends) { _unsubFriends(); }

    _unsubFriends = onSnapshot(doc(db2, USERS_COL, _myUid), (snap) => {
        if(!snap.exists()) return;
        const data = snap.data();
        _myProfile = { ..._myProfile, ...data };
        const pending = data.pendingIn || [];
        _pendingCount = pending.length;
        // Update badge
        const badge = document.getElementById('sb-friend-badge');
        const ftabBadge = document.getElementById('ftab-pending-badge');
        if(badge) {
            badge.textContent = _pendingCount;
            badge.classList.toggle('show', _pendingCount > 0);
        }
        if(ftabBadge) {
            ftabBadge.textContent = _pendingCount;
            ftabBadge.classList.toggle('show', _pendingCount > 0);
        }
        // Refresh friends list if open
        if(_activePanel === 'friends') loadFriendsList();
    });
}

/* ==================================================
   SEARCH USER
================================================== */
window._searchUserFirebase = async function(usernameOrId) {
    const clean = usernameOrId.replace('@','').toLowerCase().trim();
    try {
        // Search by username
        const q = query(collection(db2, USERS_COL), where('username','==', clean));
        const snap = await getDocs(q);
        if(snap.empty) {
            renderAddFriendResult(null);
            return;
        }
        const user = { uid: snap.docs[0].id, ...snap.docs[0].data() };
        const isMe = user.uid === _myUid;
        const myData = _myProfile || {};
        const alreadyFriend = (myData.friends || []).includes(user.uid);
        const pendingOut = (myData.pendingOut || []).includes(user.uid);
        renderAddFriendResult(user, alreadyFriend, pendingOut, isMe);
    } catch(e) {
        renderAddFriendResult(null);
    }
};

/* ==================================================
   SEND FRIEND REQUEST
================================================== */
window._sendFriendRequestFirebase = async function(targetUid, targetName) {
    if(!_myUid || !targetUid) return;
    try {
        // Add to my pendingOut
        await updateDoc(doc(db2, USERS_COL, _myUid), {
            pendingOut: arrayUnion(targetUid)
        });
        // Add to target's pendingIn
        await updateDoc(doc(db2, USERS_COL, targetUid), {
            pendingIn: arrayUnion(_myUid)
        });
        if(_myProfile) (_myProfile.pendingOut = _myProfile.pendingOut || []).push(targetUid);
        showToast(`${targetName} adlı istifadəçiyə dost sorğusu göndərildi! 📨`, 'success');
    } catch(e) { showToast('Sorğu göndərilə bilmədi', 'error'); }
};

/* ==================================================
   ACCEPT FRIEND REQUEST
================================================== */
window._acceptFriendRequestFirebase = async function(fromUid, fromName) {
    if(!_myUid || !fromUid) return;
    try {
        // Add each other to friends list
        await updateDoc(doc(db2, USERS_COL, _myUid), {
            friends: arrayUnion(fromUid),
            pendingIn: arrayRemove(fromUid),
            friendCount: increment(1)
        });
        await updateDoc(doc(db2, USERS_COL, fromUid), {
            friends: arrayUnion(_myUid),
            pendingOut: arrayRemove(_myUid),
            friendCount: increment(1)
        });
        showToast(`${fromName} ilə dostluğunuz başladı! 🎉`, 'success');
        launchConfetti();
    } catch(e) { showToast('Sorğu qəbul edilə bilmədi', 'error'); }
};

/* ==================================================
   DECLINE FRIEND REQUEST
================================================== */
window._declineFriendRequestFirebase = async function(fromUid) {
    if(!_myUid || !fromUid) return;
    try {
        await updateDoc(doc(db2, USERS_COL, _myUid), { pendingIn: arrayRemove(fromUid) });
        await updateDoc(doc(db2, USERS_COL, fromUid), { pendingOut: arrayRemove(_myUid) });
        showToast('Sorğu rədd edildi', 'info');
    } catch(e) {}
};

/* ==================================================
   CANCEL OUTGOING FRIEND REQUEST
================================================== */
window._cancelFriendRequestFirebase = async function(targetUid) {
    if(!_myUid || !targetUid) return;
    try {
        await updateDoc(doc(db2, USERS_COL, _myUid), { pendingOut: arrayRemove(targetUid) });
        await updateDoc(doc(db2, USERS_COL, targetUid), { pendingIn: arrayRemove(_myUid) });
        showToast('Sorğu geri alındı', 'info');
    } catch(e) {}
};

/* ==================================================
   REMOVE FRIEND
================================================== */
window._removeFriendFirebase = async function(friendUid) {
    if(!_myUid || !friendUid) return;
    try {
        await updateDoc(doc(db2, USERS_COL, _myUid), {
            friends: arrayRemove(friendUid),
            friendCount: increment(-1)
        });
        await updateDoc(doc(db2, USERS_COL, friendUid), {
            friends: arrayRemove(_myUid),
            friendCount: increment(-1)
        });
        showToast('Dost siyahısından silindi', 'info');
        loadFriendsList();
    } catch(e) {}
};

/* ==================================================
   LOAD FRIENDS LIST
================================================== */
window._loadFriendsFirebase = async function(tab) {
    if(!_myUid) return;
    try {
        const snap = await getDoc(doc(db2, USERS_COL, _myUid));
        if(!snap.exists()) return;
        const myData = snap.data();
        _myProfile = { ..._myProfile, ...myData };

        if(tab === 'pending') {
            // Load pending in
            const pendingIn = myData.pendingIn || [];
            const pendingOut = myData.pendingOut || [];
            const inUsers = await Promise.all(pendingIn.map(uid => getDoc(doc(db2, USERS_COL, uid))));
            const inList = inUsers.filter(s => s.exists()).map(s => ({ uid: s.id, ...s.data() }));
            renderFriendsList(inList, 'pending');
            // Also render outgoing
            const outUsers = await Promise.all(pendingOut.map(uid => getDoc(doc(db2, USERS_COL, uid))));
            const outList = outUsers.filter(s => s.exists()).map(s => ({ uid: s.id, ...s.data() }));
            renderOutgoingRequests(outList);
            return;
        }

        const friendIds = myData.friends || [];
        if(friendIds.length === 0) { renderFriendsList([], tab); return; }

        const friendSnaps = await Promise.all(friendIds.map(uid => getDoc(doc(db2, USERS_COL, uid))));
        let friends = friendSnaps.filter(s => s.exists()).map(s => ({ uid: s.id, ...s.data() }));

        if(tab === 'online') {
            friends = friends.filter(f => f.status === 'online');
        }
        renderFriendsList(friends, tab);
    } catch(e) { console.error('Load friends error:', e); }
};

/* ==================================================
   DM — Direct Messages
================================================== */
function getDmId(uid1, uid2) {
    return [uid1, uid2].sort().join('_dm_');
}

window._loadDmConversation = function(partnerUid) {
    if(!_myUid || !partnerUid) return;
    if(_unsubDm) { _unsubDm(); _unsubDm = null; }

    const dmId = getDmId(_myUid, partnerUid);
    const dmRef = doc(db2, DM_COL, dmId);
    let renderedDmIds = new Set();

    _unsubDm = onSnapshot(dmRef, (snap) => {
        if(!snap.exists()) return;
        const data = snap.data();
        const messages = data.messages || [];
        messages.forEach((msg, i) => {
            const id = `${msg.senderId}-${msg.ts}-${i}`;
            if(!renderedDmIds.has(id)) {
                renderedDmIds.add(id);
                addDmMessage({
                    id, text: msg.text, isSelf: msg.senderId === _myUid,
                    timestamp: msg.ts, type: msg.type || 'text', imageData: msg.imageData
                });
            }
        });
    });
};

window._sendDmFirebase = async function(text) {
    if(!_myUid || !_currentDmPartnerId) return;
    const dmId = getDmId(_myUid, _currentDmPartnerId);
    const dmRef = doc(db2, DM_COL, dmId);

    // Optimistic UI
    addDmMessage({ id: `opt-${Date.now()}`, text, isSelf: true, timestamp: new Date().toISOString() });

    const msgData = {
        senderId: _myUid,
        senderName: _myProfile?.displayName || 'Siz',
        text, type: 'text',
        ts: new Date().toISOString()
    };

    try {
        const snap = await getDoc(dmRef);
        if(!snap.exists()) {
            await setDoc(dmRef, {
                users: [_myUid, _currentDmPartnerId],
                messages: [msgData],
                createdAt: serverTimestamp(),
                lastActivity: serverTimestamp()
            });
        } else {
            await updateDoc(dmRef, {
                messages: arrayUnion(msgData),
                lastActivity: serverTimestamp()
            });
        }
        // Increment message count
        await updateDoc(doc(db2, USERS_COL, _myUid), { msgCount: increment(1) }).catch(()=>{});
    } catch(e) { showToast('Mesaj göndərilə bilmədi', 'error'); }
};

window._sendDmImage = async function(base64) {
    if(!_myUid || !_currentDmPartnerId) return;
    const dmId = getDmId(_myUid, _currentDmPartnerId);
    const dmRef = doc(db2, DM_COL, dmId);
    showToast('Şəkil göndərilir...', 'info', 2000);
    addDmMessage({ id: `img-${Date.now()}`, isSelf: true, timestamp: new Date().toISOString(), type: 'image', imageData: base64 });
    const msgData = {
        senderId: _myUid, senderName: _myProfile?.displayName || 'Siz',
        type: 'image', imageData: base64, text: '', ts: new Date().toISOString()
    };
    try {
        const snap = await getDoc(dmRef);
        if(!snap.exists()) {
            await setDoc(dmRef, { users:[_myUid,_currentDmPartnerId], messages:[msgData], createdAt:serverTimestamp(), lastActivity:serverTimestamp() });
        } else {
            await updateDoc(dmRef, { messages: arrayUnion(msgData), lastActivity: serverTimestamp() });
        }
    } catch(e) { showToast('Şəkil göndərilə bilmədi', 'error'); }
};

window._loadDmConversationsFirebase = async function() {
    if(!_myUid) return;
    // Get all DMs where user is participant
    try {
        const snap = await getDoc(doc(db2, USERS_COL, _myUid));
        if(!snap.exists()) return;
        const friends = snap.data().friends || [];
        if(friends.length === 0) { renderDmConversationsList([]); return; }

        const conversations = [];
        for(const fid of friends.slice(0, 20)) {
            const dmId = getDmId(_myUid, fid);
            const dmSnap = await getDoc(doc(db2, DM_COL, dmId));
            const fSnap  = await getDoc(doc(db2, USERS_COL, fid));
            if(fSnap.exists()) {
                const fData = fSnap.data();
                const lastMsg = dmSnap.exists() ? (dmSnap.data().messages||[]).slice(-1)[0]?.text || '' : '';
                conversations.push({ uid: fid, name: fData.displayName, lastMsg, status: fData.status });
            }
        }
        renderDmConversationsList(conversations);
    } catch(e) {}
};

/* ==================================================
   AUTH STATE OBSERVER for Social Features
================================================== */
onAuthChanged(auth2, async (user) => {
    if(user && !user.isAnonymous) {
        _myUid = user.uid;
        try {
            const snap = await getDoc(doc(db2, USERS_COL, user.uid));
            if(snap.exists()) {
                _myProfile = snap.data();
                await updateDoc(doc(db2, USERS_COL, user.uid), { status: 'online', lastSeen: serverTimestamp() });
                onAuthSuccess(_myProfile);
                startFriendsListener();
            }
        } catch(e) {}
    }
});

/* ---- Set online on page visibility ---- */
document.addEventListener('visibilitychange', async () => {
    if(!_myUid) return;
    try {
        await updateDoc(doc(db2, USERS_COL, _myUid), {
            status: document.hidden ? 'away' : 'online',
            lastSeen: serverTimestamp()
        });
    } catch(e){}
});

/* ---- Set offline on unload ---- */
window.addEventListener('beforeunload', async () => {
    if(!_myUid) return;
    try { await updateDoc(doc(db2, USERS_COL, _myUid), { status: 'offline', lastSeen: serverTimestamp() }); } catch(e){}
    if(_unsubFriends) _unsubFriends();
    if(_unsubDm) _unsubDm();
});

</script>
</body>
</html>
