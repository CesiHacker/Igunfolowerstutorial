<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AxtarGet Chat ‚Äî Anonim Online Chat Platformasƒ±</title>
    <meta name="description" content="AxtarGet il…ô pulsuz online chat edin. Yeni insanlarla tanƒ±≈ü olun. He√ß bir qeydiyyat yoxdur.">
    <link rel="canonical" href="https://axtarget.com/">

    <!-- Google Fonts: Outfit + Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- =============================================
         GLOBAL STYLES ‚Äî Glassmorphism 2.0
    ============================================= -->
    <style>
        /* ---- CSS Reset & Variables ---- */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark:        #060a14;
            --glass-bg:       rgba(255,255,255,0.05);
            --glass-border:   rgba(255,255,255,0.12);
            --glass-blur:     blur(24px);
            --accent:         #38bdf8;
            --accent-glow:    rgba(56,189,248,0.25);
            --accent2:        #818cf8;
            --accent2-glow:   rgba(129,140,248,0.20);
            --success:        #34d399;
            --danger:         #f87171;
            --warning:        #fbbf24;
            --text-primary:   #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted:     #475569;
            --radius-lg:      20px;
            --radius-md:      14px;
            --radius-sm:      8px;
            --shadow-glow:    0 0 40px rgba(56,189,248,0.12);
            --transition:     all 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        html, body {
            height: 100%;
            width: 100%;
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Outfit', 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* ---- Animated Mesh Gradient Background ---- */
        /* Bu arxa fon ‚Äî h…ôr…ôk…ôt ed…ôn neon duman effektidir */
        #bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .mesh-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: orbFloat linear infinite;
        }

        .orb1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #0ea5e9 0%, transparent 70%);
            top: -20%;
            left: -10%;
            animation-duration: 18s;
            animation-delay: 0s;
        }

        .orb2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #818cf8 0%, transparent 70%);
            top: 30%;
            right: -10%;
            animation-duration: 22s;
            animation-delay: -5s;
        }

        .orb3 {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle, #06b6d4 0%, transparent 70%);
            bottom: -10%;
            left: 30%;
            animation-duration: 25s;
            animation-delay: -10s;
        }

        .orb4 {
            width: 280px;
            height: 280px;
            background: radial-gradient(circle, #a78bfa 0%, transparent 70%);
            top: 60%;
            left: -5%;
            animation-duration: 20s;
            animation-delay: -3s;
        }

        @keyframes orbFloat {
            0%   { transform: translate(0px, 0px) rotate(0deg) scale(1); }
            25%  { transform: translate(40px, -30px) rotate(90deg) scale(1.1); }
            50%  { transform: translate(-20px, 50px) rotate(180deg) scale(0.9); }
            75%  { transform: translate(-40px, -20px) rotate(270deg) scale(1.05); }
            100% { transform: translate(0px, 0px) rotate(360deg) scale(1); }
        }

        /* Noise texture overlay for depth */
        #bg-canvas::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            opacity: 0.4;
            pointer-events: none;
        }

        /* ---- App Shell ---- */
        #app {
            position: relative;
            z-index: 1;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        /* ---- Glassmorphism Card ---- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
        }

        .glass-strong {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3), var(--shadow-glow);
        }

        /* ---- Gradient Text ---- */
        .gradient-text {
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 50%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ---- Screens ---- */
        .screen {
            display: none;
            width: 100%;
            max-width: 520px;
            animation: screenFade 0.4s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes screenFade {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* ---- Buttons ---- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            border: none;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(14,165,233,0.30);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(14,165,233,0.45);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-ghost {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: rgba(255,255,255,0.10);
            color: var(--text-primary);
        }

        .btn-danger {
            background: rgba(248,113,113,0.15);
            border: 1px solid rgba(248,113,113,0.3);
            color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(248,113,113,0.25);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
        }

        /* ---- Input ---- */
        .input-field {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            outline: none;
            transition: var(--transition);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(56,189,248,0.15);
        }

        /* ---- START SCREEN ---- */
        #start-screen {
            text-align: center;
        }

        .logo-wrap {
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 72px;
            height: 72px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 8px 32px rgba(14,165,233,0.3);
            animation: logoPulse 3s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { box-shadow: 0 8px 32px rgba(14,165,233,0.3); }
            50%       { box-shadow: 0 8px 48px rgba(99,102,241,0.5); }
        }

        .logo-title {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .logo-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .start-card {
            padding: 28px;
            text-align: left;
        }

        .alert-box {
            padding: 14px;
            background: rgba(251,191,36,0.08);
            border: 1px solid rgba(251,191,36,0.25);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: #fcd34d;
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
        }

        .input-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .input-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .start-footer {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 16px;
            line-height: 1.6;
        }

        /* ---- LANGUAGE SELECTOR ---- */
        .lang-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .lang-btn-wrap {
            display: flex;
            gap: 6px;
        }

        .lang-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Outfit', sans-serif;
        }

        .lang-btn.active {
            background: rgba(56,189,248,0.15);
            border-color: rgba(56,189,248,0.4);
            color: var(--accent);
        }

        /* ---- MATCHING SCREEN ---- */
        .match-card {
            padding: 48px 32px;
            text-align: center;
        }

        .match-spinner {
            width: 80px;
            height: 80px;
            margin: 0 auto 28px;
            position: relative;
        }

        .match-spinner::before,
        .match-spinner::after {
            content: '';
            position: absolute;
            border-radius: 50%;
        }

        .match-spinner::before {
            inset: 0;
            border: 3px solid rgba(56,189,248,0.15);
        }

        .match-spinner::after {
            inset: 0;
            border: 3px solid transparent;
            border-top-color: var(--accent);
            border-right-color: var(--accent2);
            animation: spinRing 1s linear infinite;
        }

        @keyframes spinRing {
            to { transform: rotate(360deg); }
        }

        .match-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .match-countdown {
            font-size: 15px;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 28px;
        }

        /* ---- CHAT SCREEN ---- */
        #chat-screen {
            max-width: 640px;
            height: 100dvh;
            display: none;
            flex-direction: column;
        }

        #chat-screen.active {
            display: flex;
        }

        /* Chat Header */
        .chat-header {
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-shrink: 0;
            margin-bottom: 8px;
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        /* Generative Avatar */
        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: #fff;
            position: relative;
        }

        .avatar::after {
            content: '';
            position: absolute;
            bottom: 1px;
            right: 1px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            border: 2px solid var(--bg-dark);
            transition: var(--transition);
        }

        .avatar.offline::after {
            background: var(--text-muted);
        }

        .partner-name {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .partner-status {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
            min-height: 16px;
        }

        .typing-dots {
            display: inline-flex;
            gap: 3px;
            align-items: center;
        }

        .typing-dot {
            width: 5px;
            height: 5px;
            background: var(--warning);
            border-radius: 50%;
            animation: dotBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-5px); opacity: 1; }
        }

        .chat-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* Messages Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.1) transparent;
        }

        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* Message Bubbles */
        .msg-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 78%;
            position: relative;
            animation: msgSlide 0.25s ease;
        }

        @keyframes msgSlide {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .msg-wrapper.self {
            align-self: flex-end;
            align-items: flex-end;
        }

        .msg-wrapper.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .msg-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
            position: relative;
            cursor: default;
            transition: transform 0.1s;
        }

        .msg-bubble:active {
            transform: scale(0.98);
        }

        .msg-wrapper.self .msg-bubble {
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            color: #fff;
            border-bottom-right-radius: 5px;
        }

        .msg-wrapper.other .msg-bubble {
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            border-bottom-left-radius: 5px;
        }

        /* Emoji Reactions */
        .reaction-picker {
            position: absolute;
            bottom: calc(100% + 6px);
            background: rgba(20,20,40,0.95);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            padding: 6px 10px;
            display: none;
            gap: 6px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        .msg-wrapper.self .reaction-picker {
            right: 0;
        }

        .msg-wrapper.other .reaction-picker {
            left: 0;
        }

        .reaction-picker.visible {
            display: flex;
            animation: reactionPop 0.2s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes reactionPop {
            from { opacity: 0; transform: scale(0.7) translateY(4px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .reaction-emoji {
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.15s;
            line-height: 1;
        }

        .reaction-emoji:hover {
            transform: scale(1.4);
        }

        .msg-reaction-display {
            margin-top: 3px;
            font-size: 16px;
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .reaction-badge {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .reaction-badge:hover {
            background: rgba(255,255,255,0.18);
        }

        /* Message Meta (time + ticks) */
        .msg-meta {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 3px;
            padding: 0 4px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .msg-ticks {
            font-size: 11px;
            color: var(--text-muted);
        }

        .msg-ticks.read {
            color: var(--accent);
        }

        /* Image message */
        .msg-image {
            max-width: 240px;
            max-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            object-fit: cover;
            display: block;
            transition: transform 0.2s;
        }

        .msg-image:hover {
            transform: scale(1.02);
        }

        /* System message */
        .msg-system {
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
            padding: 6px 16px;
            background: rgba(255,255,255,0.04);
            border-radius: 20px;
            align-self: center;
            max-width: 80%;
        }

        /* Voice message UI */
        .voice-msg {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--transition);
            flex-shrink: 0;
            color: #fff;
        }

        .voice-play-btn:hover {
            background: rgba(255,255,255,0.35);
        }

        .voice-waveform {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 24px;
        }

        .voice-bar {
            width: 3px;
            background: rgba(255,255,255,0.5);
            border-radius: 2px;
            transition: height 0.1s;
        }

        .voice-duration {
            font-size: 12px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        /* ---- CHAT INPUT AREA ---- */
        .chat-input-area {
            padding: 10px 12px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
            margin-top: 8px;
        }

        .chat-input-wrap {
            flex: 1;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            display: flex;
            align-items: center;
            padding: 6px 8px 6px 16px;
            gap: 8px;
            transition: var(--transition);
        }

        .chat-input-wrap:focus-within {
            border-color: rgba(56,189,248,0.4);
            box-shadow: 0 0 0 3px rgba(56,189,248,0.08);
        }

        #message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 120px;
            padding: 6px 0;
            line-height: 1.4;
        }

        #message-input::placeholder {
            color: var(--text-muted);
        }

        .input-action-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
            flex-shrink: 0;
            background: transparent;
            color: var(--text-muted);
        }

        .input-action-btn:hover {
            background: rgba(255,255,255,0.08);
            color: var(--text-primary);
        }

        .send-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: var(--transition);
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(14,165,233,0.3);
        }

        .send-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px rgba(14,165,233,0.45);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* Voice recording UI */
        .voice-record-wrap {
            display: none;
            align-items: center;
            gap: 10px;
            flex: 1;
            padding: 0 8px;
        }

        .voice-record-wrap.active {
            display: flex;
        }

        .voice-record-indicator {
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            animation: recBlink 1s ease infinite;
            flex-shrink: 0;
        }

        @keyframes recBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        .voice-record-waves {
            display: flex;
            align-items: center;
            gap: 3px;
            flex: 1;
        }

        .voice-record-wave {
            width: 3px;
            background: var(--accent);
            border-radius: 2px;
            animation: waveAnim 0.5s ease infinite alternate;
        }

        @keyframes waveAnim {
            from { height: 4px; }
            to   { height: 20px; }
        }

        .voice-record-time {
            font-size: 13px;
            font-weight: 600;
            color: var(--danger);
            min-width: 40px;
        }

        /* ---- MODALS ---- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.25s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .modal-card {
            width: 100%;
            max-width: 420px;
            padding: 28px;
            background: rgba(10,15,30,0.95);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: 0 24px 64px rgba(0,0,0,0.5);
            animation: modalSlide 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to   { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.12);
            color: var(--text-primary);
        }

        /* ---- FEEDBACK SCREEN ---- */
        .feedback-stars {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .star-btn {
            font-size: 32px;
            cursor: pointer;
            transition: transform 0.2s;
            opacity: 0.4;
            line-height: 1;
            background: none;
            border: none;
        }

        .star-btn.active {
            opacity: 1;
        }

        .star-btn:hover {
            transform: scale(1.3);
        }

        .feedback-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
        }

        .feedback-tag {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .feedback-tag.selected {
            border-color: var(--accent);
            background: rgba(56,189,248,0.1);
            color: var(--accent);
        }

        /* ---- LIGHTBOX ---- */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 900;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .lightbox.open {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .lightbox img {
            max-width: 92vw;
            max-height: 88vh;
            border-radius: var(--radius-md);
            box-shadow: 0 24px 64px rgba(0,0,0,0.6);
            animation: imgZoom 0.25s ease;
        }

        @keyframes imgZoom {
            from { transform: scale(0.85); }
            to   { transform: scale(1); }
        }

        .lightbox-close {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.25);
        }

        /* ---- TOAST NOTIFICATIONS ---- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            background: rgba(10,15,30,0.95);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            animation: toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
            backdrop-filter: blur(16px);
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-16px) scale(0.9); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to   { opacity: 0; transform: translateY(-16px) scale(0.9); }
        }

        /* ---- CONFETTI ---- */
        .confetti-piece {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            z-index: 800;
            pointer-events: none;
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            0%   { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* ---- MATCH SHAKE ANIMATION ---- */
        @keyframes matchShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); }
            20%, 40%, 60%, 80%     { transform: translateX(6px); }
        }

        .shake {
            animation: matchShake 0.5s ease;
        }

        /* ---- TUTORIAL STEPS ---- */
        .tutorial-step {
            display: flex;
            gap: 14px;
            align-items: flex-start;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .tutorial-step:last-child {
            border-bottom: none;
        }

        .step-num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: #fff;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .step-text h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-text p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ---- MISC ---- */
        .divider {
            height: 1px;
            background: var(--glass-border);
            margin: 20px 0;
        }

        /* Responsive for chat screen */
        @media (max-width: 640px) {
            #chat-screen {
                max-width: 100%;
            }

            .msg-wrapper {
                max-width: 88%;
            }
        }

        /* Safe area for mobile */
        .chat-input-area {
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        /* Loading animation overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 999;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        #loading-overlay.hide {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

<!-- ===== ANIMATED BACKGROUND ===== -->
<div id="bg-canvas">
    <div class="mesh-orb orb1"></div>
    <div class="mesh-orb orb2"></div>
    <div class="mesh-orb orb3"></div>
    <div class="mesh-orb orb4"></div>
</div>

<!-- ===== LOADING OVERLAY ===== -->
<div id="loading-overlay">
    <div style="text-align:center">
        <div class="logo-icon" style="margin:0 auto 16px;">üí¨</div>
        <div class="gradient-text" style="font-size:28px;font-weight:800;">AxtarGet</div>
    </div>
</div>

<!-- ===== TOAST CONTAINER ===== -->
<div id="toast-container"></div>

<!-- ===== LANGUAGE SELECTOR ===== -->
<div class="lang-selector">
    <div class="lang-btn-wrap">
        <button class="lang-btn active" id="az-btn" onclick="setLang('az')">üá¶üáø AZ</button>
        <button class="lang-btn" id="tr-btn" onclick="setLang('tr')">üáπüá∑ TR</button>
    </div>
</div>

<!-- ===== APP SHELL ===== -->
<div id="app">

    <!-- ============================
         START SCREEN
    ============================ -->
    <div class="screen active" id="start-screen">
        <!-- Logo -->
        <div class="logo-wrap">
            <div class="logo-icon">üí¨</div>
            <h1 class="logo-title gradient-text">AxtarGet</h1>
            <p class="logo-subtitle" id="t-subtitle">Pulsuz Online Chat Platformasƒ±</p>
        </div>

        <!-- Card -->
        <div class="glass-strong start-card">
            <div class="alert-box">
                <span>‚ö†Ô∏è</span>
                <span><strong id="t-alertTitle">Diqq…ôt:</strong> <span id="t-alertText">Yazƒ±≈ümalarƒ±nƒ±z serverd…ô saxlanƒ±lmƒ±r. S√∂hb…ôt bitdikd…ô avtomatik silinir.</span></span>
            </div>

            <label class="input-label" id="t-nameLabel">ADINIIZ (ƒ∞ST∆èY∆è BAƒûLI)</label>
            <input class="input-field" type="text" id="user-name-input" maxlength="20" placeholder="Adƒ±nƒ±zƒ± yazƒ±n..." id="t-namePlaceholder">
            <p class="input-hint" id="t-nameHint">Bo≈ü buraxsanƒ±z t…ôsad√ºfi ad t…ôyin olunacaq</p>

            <div style="height:20px"></div>
            <button class="btn btn-primary" onclick="handleStart()" id="t-startBtn">
                <span>‚ö°</span> <span id="t-startBtnText">S√∂hb…ôt…ô Ba≈üla</span>
            </button>
            <div style="height:10px"></div>
            <button class="btn btn-ghost" onclick="openTutorial()" id="t-tutorialBtn">
                ‚ÑπÔ∏è <span id="t-tutorialBtnText">Nec…ô ƒ∞stifad…ô Olunur?</span>
            </button>
        </div>

        <p class="start-footer" id="t-footer">AxtarGet ‚Äî Az…ôrbaycanda …ôn yax≈üƒ± pulsuz chat platformasƒ±.</p>
    </div>

    <!-- ============================
         MATCHING SCREEN
    ============================ -->
    <div class="screen" id="matching-screen">
        <div class="glass-strong match-card">
            <div class="match-spinner"></div>
            <p class="match-title" id="t-matchingText">S√∂hb…ôt T…ôr…ôfda≈üƒ± Axtarƒ±lƒ±r...</p>
            <p class="match-countdown" id="countdown-display">‚è± Qalan vaxt: 20 saniy…ô</p>
            <button class="btn btn-danger" onclick="handleCancelMatching()">
                ‚úï <span id="t-cancelBtn">L…ôƒüv Et</span>
            </button>
            <div id="retry-wrap" style="display:none;margin-top:20px;border-top:1px solid var(--glass-border);padding-top:20px;">
                <p style="color:var(--warning);font-size:14px;margin-bottom:12px;" id="t-noUsers">He√ß bir aktiv istifad…ô√ßi tapƒ±lmadƒ±</p>
                <button class="btn btn-primary" onclick="handleStart()">
                    üîÑ <span id="t-retryBtn">Yenid…ôn C…ôhd Et</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ============================
         CHAT SCREEN
    ============================ -->
    <div class="screen" id="chat-screen">
        <!-- Header -->
        <div class="glass chat-header">
            <div class="chat-partner-info">
                <!-- Generative avatar ‚Äî JS t…ôr…ôfind…ôn doldurulur -->
                <div class="avatar" id="partner-avatar">?</div>
                <div>
                    <div class="partner-name" id="partner-name">...</div>
                    <div class="partner-status" id="partner-status">
                        <span style="color:var(--success)">‚óè</span>
                        <span id="t-activeText">Aktiv</span>
                    </div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="btn btn-ghost btn-sm" onclick="handleChangeChat()">
                    üîÑ <span id="t-changeBtn">D…ôyi≈ü</span>
                </button>
                <button class="btn btn-danger btn-sm" onclick="handleCloseChat()">
                    ‚úï <span id="t-closeBtn">Baƒüla</span>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chat-messages"></div>

        <!-- Input Area -->
        <div class="glass chat-input-area">
            <div class="chat-input-wrap" id="input-wrap">
                <!-- Voice record mode (hidden default) -->
                <div class="voice-record-wrap" id="voice-record-wrap">
                    <div class="voice-record-indicator"></div>
                    <div class="voice-record-waves" id="record-waves"></div>
                    <div class="voice-record-time" id="record-time">0:00</div>
                </div>
                <!-- Normal input -->
                <textarea
                    id="message-input"
                    rows="1"
                    placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                    oninput="autoResizeTextarea(this); handleTyping();"
                    onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendMessage();}"
                ></textarea>
                <!-- Image button -->
                <button class="input-action-btn" onclick="triggerImagePicker()" title="≈û…ôkil g√∂nd…ôr">üì∑</button>
                <!-- Voice button -->
                <button class="input-action-btn" id="voice-btn" onmousedown="startVoiceRecord()" onmouseup="stopVoiceRecord()" ontouchstart="startVoiceRecord()" ontouchend="stopVoiceRecord()" title="S…ôsli mesaj">üé§</button>
            </div>
            <!-- Hidden file input -->
            <input type="file" id="image-picker" accept="image/*" style="display:none" onchange="handleImageSelected(event)">
            <!-- Send button -->
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

</div><!-- #app -->

<!-- ===== TUTORIAL MODAL ===== -->
<div class="modal-overlay" id="tutorial-modal">
    <div class="modal-card">
        <div class="modal-title">
            <span id="t-tutorialTitle">AxtarGet Nec…ô ƒ∞stifad…ô Olunur?</span>
            <button class="modal-close" onclick="closeTutorial()">‚úï</button>
        </div>
        <div class="tutorial-step">
            <div class="step-num">1</div>
            <div class="step-text">
                <h4 id="t-step1Title">Adƒ±nƒ±zƒ± Yazƒ±n (ƒ∞st…ôy…ô Baƒülƒ±)</h4>
                <p id="t-step1Text">Adƒ±nƒ±zƒ± yazƒ±n v…ô ya bo≈ü buraxƒ±n. Bo≈ü buraxsanƒ±z, sistem t…ôsad√ºfi ad ver…ôc…ôk.</p>
            </div>
        </div>
        <div class="tutorial-step">
            <div class="step-num">2</div>
            <div class="step-text">
                <h4 id="t-step2Title">S√∂hb…ôt…ô Ba≈ülayƒ±n</h4>
                <p id="t-step2Text">"S√∂hb…ôt…ô Ba≈üla" d√ºym…ôsin…ô basƒ±n. Sistem sizi dig…ôr istifad…ô√ßil…ôrl…ô qo≈üacaq.</p>
            </div>
        </div>
        <div class="tutorial-step">
            <div class="step-num">3</div>
            <div class="step-text">
                <h4 id="t-step3Title">S√∂hb…ôt Edin</h4>
                <p id="t-step3Text">≈û…ôkil g√∂nd…ôrin, s…ôsli mesaj bƒ±raxƒ±n, reaksiyalar …ôlav…ô edin. Mesajlara uzun basan zaman emoji se√ßimi √ßƒ±xacaq.</p>
            </div>
        </div>
        <div class="tutorial-step">
            <div class="step-num">4</div>
            <div class="step-text">
                <h4 id="t-step4Title">Dil Se√ßin</h4>
                <p id="t-step4Text">Yuxarƒ± saƒü k√ºnc√ºnd…ôn dil se√ßin. Se√ßil…ôn dil qar≈üƒ± t…ôr…ôfd…ô g√∂r√ºn√ºr.</p>
            </div>
        </div>
        <div style="margin-top:20px;">
            <button class="btn btn-primary" onclick="closeTutorial()">
                ‚úÖ <span id="t-understandBtn">Ba≈üa d√º≈üd√ºm, Ba≈ülayaq!</span>
            </button>
        </div>
    </div>
</div>

<!-- ===== FEEDBACK MODAL ===== -->
<div class="modal-overlay" id="feedback-modal">
    <div class="modal-card" style="text-align:center;">
        <div class="modal-title" style="justify-content:center;flex-direction:column;gap:6px;">
            <span style="font-size:40px;">üëã</span>
            <span id="t-feedbackTitle">S√∂hb…ôt nec…ô ke√ßdi?</span>
        </div>
        <p style="font-size:14px;color:var(--text-secondary);margin-bottom:8px;" id="t-feedbackSubtitle">R…ôyiniz bizim √º√ß√ºn vacibdir</p>
        <div class="feedback-stars" id="feedback-stars">
            <button class="star-btn" data-val="1" onclick="setStarRating(1)">‚≠ê</button>
            <button class="star-btn" data-val="2" onclick="setStarRating(2)">‚≠ê</button>
            <button class="star-btn" data-val="3" onclick="setStarRating(3)">‚≠ê</button>
            <button class="star-btn" data-val="4" onclick="setStarRating(4)">‚≠ê</button>
            <button class="star-btn" data-val="5" onclick="setStarRating(5)">‚≠ê</button>
        </div>
        <div class="feedback-tags" id="feedback-tags">
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag1">Mehriban idi</button>
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag2">Maraqlƒ± s√∂hb…ôt</button>
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag3">Tez bitdi</button>
            <button class="feedback-tag" onclick="toggleFeedbackTag(this)" id="t-tag4">M√ºnasib deyildi</button>
        </div>
        <button class="btn btn-primary" onclick="submitFeedback()" id="t-feedbackSubmit">G√∂nd…ôr</button>
        <button class="btn btn-ghost" style="margin-top:10px;" onclick="skipFeedback()" id="t-feedbackSkip">Ke√ß</button>
    </div>
</div>

<!-- ===== LIGHTBOX ===== -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
    <img id="lightbox-img" src="" alt="Full view">
</div>

<!-- =============================================
     JAVASCRIPT ‚Äî Full Logic
============================================= -->
<script>
/* ================================================
   TRANSLATIONS ‚Äî AZ / TR
================================================ */
const T = {
    az: {
        subtitle: 'Pulsuz Online Chat Platformasƒ±',
        alertTitle: 'Diqq…ôt:',
        alertText: 'Yazƒ±≈ümalarƒ±nƒ±z serverd…ô saxlanƒ±lmƒ±r. S√∂hb…ôt bitdikd…ô avtomatik silinir.',
        nameLabel: 'ADINIZ (ƒ∞ST∆èY∆è BAƒûLI)',
        namePlaceholder: 'Adƒ±nƒ±zƒ± yazƒ±n...',
        nameHint: 'Bo≈ü buraxsanƒ±z t…ôsad√ºfi ad t…ôyin olunacaq',
        startBtnText: 'S√∂hb…ôt…ô Ba≈üla',
        tutorialBtnText: 'Nec…ô ƒ∞stifad…ô Olunur?',
        footer: 'AxtarGet ‚Äî Az…ôrbaycanda …ôn yax≈üƒ± pulsuz chat platformasƒ±.',
        matchingText: 'S√∂hb…ôt T…ôr…ôfda≈üƒ± Axtarƒ±lƒ±r...',
        cancelBtn: 'L…ôƒüv Et',
        noUsers: 'He√ß bir aktiv istifad…ô√ßi tapƒ±lmadƒ±',
        retryBtn: 'Yenid…ôn C…ôhd Et',
        activeText: 'Aktiv',
        typingText: 'yazƒ±r...',
        changeBtn: 'D…ôyi≈ü',
        closeBtn: 'Baƒüla',
        msgPlaceholder: 'Mesajƒ±nƒ±zƒ± yazƒ±n...',
        tutorialTitle: 'AxtarGet Nec…ô ƒ∞stifad…ô Olunur?',
        step1Title: 'Adƒ±nƒ±zƒ± Yazƒ±n (ƒ∞st…ôy…ô Baƒülƒ±)',
        step1Text: 'Adƒ±nƒ±zƒ± yazƒ±n v…ô ya bo≈ü buraxƒ±n. Bo≈ü buraxsanƒ±z, sistem t…ôsad√ºfi ad ver…ôc…ôk.',
        step2Title: 'S√∂hb…ôt…ô Ba≈ülayƒ±n',
        step2Text: '"S√∂hb…ôt…ô Ba≈üla" d√ºym…ôsin…ô basƒ±n. Sistem sizi dig…ôr istifad…ô√ßil…ôrl…ô qo≈üacaq.',
        step3Title: 'S√∂hb…ôt Edin',
        step3Text: '≈û…ôkil g√∂nd…ôrin, s…ôsli mesaj bƒ±raxƒ±n, reaksiyalar …ôlav…ô edin.',
        step4Title: 'Dil Se√ßin',
        step4Text: 'Yuxarƒ± saƒü k√ºnc√ºnd…ôn dil se√ßin. Se√ßil…ôn dil qar≈üƒ± t…ôr…ôfd…ô g√∂r√ºn√ºr.',
        understandBtn: 'Ba≈üa d√º≈üd√ºm, Ba≈ülayaq!',
        feedbackTitle: 'S√∂hb…ôt nec…ô ke√ßdi?',
        feedbackSubtitle: 'R…ôyiniz bizim √º√ß√ºn vacibdir',
        tag1: 'Mehriban idi',
        tag2: 'Maraqlƒ± s√∂hb…ôt',
        tag3: 'Tez bitdi',
        tag4: 'M√ºnasib deyildi',
        feedbackSubmit: 'G√∂nd…ôr',
        feedbackSkip: 'Ke√ß',
        partnerLeft: '‚ùå T…ôr…ôfda≈ü s√∂hb…ôti baƒüladƒ±',
        msgError: '‚ö†Ô∏è Mesaj g√∂nd…ôril…ô bilm…ôdi',
        matchFound: 'üéâ T…ôr…ôfda≈ü tapƒ±ldƒ±!',
        connecting: 'Qo≈üulur...',
        you: 'Siz',
    },
    tr: {
        subtitle: '√úcretsiz Online Chat Platformu',
        alertTitle: 'Dikkat:',
        alertText: 'Yazƒ±≈ümalarƒ±nƒ±z sunucuda saklanmaz. Sohbet bittiƒüinde otomatik silinir.',
        nameLabel: 'ADINIZ (ƒ∞STEƒûE BAƒûLI)',
        namePlaceholder: 'Adƒ±nƒ±zƒ± yazƒ±n...',
        nameHint: 'Bo≈ü bƒ±rakƒ±rsanƒ±z rastgele ad atanacak',
        startBtnText: 'Sohbete Ba≈üla',
        tutorialBtnText: 'Nasƒ±l Kullanƒ±lƒ±r?',
        footer: 'AxtarGet ‚Äî Azerbaycandaki en iyi √ºcretsiz chat platformu.',
        matchingText: 'Sohbet Partneri Aranƒ±yor...',
        cancelBtn: 'ƒ∞ptal Et',
        noUsers: 'Hi√ßbir aktif kullanƒ±cƒ± bulunamadƒ±',
        retryBtn: 'Yeniden Dene',
        activeText: 'Aktif',
        typingText: 'yazƒ±yor...',
        changeBtn: 'Deƒüi≈ütir',
        closeBtn: 'Kapat',
        msgPlaceholder: 'Mesajƒ±nƒ±zƒ± yazƒ±n...',
        tutorialTitle: 'AxtarGet Nasƒ±l Kullanƒ±lƒ±r?',
        step1Title: 'Adƒ±nƒ±zƒ± Yazƒ±n (ƒ∞steƒüe Baƒülƒ±)',
        step1Text: 'Adƒ±nƒ±zƒ± yazƒ±n veya bo≈ü bƒ±rakƒ±n. Bo≈ü bƒ±rakƒ±rsanƒ±z, sistem rastgele ad verecek.',
        step2Title: 'Sohbete Ba≈ülayƒ±n',
        step2Text: '"Sohbete Ba≈üla" butonuna tƒ±klayƒ±n.',
        step3Title: 'Sohbet Edin',
        step3Text: 'Fotoƒüraf g√∂nderin, sesli mesaj bƒ±rakƒ±n, reaksiyonlar ekleyin.',
        step4Title: 'Dil Se√ßin',
        step4Text: 'Saƒü √ºst k√∂≈üeden dil se√ßin.',
        understandBtn: 'Anladƒ±m, Ba≈ülayalƒ±m!',
        feedbackTitle: 'Sohbet nasƒ±ldƒ±?',
        feedbackSubtitle: 'G√∂r√º≈ü√ºn√ºz bizim i√ßin √∂nemli',
        tag1: 'Nazikti',
        tag2: 'ƒ∞lgin√ß sohbet',
        tag3: 'Erken bitti',
        tag4: 'Uygun deƒüildi',
        feedbackSubmit: 'G√∂nder',
        feedbackSkip: 'Ge√ß',
        partnerLeft: '‚ùå Partner sohbeti kapattƒ±',
        msgError: '‚ö†Ô∏è Mesaj g√∂nderilemedi',
        matchFound: 'üéâ Partner bulundu!',
        connecting: 'Baƒülanƒ±yor...',
        you: 'Siz',
    }
};

/* ================================================
   APP STATE
================================================ */
let lang = 'az'; // current language

/* setLang ‚Äî dili d…ôyi≈ü */
function setLang(l) {
    lang = l;
    document.getElementById('az-btn').classList.toggle('active', l === 'az');
    document.getElementById('tr-btn').classList.toggle('active', l === 'tr');
    applyTranslations();
}

/* B√ºt√ºn UI m…ôtnl…ôrini t…ôtbiq et */
function applyTranslations() {
    const t = T[lang];
    const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
    const setPlaceholder = (id, val) => { const el = document.getElementById(id); if(el) el.placeholder = val; };

    set('t-subtitle', t.subtitle);
    set('t-alertTitle', t.alertTitle);
    set('t-alertText', t.alertText);
    set('t-nameLabel', t.nameLabel);
    setPlaceholder('user-name-input', t.namePlaceholder);
    document.querySelector('.input-hint') && (document.querySelector('.input-hint').textContent = t.nameHint);
    set('t-startBtnText', t.startBtnText);
    set('t-tutorialBtnText', t.tutorialBtnText);
    set('t-footer', t.footer);
    set('t-matchingText', t.matchingText);
    set('t-cancelBtn', t.cancelBtn);
    set('t-noUsers', t.noUsers);
    set('t-retryBtn', t.retryBtn);
    set('t-activeText', t.activeText);
    set('t-changeBtn', t.changeBtn);
    set('t-closeBtn', t.closeBtn);
    setPlaceholder('message-input', t.msgPlaceholder);
    set('t-tutorialTitle', t.tutorialTitle);
    set('t-step1Title', t.step1Title);
    set('t-step1Text', t.step1Text);
    set('t-step2Title', t.step2Title);
    set('t-step2Text', t.step2Text);
    set('t-step3Title', t.step3Title);
    set('t-step3Text', t.step3Text);
    set('t-step4Title', t.step4Title);
    set('t-step4Text', t.step4Text);
    set('t-understandBtn', t.understandBtn);
    set('t-feedbackTitle', t.feedbackTitle);
    set('t-feedbackSubtitle', t.feedbackSubtitle);
    set('t-tag1', t.tag1);
    set('t-tag2', t.tag2);
    set('t-tag3', t.tag3);
    set('t-tag4', t.tag4);
    set('t-feedbackSubmit', t.feedbackSubmit);
    set('t-feedbackSkip', t.feedbackSkip);
}

/* ================================================
   SCREEN MANAGER
================================================ */
function showScreen(id) {
    ['start-screen','matching-screen','chat-screen'].forEach(s => {
        const el = document.getElementById(s);
        el.classList.remove('active');
    });
    const target = document.getElementById(id);
    target.classList.add('active');
}

/* ================================================
   TUTORIAL
================================================ */
function openTutorial() {
    document.getElementById('tutorial-modal').classList.add('open');
}
function closeTutorial() {
    document.getElementById('tutorial-modal').classList.remove('open');
}

/* ================================================
   TOAST NOTIFICATIONS
================================================ */
function showToast(msg, type = 'info', duration = 3000) {
    const icons = { info: '‚ÑπÔ∏è', success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'toastOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

/* ================================================
   LIGHTBOX
================================================ */
function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('open');
}

/* ================================================
   CONFETTI ANIMATION (Match Found!)
================================================ */
function launchConfetti() {
    const colors = ['#38bdf8','#818cf8','#34d399','#fbbf24','#f87171','#a78bfa','#fb923c'];
    for (let i = 0; i < 80; i++) {
        setTimeout(() => {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.top = '-10px';
            piece.style.background = colors[Math.floor(Math.random() * colors.length)];
            piece.style.width = (6 + Math.random() * 8) + 'px';
            piece.style.height = (6 + Math.random() * 8) + 'px';
            piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
            piece.style.animationDuration = (1.5 + Math.random() * 2) + 's';
            piece.style.animationDelay = Math.random() * 0.5 + 's';
            document.body.appendChild(piece);
            setTimeout(() => piece.remove(), 4000);
        }, i * 20);
    }
}

/* Screen shake */
function shakeScreen() {
    document.getElementById('app').classList.add('shake');
    setTimeout(() => document.getElementById('app').classList.remove('shake'), 600);
}

/* ================================================
   GENERATIVE AVATAR ‚Äî ID-based gradient
================================================ */
function generateAvatar(name, id = '') {
    const colors = [
        ['#0ea5e9','#6366f1'],
        ['#10b981','#06b6d4'],
        ['#f59e0b','#ef4444'],
        ['#8b5cf6','#ec4899'],
        ['#14b8a6','#3b82f6'],
        ['#f97316','#a855f7'],
    ];
    // Se√ßim ID-…ô g√∂r…ô deterministik olsun
    const seed = (id + name).split('').reduce((a,c) => a + c.charCodeAt(0), 0);
    const pair = colors[seed % colors.length];
    const initials = (name || '?').trim()[0].toUpperCase();

    const avatar = document.getElementById('partner-avatar');
    avatar.style.background = `linear-gradient(135deg, ${pair[0]}, ${pair[1]})`;
    avatar.textContent = initials;
}

/* ================================================
   TIMESTAMP FORMATTER
================================================ */
function formatTime(ts) {
    const d = ts ? new Date(ts) : new Date();
    return d.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' });
}

function formatDate(ts) {
    const d = ts ? new Date(ts) : new Date();
    const now = new Date();
    const diff = Math.floor((now - d) / 86400000);
    if (diff === 0) return formatTime(ts);
    if (diff === 1) return lang === 'az' ? 'D√ºn…ôn' : 'D√ºn';
    if (diff < 7) return `${diff} ${lang === 'az' ? 'g√ºn …ôvv…ôl' : 'g√ºn √∂nce'}`;
    return d.toLocaleDateString('az-AZ');
}

/* ================================================
   ESCAPE HTML
================================================ */
function esc(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
}

/* ================================================
   TEXTAREA AUTO-RESIZE
================================================ */
function autoResizeTextarea(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

/* ================================================
   VOICE MESSAGE UI
================================================ */
let isRecording = false;
let recordTimer = null;
let recordSeconds = 0;

function startVoiceRecord() {
    if (isRecording) return;
    isRecording = true;
    recordSeconds = 0;
    document.getElementById('voice-record-wrap').classList.add('active');
    document.getElementById('message-input').style.display = 'none';
    // Build wave bars
    const waves = document.getElementById('record-waves');
    waves.innerHTML = '';
    for (let i = 0; i < 24; i++) {
        const bar = document.createElement('div');
        bar.className = 'voice-record-wave';
        bar.style.height = (4 + Math.random() * 18) + 'px';
        bar.style.animationDuration = (0.3 + Math.random() * 0.4) + 's';
        bar.style.animationDelay = (Math.random() * 0.3) + 's';
        waves.appendChild(bar);
    }
    recordTimer = setInterval(() => {
        recordSeconds++;
        const m = Math.floor(recordSeconds / 60);
        const s = recordSeconds % 60;
        document.getElementById('record-time').textContent = `${m}:${s.toString().padStart(2,'0')}`;
    }, 1000);
}

function stopVoiceRecord() {
    if (!isRecording) return;
    isRecording = false;
    clearInterval(recordTimer);
    document.getElementById('voice-record-wrap').classList.remove('active');
    document.getElementById('message-input').style.display = '';
    if (recordSeconds >= 1) {
        // Simulate sending a voice message
        sendVoiceMessage(recordSeconds);
    }
    recordSeconds = 0;
}

/* ================================================
   IMAGE PICKER
================================================ */
function triggerImagePicker() {
    document.getElementById('image-picker').click();
}

function handleImageSelected(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 3 * 1024 * 1024) {
        showToast('≈û…ôkil 3MB-dan ki√ßik olmalƒ±dƒ±r', 'error');
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        const base64 = e.target.result;
        sendImageMessage(base64);
    };
    reader.readAsDataURL(file);
    event.target.value = '';
}

/* ================================================
   FEEDBACK
================================================ */
let feedbackRating = 0;

function setStarRating(val) {
    feedbackRating = val;
    document.querySelectorAll('.star-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i < val);
    });
}

function toggleFeedbackTag(el) {
    el.classList.toggle('selected');
}

function submitFeedback() {
    document.getElementById('feedback-modal').classList.remove('open');
    showToast(lang === 'az' ? 'R…ôyiniz √º√ß√ºn t…ô≈ü…ôkk√ºr!' : 'Geri bildiriminiz i√ßin te≈üekk√ºr!', 'success');
    showScreen('start-screen');
    document.getElementById('user-name-input').value = '';
    feedbackRating = 0;
}

function skipFeedback() {
    document.getElementById('feedback-modal').classList.remove('open');
    showScreen('start-screen');
    document.getElementById('user-name-input').value = '';
}

/* ================================================
   REACTION SYSTEM
================================================ */
const REACTIONS = ['‚ù§Ô∏è', 'üòÇ', 'üî•', 'üëç', 'üò¢'];
let reactionTimers = {};
let currentReactionMsg = null;

function attachReactionListeners(wrapper, msgId) {
    let pressTimer;

    const showPicker = () => {
        // Close any open pickers
        document.querySelectorAll('.reaction-picker.visible').forEach(p => {
            if (p !== wrapper.querySelector('.reaction-picker'))
                p.classList.remove('visible');
        });
        wrapper.querySelector('.reaction-picker').classList.add('visible');
        currentReactionMsg = msgId;
    };

    // Long press (touch)
    wrapper.addEventListener('touchstart', () => {
        pressTimer = setTimeout(showPicker, 450);
    }, { passive: true });
    wrapper.addEventListener('touchend', () => clearTimeout(pressTimer), { passive: true });
    wrapper.addEventListener('touchmove', () => clearTimeout(pressTimer), { passive: true });

    // Hover (desktop) ‚Äî show after brief delay
    wrapper.addEventListener('mouseenter', () => {
        pressTimer = setTimeout(showPicker, 700);
    });
    wrapper.addEventListener('mouseleave', () => {
        clearTimeout(pressTimer);
        setTimeout(() => {
            const picker = wrapper.querySelector('.reaction-picker');
            if (picker && !picker.matches(':hover')) {
                picker.classList.remove('visible');
            }
        }, 300);
    });
}

function addReactionToMsg(msgId, emoji, isSelf) {
    const wrapper = document.querySelector(`[data-msg-id="${msgId}"]`);
    if (!wrapper) return;
    let display = wrapper.querySelector('.msg-reaction-display');
    if (!display) {
        display = document.createElement('div');
        display.className = 'msg-reaction-display';
        wrapper.appendChild(display);
    }
    // Check if same emoji already exists
    const existing = Array.from(display.querySelectorAll('.reaction-badge')).find(b => b.dataset.emoji === emoji);
    if (existing) {
        const count = parseInt(existing.dataset.count || '1') + 1;
        existing.dataset.count = count;
        existing.querySelector('.r-count').textContent = count > 1 ? count : '';
    } else {
        const badge = document.createElement('span');
        badge.className = 'reaction-badge';
        badge.dataset.emoji = emoji;
        badge.dataset.count = '1';
        badge.innerHTML = `${emoji}<span class="r-count"></span>`;
        display.appendChild(badge);
    }
    wrapper.querySelector('.reaction-picker').classList.remove('visible');
}

/* ================================================
   MESSAGE RENDERING
================================================ */
let renderedMessageIds = new Set();
let shouldAutoScroll = true;

const msgsContainer = () => document.getElementById('chat-messages');

function addMessage({ id, senderName, text, isSelf, timestamp, type = 'text', imageData, voiceDuration }) {
    if (id && renderedMessageIds.has(id)) return;
    if (id) renderedMessageIds.add(id);

    const container = msgsContainer();
    const wrapper = document.createElement('div');
    wrapper.className = `msg-wrapper ${isSelf ? 'self' : 'other'}`;
    wrapper.dataset.msgId = id || Date.now();

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';

    if (type === 'image' && imageData) {
        const img = document.createElement('img');
        img.className = 'msg-image';
        img.src = imageData;
        img.alt = 'Image';
        img.onclick = () => openLightbox(imageData);
        bubble.appendChild(img);
    } else if (type === 'voice') {
        bubble.innerHTML = `
            <div class="voice-msg">
                <button class="voice-play-btn" onclick="simulateVoicePlay(this)">‚ñ∂</button>
                <div class="voice-waveform">${generateWaveBars()}</div>
                <span class="voice-duration">${formatVoiceDuration(voiceDuration || 0)}</span>
            </div>`;
    } else {
        bubble.innerHTML = `<span>${esc(text)}</span>`;
    }

    // Reaction picker
    const picker = document.createElement('div');
    picker.className = 'reaction-picker';
    REACTIONS.forEach(emoji => {
        const btn = document.createElement('span');
        btn.className = 'reaction-emoji';
        btn.textContent = emoji;
        btn.onclick = (e) => {
            e.stopPropagation();
            addReactionToMsg(wrapper.dataset.msgId, emoji, isSelf);
            // Send reaction to Firebase if needed
            if (chatId && userId) {
                sendReactionToFirebase(wrapper.dataset.msgId, emoji).catch(()=>{});
            }
        };
        picker.appendChild(btn);
    });
    bubble.appendChild(picker);

    // Meta (time + ticks)
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    if (isSelf) {
        meta.innerHTML = `
            <span class="msg-time">${formatDate(timestamp)}</span>
            <span class="msg-ticks" id="ticks-${id||''}">‚úì‚úì</span>`;
    } else {
        meta.innerHTML = `<span class="msg-time">${formatDate(timestamp)}</span>`;
    }

    wrapper.appendChild(bubble);
    wrapper.appendChild(meta);

    // Attach reaction listeners
    attachReactionListeners(wrapper, wrapper.dataset.msgId);

    container.appendChild(wrapper);

    // Smart auto-scroll
    smartScroll();
}

function smartScroll() {
    const c = msgsContainer();
    const isNearBottom = c.scrollHeight - c.scrollTop - c.clientHeight < 120;
    if (isNearBottom || shouldAutoScroll) {
        c.scrollTop = c.scrollHeight;
    }
}

function addSystemMessage(text) {
    const container = msgsContainer();
    const el = document.createElement('div');
    el.className = 'msg-system';
    el.textContent = text;
    container.appendChild(el);
    container.scrollTop = container.scrollHeight;
}

function generateWaveBars() {
    let html = '';
    const heights = [4,8,14,10,18,12,6,16,10,8,14,6,18,10,12];
    heights.forEach(h => {
        html += `<div class="voice-bar" style="height:${h}px"></div>`;
    });
    return html;
}

function formatVoiceDuration(secs) {
    const m = Math.floor(secs / 60);
    const s = secs % 60;
    return `${m}:${s.toString().padStart(2,'0')}`;
}

function simulateVoicePlay(btn) {
    btn.textContent = '‚è∏';
    const waveform = btn.parentElement.querySelector('.voice-waveform');
    // Animate bars
    const bars = waveform.querySelectorAll('.voice-bar');
    let frame = 0;
    const anim = setInterval(() => {
        bars.forEach(b => {
            b.style.height = (4 + Math.random() * 18) + 'px';
            b.style.background = '#38bdf8';
        });
        frame++;
        if (frame > 30) {
            clearInterval(anim);
            bars.forEach(b => { b.style.height = '4px'; b.style.background = 'rgba(255,255,255,0.5)'; });
            btn.textContent = '‚ñ∂';
        }
    }, 100);
}

/* ================================================
   FIREBASE ‚Äî Real-time Chat
================================================ */
</script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
    getFirestore, doc, updateDoc, onSnapshot, runTransaction,
    deleteDoc, serverTimestamp, arrayUnion, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ---- Firebase Config ---- */
const firebaseConfig = {
    apiKey: "AIzaSyAAbLWwzSE9WgqFKK_n9hqsl5mokZlNacM",
    authDomain: "axtargetbot.firebaseapp.com",
    projectId: "axtargetbot",
    storageBucket: "axtargetbot.firebasestorage.app",
    messagingSenderId: "509543495829",
    appId: "1:509543495829:web:833feb9c271328f8e4039c"
};

const CHAT_COLLECTION = `artifacts/axtarget-anonimchat/public/data/chats`;
const MATCH_QUEUE_DOC = 'match_queue_doc';
const MATCHING_SECONDS = 20;
const HEARTBEAT_TIMEOUT = 10000;

/* ---- State ---- */
let app, db, auth;
let userId = null, userName = null;
let chatId = null, partnerId = null, partnerLanguage = null;
let isAuthReady = false;
let unsubscribeChat = null;
let matchingTimeout = null;
let typingTimeout = null;
let heartbeatInterval = null, partnerHeartbeatInterval = null;
let isFirstSnapshot = true;

/* ---- Initialize ---- */
async function initFirebase() {
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                // Hide loading overlay
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.add('hide');
                setTimeout(() => overlay.remove(), 600);
            } else {
                await signInAnonymously(auth);
            }
        });
    } catch (e) {
        console.error('Firebase init error:', e);
        showToast('Baƒülantƒ± x…ôtasƒ±', 'error');
    }
}

/* ---- Heartbeat ---- */
function startHeartbeat() {
    if (heartbeatInterval) clearInterval(heartbeatInterval);
    heartbeatInterval = setInterval(async () => {
        if (!userId || !chatId) return;
        try {
            await updateDoc(doc(db, CHAT_COLLECTION, userId), {
                lastSeen: serverTimestamp(),
                isOnline: true,
                heartbeat: serverTimestamp(),
                language: lang
            });
        } catch(e) {}
    }, 3000);
}

function startPartnerCheck() {
    if (partnerHeartbeatInterval) clearInterval(partnerHeartbeatInterval);
    partnerHeartbeatInterval = setInterval(async () => {
        if (!partnerId || !chatId) return;
        try {
            const snap = await getDoc(doc(db, CHAT_COLLECTION, partnerId));
            if (snap.exists()) {
                const data = snap.data();
                const last = data.heartbeat?.toDate?.() || data.lastSeen?.toDate?.();
                if (last) {
                    const diff = Date.now() - last.getTime();
                    const avatar = document.getElementById('partner-avatar');
                    const statusEl = document.getElementById('partner-status');
                    if (diff < HEARTBEAT_TIMEOUT) {
                        avatar.classList.remove('offline');
                        statusEl.innerHTML = `<span style="color:var(--success)">‚óè</span><span>${T[lang].activeText}</span>`;
                    } else {
                        avatar.classList.add('offline');
                        statusEl.innerHTML = `<span style="color:var(--text-muted)">‚óè</span><span>Offline</span>`;
                    }
                }
            }
        } catch(e) {}
    }, 5000);
}

function stopHeartbeat() {
    if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval = null; }
    if (partnerHeartbeatInterval) { clearInterval(partnerHeartbeatInterval); partnerHeartbeatInterval = null; }
}

/* ---- handleStart ---- */
window.handleStart = async function() {
    if (!isAuthReady || !userId) {
        showToast(T[lang].connecting, 'info');
        await new Promise(r => setTimeout(r, 1500));
        if (!isAuthReady) return;
    }

    const nameInput = document.getElementById('user-name-input').value.trim();
    const randomNames = ['Anonim','Qaranlƒ±q','Gizli','Nam…ôlum','Sirl…ôr'];
    userName = nameInput || randomNames[Math.floor(Math.random() * randomNames.length)] + '_' + Math.floor(Math.random() * 999);

    showScreen('matching-screen');

    // Countdown
    let remaining = MATCHING_SECONDS;
    document.getElementById('countdown-display').textContent = `‚è± ${T[lang].activeText !== 'Aktiv' ? 'Kalan s√ºre:' : 'Qalan vaxt:'} ${remaining} ${lang === 'az' ? 'saniy…ô' : 'saniye'}`;
    document.getElementById('retry-wrap').style.display = 'none';

    matchingTimeout = setInterval(() => {
        remaining--;
        document.getElementById('countdown-display').textContent = `‚è± ${lang === 'az' ? 'Qalan vaxt' : 'Kalan s√ºre'}: ${remaining} ${lang === 'az' ? 'saniy…ô' : 'saniye'}`;
        if (remaining <= 0) {
            clearInterval(matchingTimeout);
            document.getElementById('retry-wrap').style.display = 'block';
        }
    }, 1000);

    await startMatching();
};

async function startMatching() {
    try {
        const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC);

        await runTransaction(db, async (transaction) => {
            const queueDoc = await transaction.get(queueRef);
            const qData = queueDoc.data() || {};

            if (queueDoc.exists() && qData.waitingUserId && qData.waitingUserId !== userId) {
                // MATCH FOUND
                const waitingId = qData.waitingUserId;
                const waitingName = qData.waitingUserName || 'Anonim';
                const waitingLang = qData.waitingUserLanguage || 'az';
                const newChatId = [userId, waitingId].sort().join('_');

                // Clear queue
                transaction.set(queueRef, { waitingUserId: null, waitingUserName: null, waitingUserLanguage: null });

                // Create chat doc
                transaction.set(doc(db, CHAT_COLLECTION, newChatId), {
                    status: 'active',
                    users: [userId, waitingId],
                    messages: [],
                    typingStatus: {},
                    createdAt: serverTimestamp(),
                    lastActivity: serverTimestamp()
                });

                // Notify self
                transaction.set(doc(db, CHAT_COLLECTION, userId), {
                    matched: true,
                    chatId: newChatId,
                    partnerId: waitingId,
                    partnerName: waitingName,
                    partnerLanguage: waitingLang,
                    userName, userLanguage: lang, isOnline: true,
                    lastSeen: serverTimestamp(), heartbeat: serverTimestamp()
                });

                // Notify waiting user
                transaction.set(doc(db, CHAT_COLLECTION, waitingId), {
                    matched: true,
                    chatId: newChatId,
                    partnerId: userId,
                    partnerName: userName,
                    partnerLanguage: lang,
                    isOnline: true,
                    lastSeen: serverTimestamp(), heartbeat: serverTimestamp()
                });

                clearInterval(matchingTimeout);

                chatId = newChatId;
                partnerId = waitingId;
                partnerLanguage = waitingLang;

                document.getElementById('partner-name').textContent = waitingName;
                generateAvatar(waitingName, waitingId);

                setTimeout(() => {
                    shakeScreen();
                    launchConfetti();
                    showToast(T[lang].matchFound, 'success');
                    showScreen('chat-screen');
                    setupChatListener();
                    startHeartbeat();
                    startPartnerCheck();
                    deleteDoc(doc(db, CHAT_COLLECTION, userId)).catch(()=>{});
                }, 300);

            } else {
                // Add to queue
                transaction.set(queueRef, {
                    waitingUserId: userId,
                    waitingUserName: userName,
                    waitingUserLanguage: lang,
                    timestamp: serverTimestamp()
                });

                transaction.set(doc(db, CHAT_COLLECTION, userId), {
                    status: 'waiting',
                    userName, userLanguage: lang,
                    isOnline: true, lastSeen: serverTimestamp(), heartbeat: serverTimestamp()
                });

                startHeartbeat();
                setupMatchingListener();
            }
        });
    } catch(e) {
        console.error('Matching error:', e);
        showToast(T[lang].msgError, 'error');
    }
}

function setupMatchingListener() {
    const userRef = doc(db, CHAT_COLLECTION, userId);
    if (unsubscribeChat) unsubscribeChat();

    unsubscribeChat = onSnapshot(userRef, (snap) => {
        if (snap.exists() && snap.data().matched) {
            const data = snap.data();
            chatId = data.chatId;
            partnerId = data.partnerId;
            partnerLanguage = data.partnerLanguage || 'az';

            document.getElementById('partner-name').textContent = data.partnerName;
            generateAvatar(data.partnerName, partnerId);

            if (unsubscribeChat) unsubscribeChat();
            if (matchingTimeout) clearInterval(matchingTimeout);

            setTimeout(() => {
                shakeScreen();
                launchConfetti();
                showToast(T[lang].matchFound, 'success');
                showScreen('chat-screen');
                setupChatListener();
                startPartnerCheck();
                deleteDoc(userRef).catch(()=>{});
            }, 400);
        }
    });
}

function setupChatListener() {
    if (!chatId) return;
    const chatRef = doc(db, CHAT_COLLECTION, chatId);
    const container = document.getElementById('chat-messages');
    const statusEl = document.getElementById('partner-status');

    if (unsubscribeChat) unsubscribeChat();
    container.innerHTML = '';
    renderedMessageIds.clear();
    isFirstSnapshot = true;

    unsubscribeChat = onSnapshot(chatRef, (snap) => {
        if (!snap.exists()) {
            if (isFirstSnapshot) { isFirstSnapshot = false; return; }
            if (unsubscribeChat) unsubscribeChat();
            addSystemMessage(T[lang].partnerLeft);
            setTimeout(() => openFeedback(), 1800);
            return;
        }

        isFirstSnapshot = false;
        const data = snap.data();

        if (data.status === 'active') {
            // Typing indicator
            const isTyping = data.typingStatus?.[partnerId];
            if (isTyping) {
                statusEl.innerHTML = `
                    <span style="color:var(--warning)">‚úçÔ∏è</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>${T[lang].typingText}</span>`;
            } else {
                statusEl.innerHTML = `<span style="color:var(--success)">‚óè</span><span id="t-activeText">${T[lang].activeText}</span>`;
            }

            // Render messages
            const messages = data.messages || [];
            messages.forEach((msg, idx) => {
                const id = `${msg.senderId}-${msg.timestamp}-${idx}`;
                if (renderedMessageIds.has(id)) return;
                addMessage({
                    id,
                    senderName: msg.senderName,
                    text: msg.text || '',
                    isSelf: msg.senderId === userId,
                    timestamp: msg.timestamp,
                    type: msg.type || 'text',
                    imageData: msg.imageData,
                    voiceDuration: msg.voiceDuration
                });
                // Mark read
                if (msg.senderId !== userId) {
                    markMessageRead(id);
                }
            });

            // Reactions sync
            if (data.reactions) {
                Object.entries(data.reactions).forEach(([msgRef, emojis]) => {
                    if (emojis) {
                        Object.entries(emojis).forEach(([emoji, count]) => {
                            // Update reaction display
                        });
                    }
                });
            }
        } else if (data.status === 'closed') {
            if (data.closedBy !== userId) {
                if (unsubscribeChat) unsubscribeChat();
                addSystemMessage(T[lang].partnerLeft);
                setTimeout(() => openFeedback(), 1800);
            }
        }
    }, (err) => console.error('Chat listener error:', err));
}

/* Mark message as read ‚Äî show blue ticks */
function markMessageRead(msgId) {
    const el = document.getElementById(`ticks-${msgId}`);
    if (el) { el.classList.add('read'); el.textContent = '‚úì‚úì'; }
}

/* ---- Send Reaction to Firebase ---- */
async function sendReactionToFirebase(msgRef, emoji) {
    if (!chatId || !userId) return;
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            [`reactions.${msgRef}.${emoji}`]: arrayUnion(userId),
            lastActivity: serverTimestamp()
        });
    } catch(e) {}
}

/* ---- Send Message ---- */
window.sendMessage = async function() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text || !chatId || !userId) return;

    input.value = '';
    input.style.height = 'auto';

    const msgData = {
        senderId: userId,
        senderName: userName,
        text,
        type: 'text',
        timestamp: new Date().toISOString()
    };

    // Optimistic UI
    addMessage({
        id: `opt-${Date.now()}`,
        senderName: userName,
        text,
        isSelf: true,
        timestamp: msgData.timestamp
    });

    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            [`typingStatus.${userId}`]: false,
            messages: arrayUnion(msgData),
            lastActivity: serverTimestamp()
        });
    } catch(e) {
        console.error('Send error:', e);
        showToast(T[lang].msgError, 'error');
        input.value = text;
    }
};

/* ---- Send Image ---- */
window.sendImageMessage = async function(base64) {
    if (!chatId || !userId) return;
    showToast(lang === 'az' ? '≈û…ôkil g√∂nd…ôrilir...' : 'Fotoƒüraf g√∂nderiliyor...', 'info', 2000);
    const msgData = {
        senderId: userId, senderName: userName,
        type: 'image', imageData: base64,
        timestamp: new Date().toISOString(), text: ''
    };
    addMessage({ id: `img-${Date.now()}`, senderName: userName, isSelf: true, timestamp: msgData.timestamp, type: 'image', imageData: base64 });
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            messages: arrayUnion(msgData),
            lastActivity: serverTimestamp()
        });
    } catch(e) {
        showToast(T[lang].msgError, 'error');
    }
};

/* ---- Send Voice ---- */
window.sendVoiceMessage = async function(duration) {
    if (!chatId || !userId) return;
    const msgData = {
        senderId: userId, senderName: userName,
        type: 'voice', voiceDuration: duration,
        timestamp: new Date().toISOString(), text: ''
    };
    addMessage({ id: `voice-${Date.now()}`, senderName: userName, isSelf: true, timestamp: msgData.timestamp, type: 'voice', voiceDuration: duration });
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            messages: arrayUnion(msgData),
            lastActivity: serverTimestamp()
        });
    } catch(e) {}
};

/* ---- Typing ---- */
window.handleTyping = async function() {
    if (!chatId || !userId) return;
    const text = document.getElementById('message-input').value.trim();
    if (typingTimeout) clearTimeout(typingTimeout);
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
            [`typingStatus.${userId}`]: text.length > 0,
            lastActivity: serverTimestamp()
        });
    } catch(e) {}
    typingTimeout = setTimeout(async () => {
        try {
            await updateDoc(doc(db, CHAT_COLLECTION, chatId), {
                [`typingStatus.${userId}`]: false
            });
        } catch(e) {}
    }, 2000);
};

/* ---- Feedback ---- */
function openFeedback() {
    stopHeartbeat();
    document.getElementById('feedback-modal').classList.add('open');
    chatId = null; partnerId = null; partnerLanguage = null;
    renderedMessageIds.clear();
}

/* ---- Handle Close Chat ---- */
window.handleCloseChat = async function() {
    if (!chatId) { await disconnect(true); return; }
    const cId = chatId;
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, cId), { status: 'closed', closedBy: userId });
    } catch(e) {}
    await disconnect(false);
    setTimeout(() => {
        try { deleteDoc(doc(db, CHAT_COLLECTION, cId)); } catch(e) {}
    }, 500);
    openFeedback();
};

/* ---- Handle Change Chat ---- */
window.handleChangeChat = async function() {
    if (!chatId) return;
    const cId = chatId;
    showToast(lang === 'az' ? 'Yeni s√∂hb…ôt axtarƒ±lƒ±r...' : 'Yeni sohbet aranƒ±yor...', 'info');
    try {
        await updateDoc(doc(db, CHAT_COLLECTION, cId), { status: 'closed', closedBy: userId });
    } catch(e) {}
    await disconnect(false);
    setTimeout(() => { try { deleteDoc(doc(db, CHAT_COLLECTION, cId)); } catch(e) {} }, 300);
    document.getElementById('chat-messages').innerHTML = '';
    renderedMessageIds.clear();
    showScreen('matching-screen');
    await handleStart();
};

/* ---- Handle Cancel Matching ---- */
window.handleCancelMatching = async function() {
    if (matchingTimeout) clearInterval(matchingTimeout);
    await disconnect(false);
    showScreen('start-screen');
};

/* ---- Disconnect ---- */
async function disconnect(clearUI = true) {
    stopHeartbeat();
    if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
    if (matchingTimeout) { clearInterval(matchingTimeout); matchingTimeout = null; }
    if (typingTimeout) { clearTimeout(typingTimeout); typingTimeout = null; }

    try {
        const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC);
        await runTransaction(db, async (tx) => {
            const qDoc = await tx.get(queueRef);
            if (qDoc.exists() && qDoc.data().waitingUserId === userId) {
                tx.set(queueRef, { waitingUserId: null, waitingUserName: null, waitingUserLanguage: null });
            }
        });
    } catch(e) {}

    try { await deleteDoc(doc(db, CHAT_COLLECTION, userId)); } catch(e) {}

    chatId = null; partnerId = null; partnerLanguage = null;
    if (clearUI) {
        document.getElementById('chat-messages').innerHTML = '';
        renderedMessageIds.clear();
    }
}

/* ---- Cleanup on unload ---- */
window.addEventListener('beforeunload', async () => {
    stopHeartbeat();
    try {
        if (chatId) await updateDoc(doc(db, CHAT_COLLECTION, chatId), { status: 'closed', closedBy: userId });
        await deleteDoc(doc(db, CHAT_COLLECTION, userId));
        const queueRef = doc(db, CHAT_COLLECTION, MATCH_QUEUE_DOC);
        await runTransaction(db, async (tx) => {
            const qDoc = await tx.get(queueRef);
            if (qDoc.exists() && qDoc.data().waitingUserId === userId) {
                tx.set(queueRef, { waitingUserId: null, waitingUserName: null, waitingUserLanguage: null });
            }
        });
    } catch(e) {}
});

/* ---- Tab visibility ---- */
document.addEventListener('visibilitychange', () => {
    if (document.hidden) { stopHeartbeat(); }
    else if (userId && chatId) { startHeartbeat(); startPartnerCheck(); }
});

/* ---- Close reaction pickers on outside click ---- */
document.addEventListener('click', () => {
    document.querySelectorAll('.reaction-picker.visible').forEach(p => p.classList.remove('visible'));
});

/* ---- Scroll tracking ---- */
msgsContainer().addEventListener('scroll', () => {
    const c = document.getElementById('chat-messages');
    shouldAutoScroll = c.scrollHeight - c.scrollTop - c.clientHeight < 150;
});

/* ---- BOOT ---- */
applyTranslations();
initFirebase();

</script>
</body>
</html>
